---
title: "Controlled variables"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
bibliography: Survival.bib
---

## Introduction

```{R}
#| message: false
source("Survival/utils.R")

# Setup analysis environment
analysis_setup <- setup_analysis()
paths <- analysis_setup$paths
demo <- analysis_setup$demo

flare.df <- readRDS(paste0(paths$outdir, "flares-overview.RDS"))
flare.cd.df <- subset(flare.df, diagnosis2 == "CD")
flare.uc.df <- subset(flare.df, diagnosis2 == "UC/IBDU")
```

The variables being controlled for in later cox models analyses are first
investigated.

Although smoking status was originally planned to be controlled for, the
[high degree of missingness](../Baseline/IBD.qmd#smoking) for these data and
the [lack of significant associations with time to flare](#smoking-status) has
resulted in smoking status not being controlled for in later analyses. 

Of the variables considered here, only sex is associated with disease flare. 

## Sex

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(softflare_time, softflare) ~ Sex,
  legend_title = "Sex",
  legend_labs = c("Male", "Female"),
  palette = c("#00A6ED", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/cd/soft-flare/controlled/sex"
)
```

#### Hard flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(hardflare_time, hardflare) ~ Sex,
  legend_title = "Sex",
  legend_labs = c("Male", "Female"),
  palette = c("#00A6ED", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/cd/hard-flare/controlled/sex"
)
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(softflare_time, softflare) ~ Sex,
  legend_title = "Sex",
  legend_labs = c("Male", "Female"),
  palette = c("#00A6ED", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/uc/soft-flare/controlled/sex"
)
```

#### Hard flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(hardflare_time, hardflare) ~ Sex,
  legend_title = "Sex",
  legend_labs = c("Male", "Female"),
  palette = c("#00A6ED", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/uc/hard-flare/controlled/sex"
)
```

:::

## Smoking status

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(softflare_time, softflare) ~ Smoke,
  legend_title = "Smoking status",
  legend_labs = c("Current", "Previous", "Never"),
  palette = c("#00A6ED", "#FFB400", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/cd/soft-flare/controlled/smoke"
)
```

#### Hard flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(hardflare_time, hardflare) ~ Smoke,
  legend_title = "Smoking status",
  legend_labs = c("Current", "Previous", "Never"),
  palette = c("#00A6ED", "#FFB400", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/cd/hard-flare/controlled/smoke"
)
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(softflare_time, softflare) ~ Smoke,
  legend_title = "Smoking status",
  legend_labs = c("Current", "Previous", "Never"),
  palette = c("#00A6ED", "#FFB400", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/uc/soft-flare/controlled/smoke"
)

#### Hard flare

```{R}
#| fig-height: 6
generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(hardflare_time, hardflare) ~ Smoke,
  legend_title = "Smoking status",
  legend_labs = c("Current", "Previous", "Never"),
  palette = c("#00A6ED", "#FFB400", "#F6511D"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/uc/hard-flare/controlled/smoke"
)
```

:::

## Social deprivation


### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 7
generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(softflare_time, softflare) ~ IMD,
  legend_title = "IMD",
  legend_labs = c("1 (least deprived)", "2", "3", "4", "5 (most deprived)"),
  palette = c("#F05D5E", "#00C2D1", "#FFBA49", "#EDC9FF", "#034C3C"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/cd/soft-flare/controlled/imd"
)
```

#### Hard flare

```{R}
#| fig-height: 7
generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(hardflare_time, hardflare) ~ IMD,
  legend_title = "IMD",
  legend_labs = c("1 (least deprived)", "2", "3", "4", "5 (most deprived)"),
  palette = c("#F05D5E", "#00C2D1", "#FFBA49", "#EDC9FF", "#034C3C"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/cd/hard-flare/controlled/imd"
)

```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 7
generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(softflare_time, softflare) ~ IMD,
  legend_title = "IMD",
  legend_labs = c("1 (least deprived)", "2", "3", "4", "5 (most deprived)"),
  palette = c("#F05D5E", "#00C2D1", "#FFBA49", "#EDC9FF", "#034C3C"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/uc/soft-flare/controlled/imd"
)
```

#### Hard flare

```{R}
#| fig-height: 7
generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(hardflare_time, hardflare) ~ IMD,
  legend_title = "IMD",
  legend_labs = c("1 (least deprived)", "2", "3", "4", "5 (most deprived)"),
  palette = c("#F05D5E", "#00C2D1", "#FFBA49", "#EDC9FF", "#034C3C"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/uc/hard-flare/controlled/imd"
)
```

:::

## Faecal calprotectin

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 6
p <- generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(softflare_time, softflare) ~ cat,
  legend_title = "Faecal calprotectin",
  legend_labs = c("FC < 50", "50 ≤ FC ≤ 250", "FC > 250"),
  palette = c("#2AAACE", "#FFBF1C", "#FF6726"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/cd/soft-flare/controlled/fc"
)

saveRDS(p, paste0(paths$outdir, "fc-cd-soft.RDS"))

print(p, newpage = FALSE)
```

#### Hard flare

```{R}
#| fig-height: 6
p <- generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(hardflare_time, hardflare) ~ cat,
  legend_title = "Faecal calprotectin",
  legend_labs = c("FC < 50", "50 ≤ FC ≤ 250", "FC > 250"),
  palette = c("#2AAACE", "#FFBF1C", "#FF6726"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/cd/hard-flare/controlled/fc"
)

saveRDS(p, paste0(paths$outdir, "fc-cd-hard.RDS"))

print(p, newpage = FALSE)
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| fig-height: 6
p <- generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(softflare_time, softflare) ~ cat,
  legend_title = "Faecal calprotectin",
  legend_labs = c("FC < 50", "50 ≤ FC ≤ 250", "FC > 250"),
  palette = c("#2AAACE", "#FFBF1C", "#FF6726"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/uc/soft-flare/controlled/fc"
)

saveRDS(p, paste0(paths$outdir, "fc-uc-soft.RDS"))

print(p, newpage = FALSE)
```

#### Hard flare

```{R}
#| fig-height: 6
p <- generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(hardflare_time, hardflare) ~ cat,
  legend_title = "Faecal calprotectin",
  legend_labs = c("FC < 50", "50 ≤ FC ≤ 250", "FC > 250"),
  palette = c("#2AAACE", "#FFBF1C", "#FF6726"),
  xlab = "Time from study recruitment (days)",
  title = "Time to hard flare",
  break_time_by = 500,
  plot_path = "plots/uc/hard-flare/controlled/fc"
)

saveRDS(p, paste0(paths$outdir, "fc-uc-hard.RDS"))

print(p, newpage = FALSE)
```

:::

## Cox models

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare 

```{R}
#| output: "asis"



fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + Smoke + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df,
  model = TRUE
)

cd.clin.forest <- get_HR(
  fit.me,
  c("SmokePrevious", "SmokeNever")
)



fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df,
  model = TRUE
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  get_HR(
    fit.me,
    c(
      "SexFemale",
      paste0("IMD", seq(2, 5)),
      "catFC 50-250",
      "catFC > 250"
    )
  )
)



invisible(cox_summary(fit.me))
```

#### Hard flare

```{R}
#| output: "asis"


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + Smoke + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- get_HR(
  fit.me,
  c("SmokePrevious", "SmokeNever")
)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  get_HR(
    fit.me,
    c(
      "SexFemale",
      paste0("IMD", seq(2, 5)),
      "catFC > 250"
    )
  )
)

invisible(cox_summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare 

```{R}
#| output: "asis"

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + Smoke + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- get_HR(
  fit.me,
  c("SmokePrevious", "SmokeNever")
)


fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(
  uc.clin.forest,
  get_HR(
    fit.me,
    c(
      "SexFemale",
      paste0("IMD", seq(2, 5)),
      "catFC > 250"
    )
  )
)

invisible(cox_summary(fit.me))
```

#### Hard flare

```{R}
#| output: "asis"


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + Smoke + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- get_HR(
  fit.me,
  c("SmokePrevious", "SmokeNever")
)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(
  uc.hard.forest,
  get_HR(
    fit.me,
    c(
      "SexFemale",
      paste0("IMD", seq(2, 5)),
      "catFC 50-250",
      "catFC > 250"
    )
  )
)

invisible(cox_summary(fit.me))
```

:::

### Across IBD

::: {.panel-tabset group="followup"}

#### Patient-reported flare 

```{R}
#| output: "asis"

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

invisible(cox_summary(fit.me))
```

#### Hard flare

```{R}
#| output: "asis"


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

invisible(cox_summary(fit.me))
```

:::

```{R}
saveRDS(flare.df, paste0(paths$outdir, "flares-contolled.RDS"))
saveRDS(flare.cd.df, paste0(paths$outdir, "flares-controlled-cd.RDS"))
saveRDS(flare.uc.df, paste0(paths$outdir, "flares-controlled-uc.RDS"))

saveRDS(cd.clin.forest, paste0(paths$outdir, "cd-clin-controlled.RDS"))
saveRDS(cd.hard.forest, paste0(paths$outdir, "cd-hard-controlled.RDS"))
saveRDS(uc.clin.forest, paste0(paths$outdir, "uc-clin-controlled.RDS"))
saveRDS(uc.hard.forest, paste0(paths$outdir, "uc-hard-controlled.RDS"))
```

## Reproduction and reproducibility {.appendix}

<details class = "appendix">
  <summary> Session info </summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.

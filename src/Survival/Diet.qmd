---
title: "Diet"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: IGC
  - name: "VÃ­ctor Velasco-Pardo"
    url: https://scholar.google.com/citations?user=cR3nbyAAAAAJ&hl=en&oi=ao
    affiliations:
      - ref: IGC
  - name: "Alexander Rudge"
    affiliations:
      - ref: IGC
  - name: "Beatriz Gros"
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: Spain
      - ref: IBD
  - name: "Maiara Brusco De Freitas"
    url: "https://scholar.google.com/citations?user=RfXbXL8AAAAJ&hl=en&oi=ao"
    affiliations:
      - ref: PREDICT
bibliography: Survival.bib
---

## Introduction


```{R}
#| message: false
source("Survival/utils.R")

# Setup analysis environment
analysis_setup <- setup_analysis()
paths <- analysis_setup$paths
demo <- analysis_setup$demo

flare.df <- readRDS(paste0(paths$outdir, "flares-biochem.RDS"))
flare.cd.df <- readRDS(paste0(paths$outdir, "flares-biochem-cd.RDS"))
flare.uc.df <- readRDS(paste0(paths$outdir, "flares-biochem-uc.RDS"))
```

Sensitivity analyses are available which
[control for smoking status](Smoking/Diet.qmd) by imputing missing
smoking data and
[control for FC as a continuous variable](FC\ continuous/Diet.qmd) via
splines. 

## Total meat protein

Protein intake from animal sources is not found to be significantly associated with flares in CD. However, there is evidence of an association for UC. At present, it is difficult to explore this in more detail (e.g. by meat type).

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize meat protein by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "Meat_sum", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Meat_sum",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Meat protein quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/meat",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + Meat_sum_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  

# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/meat.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/meat"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Meat_sum",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Meat protein quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/meat",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + Meat_sum_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
   )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/meat.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/meat"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize meat protein by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "Meat_sum", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Meat_sum",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Meat protein quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/meat",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + Meat_sum_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
   )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/meat.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/meat"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Meat_sum",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Meat protein quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/meat",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + Meat_sum_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/meat.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/meat"))
```

```{R}
newdata <- flare.uc.df %>%
  mutate(Meat_sum_cat = "[0,24.9)",
         hardflare_time = 365.25,
         hardflare = 1)
predict(fit.me, newdata = newdata, type = "expected", se.fit = TRUE)$fit %>%
  mean(na.rm = TRUE)

newdata <- flare.uc.df %>%
  mutate(cat = "FC < 50",
         hardflare_time = 730,
         hardflare = 1)
predict(fit.me, newdata = newdata, type = "expected", se.fit = TRUE)$fit %>%
  mean(na.rm = TRUE)



newdata <- flare.uc.df %>%
  mutate(Meat_sum_cat = "[50.6,331]",
         hardflare_time = 365.25,
         hardflare = 1)
predict(fit.me, newdata = newdata, type = "expected", se.fit = TRUE)$fit %>%
  mean(na.rm = TRUE)

newdata <- flare.uc.df %>%
  mutate(Meat_sum_cat = "[50.6,331]",
         hardflare_time = 730,
         hardflare = 1)
predict(fit.me, newdata = newdata, type = "expected", se.fit = TRUE)$fit %>%
  mean(na.rm = TRUE)
```

:::
 
### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize meat protein by quantiles
flare.df <- categorize_by_quantiles(flare.df, "Meat_sum", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "Meat_sum",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Meat protein quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/meat",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + Meat_sum_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/meat.png")
invisible(
  cox_summary(
    fit.me,
    plot_base_path = "plots/ibd/soft-flare/diet/meat"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "Meat_sum",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Meat protein quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/meat",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + Meat_sum_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/meat.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/meat"))
```
:::

## Overall meat intake

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize overall meat intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "meat_overall", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "meat_overall",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Meat intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/meat_overall",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-overall-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + meat_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/meat_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/meat_overall"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "meat_overall",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Meat intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/meat_overall",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-overall-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + meat_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/meat_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/meat_overall"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize overall meat intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "meat_overall", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "meat_overall",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Meat intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/meat_overall",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-overall-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + meat_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/meat_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/meat_overall"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "meat_overall",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Meat intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/meat_overall",
  break_time_by = 500
) 

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "meat-overall-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + meat_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/meat_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/meat_overall"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize overall meat intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "meat_overall", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "meat_overall",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Meat intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/meat_overall",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + meat_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/meat_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/meat_overall"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "meat_overall",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Meat intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/meat_overall",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + meat_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/meat_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/meat_overall"))
```
:::

## Overall fish intake

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize overall fish intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "fish_overall", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "fish_overall",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fish intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/fish_overall",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fish-overall-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + fish_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/fish_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/fish_overall"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "fish_overall",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fish intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/fish_overall",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fish-overall-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fish_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/fish_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/fish_overall"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize overall fish intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "fish_overall", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "fish_overall",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fish intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/fish_overall",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fish-overall-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fish_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/fish_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/fish_overall"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "fish_overall",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fish intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/fish_overall",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fish-overall-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fish_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/fish_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/fish_overall"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize overall fish intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "fish_overall", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "fish_overall",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fish intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/fish_overall",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fish_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/fish_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/fish_overall"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "fish_overall",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fish intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/fish_overall",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fish_overall_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/fish_overall.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/fish_overall"))
```
:::

## Dietary fibre

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6


# Categorize dietary fibre by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "fibre", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "fibre",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fibre quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/fibre",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fibre-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fibre_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/fibre.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/fibre"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "fibre",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fibre quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/fibre",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fibre-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fibre_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/fibre.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/fibre"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize fibre by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "fibre", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "fibre",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fibre quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/fibre",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fibre-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fibre_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/fibre.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/fibre"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "fibre",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fibre quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/fibre",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fibre-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fibre_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/fibre.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/fibre"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize dietary fibre by quantiles
flare.df <- categorize_by_quantiles(flare.df, "fibre", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "fibre",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fibre quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/fibre",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fibre_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/fibre.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/fibre"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "fibre",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fibre quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/fibre",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fibre_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/fibre.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/fibre"))
```
:::

## Polyunsaturated fatty acids

The SAP states n-6 PUFAs will be investigated. However, the FFQ data extract lists PUFA collectively, presumably describing both n-3 and n-6 PUFAs. For now, these data will be used.

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize PUFA by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "PUFA_percEng", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "PUFA_percEng",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "PUFA intake (by g) quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/pufa",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "pufa-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + PUFA_percEng_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/pufa.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/pufa"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "PUFA_percEng",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "PUFA intake (by g) quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/pufa",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "pufa-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + PUFA_percEng_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/pufa.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/pufa"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize PUFA by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "PUFA_percEng", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "PUFA_percEng",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "PUFA intake (by g) quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/pufa",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "pufa-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/pufa.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/pufa"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "PUFA_percEng",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "PUFA intake (by g) quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/pufa",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "pufa-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + PUFA_percEng_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/pufa.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/pufa"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize PUFA by quantiles
flare.df <- categorize_by_quantiles(flare.df, "PUFA_percEng", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "PUFA_percEng",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "PUFA intake (by g) quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/pufa",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + PUFA_percEng_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/pufa.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/pufa"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "PUFA_percEng",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "PUFA intake (by g) quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/pufa",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + PUFA_percEng_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/pufa.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/pufa"))
```
:::

## Alcohol

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6


levels(flare.cd.df$weekly_units_cat) <- c("Less than 0.1 units", "0.1-14 units", "More than 14 units")

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "weekly_units",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Alcohol units per week",
  plot_base_path = "plots/cd/soft-flare/diet/alcohol",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "alcohol-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + weekly_units_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/alcohol.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/alcohol"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "weekly_units",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Alcohol units per week",
  plot_base_path = "plots/cd/hard-flare/diet/alcohol",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "alcohol-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + weekly_units_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/alcohol.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/alcohol"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "weekly_units",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Alcohol units per week",
  plot_base_path = "plots/uc/soft-flare/diet/alcohol",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "alcohol-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + weekly_units_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/alcohol.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/alcohol"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "weekly_units",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Alcohol units per week",
  plot_base_path = "plots/uc/hard-flare/diet/alcohol",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "alcohol-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + weekly_units_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/alcohol.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/alcohol"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "weekly_units",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Alcohol units per week",
  plot_base_path = "plots/ibd/soft-flare/diet/alcohol",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + weekly_units_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/alcohol.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/alcohol"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "weekly_units",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Alcohol units per week",
  plot_base_path = "plots/ibd/hard-flare/diet/alcohol",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + weekly_units_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/alcohol.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/alcohol"))
```
:::

## NOVA score

The SAP states emulsifiers (specifically lecithin) will be investigated. However, data on emulsifiers are not available in the FFQ data extract. As a proxy for emulsifiers, this report will look at ultra-processed foods via Nova scores [@Monteiro_2017].

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "NOVAScore",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Nova score",
  plot_base_path = "plots/cd/soft-flare/diet/nova",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "nova-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + NOVAScore_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/nova.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/nova"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "NOVAScore",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Nova Score",
  plot_base_path = "plots/cd/hard-flare/diet/nova",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "nova-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + NOVAScore_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/nova.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/nova"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "NOVAScore",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Nova score",
  plot_base_path = "plots/uc/soft-flare/diet/nova",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "nova-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + NOVAScore_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/nova.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/nova"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "NOVAScore",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Nova score",
  plot_base_path = "plots/uc/hard-flare/diet/nova",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "nova-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + NOVAScore_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/nova.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/nova"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "NOVAScore",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Nova score",
  plot_base_path = "plots/ibd/soft-flare/diet/nova",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + NOVAScore_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/nova.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/nova"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "NOVAScore",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Nova score",
  plot_base_path = "plots/ibd/hard-flare/diet/nova",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + NOVAScore_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/nova.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/nova"))
```
:::

## UPF intake

As an alternative approach to characterising ultra-processed food, we considered the percentage of daily energy intake sourced from ultra-processed food and drink (Nova 4).

### Crohn's disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize UPF percentage by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "UPF_perc", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "UPF_perc",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "UPF as % of energy",
  plot_base_path = "plots/cd/soft-flare/diet/UPF",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "upf-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + UPF_perc_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/UPF.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/UPF"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "UPF_perc",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "UPF as % of energy",
  plot_base_path = "plots/cd/hard-flare/diet/UPF",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "upf-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + UPF_perc_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/UPF.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/UPF"))
```
:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize UPF percentage by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "UPF_perc", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "UPF_perc",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "UPF as % of energy",
  plot_base_path = "plots/uc/soft-flare/diet/UPF",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "upf-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/UPF.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/UPF"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "UPF_perc",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "UPF as % of energy",
  plot_base_path = "plots/uc/hard-flare/diet/UPF",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "upf-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + UPF_perc_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/UPF.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/UPF"))
```
:::

### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize UPF percentage by quantiles
flare.df <- categorize_by_quantiles(flare.df, "UPF_perc", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "UPF_perc",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "UPF as % of energy",
  plot_base_path = "plots/ibd/soft-flare/diet/UPF",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + UPF_perc_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/UPF.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/UPF"))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "UPF_perc",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "UPF as % of energy",
  plot_base_path = "plots/ibd/hard-flare/diet/UPF",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + UPF_perc_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/UPF.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/UPF"))
```
:::

## Processed food subgroups

### Breads and cereals

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize bread intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "breadIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "breadIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Bread/cereal intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/breadIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "breadIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + breadIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/breadIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/breadIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "breadIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Bread/cereal intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/breadIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "breadIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + breadIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/breadIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/breadIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize bread intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "breadIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "breadIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Bread/cereal intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/breadIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "breadIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/breadIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/breadIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "breadIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Bread/cereal intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/breadIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "breadIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + breadIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/breadIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/breadIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize bread intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "breadIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "breadIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Bread/cereal intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/breadIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + breadIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/breadIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/breadIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "breadIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Bread/cereal intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/breadIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + breadIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/breadIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/breadIntake"))
```
:::

### Sweets and desserts/snack foods

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize sweet intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "sweetIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "sweetIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Sweet/dessert/snack intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/sweetIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "sweetIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + sweetIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/sweetIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/sweetIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "sweetIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Sweet/dessert/snack intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/sweetIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "sweetIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + sweetIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/sweetIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/sweetIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize sweet intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "sweetIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "sweetIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Sweet/dessert/snack intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/sweetIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "sweetIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/sweetIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/sweetIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "sweetIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Sweet/dessert/snack intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/sweetIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "sweetIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + sweetIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/sweetIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/sweetIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize sweet intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "sweetIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "sweetIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Sweet/dessert/snack intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/sweetIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + sweetIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/sweetIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/sweetIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "sweetIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Sweet/dessert/snack intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/sweetIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + sweetIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/sweetIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/sweetIntake"))
```
:::

### Artificially and sugar-sweetened beverages

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize drink intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "drinkIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "drinkIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Artificially and sugar-sweetened drink intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/drinkIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "drinkIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + drinkIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/drinkIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/drinkIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "drinkIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Artificially and sugar-sweetened drink intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/drinkIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "drinkIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + drinkIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/drinkIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/drinkIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize drink intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "drinkIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "drinkIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Artificially and sugar-sweetened drink intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/drinkIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "drinkIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/drinkIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/drinkIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "drinkIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Artificially and sugar-sweetened drink intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/drinkIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "drinkIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + drinkIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/drinkIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/drinkIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize drink intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "drinkIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "drinkIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Artificially and sugar-sweetened drink intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/drinkIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + drinkIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/drinkIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/drinkIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "drinkIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Artificially and sugar-sweetened drink intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/drinkIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + drinkIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/drinkIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/drinkIntake"))
```
:::

### Animal-based products (processed meat)

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize processed meat intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "processedMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "processedMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Processed meat intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/processedMeatIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedMeatIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/processedMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/processedMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "processedMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Processed meat intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/processedMeatIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedMeatIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/processedMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/processedMeatIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize processed meat intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "processedMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "processedMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Processed meat intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/processedMeatIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedMeatIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/processedMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/processedMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "processedMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Processed meat intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/processedMeatIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedMeatIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/processedMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/processedMeatIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize processed meat intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "processedMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "processedMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Processed meat intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/processedMeatIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/processedMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/processedMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "processedMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Processed meat intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/processedMeatIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/processedMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/processedMeatIntake"))
```
:::

### Plant-based alternatives

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize processed plant intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "processedPlantIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "processedPlantIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Processed plant-based alternative intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/processedPlantIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedPlantIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedPlantIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/processedPlantIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/processedPlantIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "processedPlantIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Processed plant-based alternative intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/processedPlantIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedPlantIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedPlantIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/processedPlantIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/processedPlantIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize processed plant intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "processedPlantIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "processedPlantIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Processed plant-based alternative intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/processedPlantIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedPlantIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/processedPlantIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/processedPlantIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "processedPlantIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Processed plant-based alternative intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/processedPlantIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "processedPlantIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedPlantIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/processedPlantIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/processedPlantIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize processed plant intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "processedPlantIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "processedPlantIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Processed plant-based alternative intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/processedPlantIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedPlantIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/processedPlantIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/processedPlantIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "processedPlantIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Processed plant-based alternative intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/processedPlantIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + processedPlantIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/processedPlantIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/processedPlantIntake"))
```
:::

## Un-processed/minimally processed food subgroups

### Fruit

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize fruit intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "fruitIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "fruitIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fruit intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/fruitIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fruitIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fruitIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/fruitIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/fruitIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "fruitIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fruit intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/fruitIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fruitIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fruitIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/fruitIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/fruitIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize fruit intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "fruitIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "fruitIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fruit intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/fruitIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fruitIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/fruitIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/fruitIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "fruitIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fruit intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/fruitIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "fruitIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + fruitIntake_cat + dqi_tot + BMI + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/fruitIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/fruitIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize fruit intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "fruitIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "fruitIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Fruit intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/fruitIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fruitIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/fruitIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/fruitIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "fruitIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Fruit intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/fruitIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + fruitIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/fruitIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/fruitIntake"))
```
:::

### Vegetable and legumes

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize vegetable intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "vegIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "vegIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Vegetable/legume intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/vegIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "vegIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + vegIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/vegIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/vegIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "vegIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Vegetable/legume intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/vegIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "vegIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + vegIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/vegIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/vegIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize vegetable intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "vegIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "vegIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Vegetable/legume intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/vegIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "vegIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/vegIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/vegIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "vegIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Vegetable/legume intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/vegIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "vegIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + vegIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/vegIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/vegIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize vegetable intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "vegIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "vegIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Vegetable/legume intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/vegIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + vegIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/vegIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/vegIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "vegIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Vegetable/legume intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/vegIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + vegIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/vegIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/vegIntake"))
```
:::

### Red meat

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize red meat intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "redMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "redMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Red meat intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/redMeatIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "redMeatIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + redMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/redMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/redMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "redMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Red meat intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/redMeatIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "redMeatIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + redMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/redMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/redMeatIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize red meat intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "redMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "redMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Red meat intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/redMeatIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "redMeatIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/redMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/redMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "redMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Red meat intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/redMeatIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "redMeatIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + redMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/redMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/redMeatIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize red meat intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "redMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "redMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Red meat intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/redMeatIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + redMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/redMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/redMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "redMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Red meat intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/redMeatIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + redMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/redMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/redMeatIntake"))
```
:::

### White meat

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize white meat intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "whiteMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "whiteMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "White meat intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/whiteMeatIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteMeatIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + whiteMeatIntake_cat + dqi_tot + BMI + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/whiteMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/whiteMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "whiteMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "White meat intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/whiteMeatIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteMeatIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/whiteMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/whiteMeatIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize white meat intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "whiteMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "whiteMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "White meat intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/whiteMeatIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteMeatIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/whiteMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/whiteMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "whiteMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "White meat intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/whiteMeatIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteMeatIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/whiteMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/whiteMeatIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize white meat intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "whiteMeatIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "whiteMeatIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "White meat intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/whiteMeatIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/whiteMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/whiteMeatIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "whiteMeatIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "White meat intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/whiteMeatIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteMeatIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/whiteMeatIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/whiteMeatIntake"))
```
:::

### Fish (white and oily)

#### Crohn's disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize white fish intake by quantiles
flare.cd.df <- categorize_by_quantiles(flare.cd.df, "whiteFishIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "whiteFishIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "White fish intake quantiles",
  plot_base_path = "plots/cd/soft-flare/diet/whiteFishIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteFishIntake-cd-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteFishIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/soft-flare/diet/whiteFishIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/soft-flare/diet/whiteFishIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "whiteFishIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "White fish intake quantiles",
  plot_base_path = "plots/cd/hard-flare/diet/whiteFishIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteFishIntake-cd-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteFishIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "CD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/cd/hard-flare/diet/whiteFishIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/cd/hard-flare/diet/whiteFishIntake"))
```
:::

#### Ulcerative colitis

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize white fish intake by quantiles
flare.uc.df <- categorize_by_quantiles(flare.uc.df, "whiteFishIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "whiteFishIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "White fish intake quantiles",
  plot_base_path = "plots/uc/soft-flare/diet/whiteFishIntake",
  break_time_by = 200
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteFishIntake-uc-soft.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteFishIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Soft") |>
  relocate(diagnosis, flare)
  )

# Display plot and model summary
knitr::include_graphics("plots/uc/soft-flare/diet/whiteFishIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/soft-flare/diet/whiteFishIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "whiteFishIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "White fish intake quantiles",
  plot_base_path = "plots/uc/hard-flare/diet/whiteFishIntake",
  break_time_by = 500
)

# Save plot as RDS
saveRDS(analysis_result$plot, paste0(paths$outdir, "whiteFishIntake-uc-hard.RDS"))

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteFishIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "UC", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/uc/hard-flare/diet/whiteFishIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/uc/hard-flare/diet/whiteFishIntake"))
```
:::

#### Inflammatory bowel disease

::: {.panel-tabset group="followup"}
##### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize white fish intake by quantiles
flare.df <- categorize_by_quantiles(flare.df, "whiteFishIntake", reference_data = flare.df)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "whiteFishIntake",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "White fish intake quantiles",
  plot_base_path = "plots/ibd/soft-flare/diet/whiteFishIntake",
  break_time_by = 200
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteFishIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Soft") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/soft-flare/diet/whiteFishIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/soft-flare/diet/whiteFishIntake"))
```

##### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function for objective flare
analysis_result <- run_survival_analysis(
  data = flare.df,
  var_name = "whiteFishIntake",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "White fish intake quantiles",
  plot_base_path = "plots/ibd/hard-flare/diet/whiteFishIntake",
  break_time_by = 500
)

# Run Cox model with categorical variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + dqi_tot + BMI + whiteFishIntake_cat + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.df
)

hrs <- rbind(hrs, broom::tidy(fit.me) |> 
  filter(!grepl("^Sex|^cat|^IMD|^dqi_tot|^BMI|^frailty", term)) |>
  mutate(diagnosis = "IBD", flare ="Hard") |>
  relocate(diagnosis, flare)
  )


# Display plot and model summary
knitr::include_graphics("plots/ibd/hard-flare/diet/whiteFishIntake.png")
invisible(cox_summary(fit.me, plot_base_path = "plots/ibd/hard-flare/diet/whiteFishIntake"))
```
:::

## Save tables with p-values and hazard ratios
```{r}

pvalues <- hrs |>
  select(diagnosis, flare, term, p.value)

# Create term labels dynamically based on actual data
# Count entries per diagnosis-flare combination to handle actual structure
term_patterns <- list(
  "Meat_sum_cat" = "Meat protein",
  "meat_overall_cat" = "Overall meat intake",
  "fish_overall_cat" = "Overall fish intake",
  "fibre_cat" = "Dietary fibre",
  "PUFA_percEng_cat" = "PUFA",
  "NOVA_Score" = "NOVA Score",
  "UPF_perc_cat" = "%UPF",
  "breadIntake_cat" = "Bread intake",
  "sweetIntake_cat" = "Sweet intake",
  "drinkIntake_cat" = "Drink intake",
  "processedMeatIntake_cat" = "Processed meat intake",
  "processedPlantIntake_cat" = "Processed plant intake",
  "fruitIntake_cat" = "Fruit intake",
  "vegIntake_cat" = "Vegetable intake",
  "redMeatIntake_cat" = "Red meat intake",
  "whiteMeatIntake_cat" = "White meat intake",
  "whiteFishIntake_cat" = "White fish intake"
)

# Replace term names with human-readable labels
pvalues <- pvalues |>
  mutate(
    clean_term = term,
    clean_term = case_when(
      grepl("Meat_sum_cat", term) ~ paste("Meat protein", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("meat_overall_cat", term) ~ paste("Overall meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("fish_overall_cat", term) ~ paste("Overall fish intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("fibre_cat", term) ~ paste("Dietary fibre", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("PUFA_percEng_cat", term) ~ paste("PUFA", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("NOVA_Score", term) ~ paste("NOVA Score", gsub(".*?(\\d+)", "\\1", term)),
      grepl("UPF_perc_cat", term) ~ paste("%UPF", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("breadIntake_cat", term) ~ paste("Bread intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("sweetIntake_cat", term) ~ paste("Sweet intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("drinkIntake_cat", term) ~ paste("Drink intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("processedMeatIntake_cat", term) ~ paste("Processed meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("processedPlantIntake_cat", term) ~ paste("Processed plant intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("fruitIntake_cat", term) ~ paste("Fruit intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("vegIntake_cat", term) ~ paste("Vegetable intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("redMeatIntake_cat", term) ~ paste("Red meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("whiteMeatIntake_cat", term) ~ paste("White meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("whiteFishIntake_cat", term) ~ paste("White fish intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      TRUE ~ term
    )
  ) |>
  select(-term) |>
  rename(term = clean_term)

pvalues <- pvalues |>
  mutate(
    adjusted.p.value = ifelse(
      grepl(
        "^Meat|^%UP|^PUFA|^Dietary", term
      ),
      NA,
      p.value * 216
    )
  )
pvalues$adjusted.p.value <- ifelse(
  !is.na(pvalues$adjusted.p.value) & pvalues$adjusted.p.value > 1,
  1,
  pvalues$adjusted.p.value
)
```

<details class = "appendix">
  <summary> Control for additional covariates </summary>
  
<h3> Crohn's disease </h3>

<h4> Patient-reported flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Fruit intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Vegetable and legumes intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Red meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> White meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h4> Objective flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h3> Ulcerative colitis </h3>

<h4> Patient-reported flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Fruit intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Vegetable and legumes intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Red meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> White meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h4> Objective flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Fruit intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Vegetable and legumes intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Red meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> White meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

</details>


## Save tables with p-values and hazard ratios
```{r}
pvalues <- hrs |>
  select(diagnosis, flare, term, p.value)

# Replace term names with human-readable labels (dynamic approach)
pvalues <- pvalues |>
  mutate(
    clean_term = term,
    clean_term = case_when(
      grepl("Meat_sum_cat", term) ~ paste("Meat protein", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("meat_overall_cat", term) ~ paste("Overall meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("fish_overall_cat", term) ~ paste("Overall fish intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("fibre_cat", term) ~ paste("Dietary fibre", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("PUFA_percEng_cat", term) ~ paste("PUFA", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("NOVA_Score", term) ~ paste("NOVA Score", gsub(".*?(\\d+)", "\\1", term)),
      grepl("UPF_perc_cat", term) ~ paste("%UPF", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("breadIntake_cat", term) ~ paste("Bread intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("sweetIntake_cat", term) ~ paste("Sweet intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("drinkIntake_cat", term) ~ paste("Drink intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("processedMeatIntake_cat", term) ~ paste("Processed meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("processedPlantIntake_cat", term) ~ paste("Processed plant intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("fruitIntake_cat", term) ~ paste("Fruit intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("vegIntake_cat", term) ~ paste("Vegetable intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("redMeatIntake_cat", term) ~ paste("Red meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("whiteMeatIntake_cat", term) ~ paste("White meat intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      grepl("whiteFishIntake_cat", term) ~ paste("White fish intake", gsub(".*\\[(.*?)\\].*|.*\\((.*?)\\).*", "\\1\\2", term)),
      TRUE ~ term
    )
  ) |>
  select(-term) |>
  rename(term = clean_term)

pvalues <- pvalues |>
  mutate(
    adjusted.p.value = ifelse(
      grepl(
        "^Meat|^%UP|^PUFA|^Dietary", term
      ),
      NA,
      p.value * 216
    )
  )
pvalues$adjusted.p.value <- ifelse(
  !is.na(pvalues$adjusted.p.value) & pvalues$adjusted.p.value > 1,
  1,
  pvalues$adjusted.p.value
)
```

<details class = "appendix">
  <summary> Control for additional covariates </summary>
  
<h3> Crohn's disease </h3>

<h4> Patient-reported flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Fruit intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Vegetable and legumes intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Red meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> White meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h4> Objective flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h3> Ulcerative colitis </h3>

<h4> Patient-reported flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Fruit intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Vegetable and legumes intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Red meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> White meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h4> Objective flare </h4>

<h5> Total meat protein </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    Meat_sum_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    meat_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Overall fish intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fish_overall_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Dietary fibre </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fibre_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Polyunsaturated fatty acids </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    PUFA_percEng_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> NOVA score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    NOVAScore_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> UPF intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    UPF_perc_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Bread intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    breadIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Sweet intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    sweetIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Drink intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    drinkIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Processed plant intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    processedPlantIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Fruit intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    fruitIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Vegetable and legumes intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    vegIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Red meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    redMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> White meat intake </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    dqi_tot +
    BMI +
    `IBD Duration` +
    Treatment +
    Age +
    whiteMeatIntake_cat +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

</details>


## Reproduction and reproducibility {.appendix}

<details class="appendix">
<summary>Session info</summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by <a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a> unless otherwise stated.

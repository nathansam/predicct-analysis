---
title: "Inflammatory bowel disease"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
bibliography: Survival.bib   
---

## Introduction

```{R}
#| message: false
library(readxl)
library(tidyverse)
library(datefixR)
library(survival)
library(survminer)
library(pander)
library(coxme)
library(finalfit)
library(DescTools)
library(gtsummary)

# paths to PREdiCCt data
if (file.exists("/docker")) { # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed/"
} else { # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
}

demo <- readRDS(paste0(outdir, "demo-full.RDS"))
demo$FC <- log(demo$FC)

cox.summary <- function(fit) {
  cat("Cox model summary:")
  fit %>%
    finalfit::fit2df(condense = FALSE) %>%
    knitr::kable(
      col.names = c(
        "Variable",
        "HR",
        "Lower 95%",
        "Upper 95%",
        "P-value"
      ),
      digits = 4
    ) %>%
    print()

  cat("\\newline

Diagnostics: \\newline

")

  cat("\\newline

::: {.panel-tabset}

      ")

  cat("

###### Proportional hazards assumption test \\newline

  ")
  cox.zph(fit)$table %>%
    knitr::kable(
      col.names = c(
        "",
        "Chi-squared statistic",
        "DF",
        "P-value"
      ),
      digits = 4
    ) %>%
    print()

  cat("\\newline

###### DF betas \\newline

  ")

  print(ggcoxdiagnostics(fit, type = "dfbeta"))

  cat("\\newline

###### Martingale residuals \\newline

      ")

  print(ggcoxdiagnostics(fit, type = "martingale", linear.predictions = TRUE))

  cat("\\newline

:::

      ")
  return()
}

GetHR <- function(fit, var) {
  # Get point estimate with 95% CI

  HR.dat <- summary(fit)$conf.int %>%
    as.data.frame() %>%
    filter(rownames(summary(fit)$conf.int) %in% var) %>%
    select(`exp(coef)`, `lower .95`, `upper .95`)
  # Ensure variables are in the same order as var
  HR.dat <- HR.dat[var, ]
  # Add p-value
  HR.dat$p <- summary(fit)$coefficients[var, "p"]
  names(HR.dat) <- c("HR", "Lower95", "Upper95", "p")
  HR.dat
}


flare.df <- readRDS(paste0(outdir, "flares-demographics.RDS"))
flare.cd.df <- readRDS(paste0(outdir, "flares-demographics-cd.RDS"))
flare.uc.df <- readRDS(paste0(outdir, "flares-demographics-uc.RDS"))

cd.clin.forest <- readRDS(paste0(outdir, "cd-clin-demographics.RDS"))
cd.hard.forest <- readRDS(paste0(outdir, "cd-hard-demographics.RDS"))
uc.clin.forest <- readRDS(paste0(outdir, "uc-clin-demographics.RDS"))
uc.hard.forest <- readRDS(paste0(outdir, "uc-hard-demographics.RDS"))
```

## IBD Control-8

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

flare.cd.df$control_cat <-
  cut(flare.cd.df$control_8,
    c(0, 13, 16),
    labels = c("0-12", "13-16"),
    include.lowest = TRUE,
    right = FALSE
  )

fit <- survfit(Surv(softflare_time, softflare) ~ control_cat,
  data = flare.cd.df
)

p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control-8",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare",
  break.time.by = 200
)

cairo_pdf("plots/cd/soft-flare/ibd/control-8.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/control-8.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(cd.clin.forest, GetHR(fit.me, "control_8"))

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(hardflare_time, hardflare) ~ control_cat,
  data = flare.cd.df
)

p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control-8",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare",
  break.time.by = 500
)

cairo_pdf("plots/cd/hard-flare/ibd/control-8.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/control-8.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(cd.hard.forest, GetHR(fit.me, "control_8"))

invisible(cox.summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

flare.uc.df$control_cat <-
  cut(flare.uc.df$control_8,
    c(0, 13, 16),
    labels = c("0-12", "13-16"),
    include.lowest = TRUE,
    right = FALSE
  )



fit <- survfit(Surv(softflare_time, softflare) ~ control_cat,
  data = flare.uc.df
)

p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control-8",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare",
  break.time.by = 200
)


cairo_pdf("plots/uc/soft-flare/ibd/control-8.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/soft-flare/ibd/control-8.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(uc.clin.forest, GetHR(fit.me, "control_8"))

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(hardflare_time, hardflare) ~ control_cat,
  data = flare.uc.df
)

p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control-8",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare",
  break.time.by = 500
)

cairo_pdf("plots/uc/hard-flare/ibd/control-8.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/hard-flare/ibd/control-8.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(uc.hard.forest, GetHR(fit.me, "control_8"))
invisible(cox.summary(fit.me))
```

:::

## IBD Control visual analogue scale

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6


fit <- survfit(Surv(softflare_time, softflare) ~ vas_control,
  data = flare.cd.df
)

p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control VAS",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare",
  break.time.by = 200
)

cairo_pdf("plots/cd/soft-flare/ibd/control-vas.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/control-vas.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(hardflare_time, hardflare) ~ vas_control,
  data = flare.cd.df
)

p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control VAS",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare",
  break.time.by = 500
)


cairo_pdf("plots/cd/hard-flare/ibd/control-vas.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/control-vas.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
invisible(cox.summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(softflare_time, softflare) ~ vas_control,
  data = flare.uc.df
)

p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control VAS",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare",
  break.time.by = 200
)

cairo_pdf("plots/uc/soft-flare/ibd/control-vas.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/soft-flare/ibd/control-vas.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)
invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(hardflare_time, hardflare) ~ vas_control,
  data = flare.uc.df
)

p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "IBD Control VAS",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare",
  break.time.by = 200
)

cairo_pdf("plots/uc/hard-flare/ibd/control-vas.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/hard-flare/ibd/control-vas.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)
invisible(cox.summary(fit.me))
```

:::

## Biologic use

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

flare.cd.df <- flare.cd.df %>%
  mutate(Biologic = plyr::mapvalues(Biologic,
                                    from = c("Current",
                                             "Previously",
                                             "Never prescribed"),
                                    to = c("Prescribed",
                                           "Not prescribed",
                                           "Not prescribed")))


fit <- survfit(Surv(softflare_time, softflare) ~ Biologic,
  data = flare.cd.df
)

p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Biologic",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare",
  break.time.by = 200
)

cairo_pdf("plots/cd/soft-flare/ibd/biologic.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/biologic.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(hardflare_time, hardflare) ~ Biologic,
  data = flare.cd.df
)

p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Biologic",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare",
  break.time.by = 500
)

cairo_pdf("plots/cd/hard-flare/ibd/biologic.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/biologic.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox.summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

flare.uc.df <- flare.uc.df %>%
  mutate(Biologic = plyr::mapvalues(Biologic,
                                    from = c("Current",
                                             "Previously",
                                             "Never prescribed"),
                                    to = c("Prescribed",
                                           "Not prescribed",
                                           "Not prescribed")))



fit <- survfit(Surv(softflare_time, softflare) ~ Biologic,
  data = flare.uc.df
)

p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Biologic",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare",
  break.time.by = 200
)


cairo_pdf("plots/uc/soft-flare/ibd/biologic.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/soft-flare/ibd/biologic.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit <- survfit(Surv(hardflare_time, hardflare) ~ Biologic,
  data = flare.uc.df
)

p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Biologic",
  palette = c("#1A8FE3", "#E76D83"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare",
  break.time.by = 500
)

cairo_pdf("plots/uc/hard-flare/ibd/biologic.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/hard-flare/ibd/biologic.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox.summary(fit.me))
```

:::

## Variables only relevant to Crohn's disease

```{R}
demo.cd <- readRDS(paste0(outdir, "demo-cd.RDS"))
demo.cd <- demo.cd[, c(
  "ParticipantNo",
  "Surgery",
  "Location",
  "L4",
  "Behaviour",
  "Perianal",
  "HBI",
  "PRO2"
)]
flare.cd.df <- merge(flare.cd.df,
  demo.cd,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
```

### Surgery

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ Surgery, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Previous surgery",
  palette = c("#3DDC97", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)

cairo_pdf("plots/cd/soft-flare/ibd/surgery.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/surgery.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Surgery +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
cd.clin.forest <- rbind(cd.clin.forest, GetHR(fit.me, "SurgeryYes"))

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ Surgery, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Previous surgery",
  palette = c("#3DDC97", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/cd/hard-flare/ibd/surgery.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/surgery.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Surgery +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
cd.hard.forest <- rbind(cd.hard.forest, GetHR(fit.me, "SurgeryYes"))
invisible(cox.summary(fit.me))
```

:::

### Montreal location 

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ Location, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal location",
  palette = c("#3B3561", "#5BC0EB", "#FFD166", "#E4572E"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)

cairo_pdf("plots/cd/soft-flare/ibd/location.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/location.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Location +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  GetHR(fit.me, c("LocationL2", "LocationL3"))
)
invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ Location, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal location",
  palette = c("#3B3561", "#5BC0EB", "#FFD166", "#E4572E"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/cd/hard-flare/ibd/location.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/location.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Location +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  GetHR(fit.me, c("LocationL2", "LocationL3"))
)

invisible(cox.summary(fit.me))
```

:::

### Montreal L4 

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ L4, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal L4 presence",
  palette = c("#3DDC97", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)

cairo_pdf("plots/cd/soft-flare/ibd/l4.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/l4.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + L4 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
cd.clin.forest <- rbind(
  cd.clin.forest,
  GetHR(fit.me, "L4Present")
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ L4, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal L4 presence",
  palette = c("#3DDC97", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/cd/hard-flare/ibd/l4.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/l4.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + L4 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  GetHR(fit.me, "L4Present")
)

invisible(cox.summary(fit.me))
```

:::

### Montreal Behaviour

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ Behaviour, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal behaviour",
  palette = c("#3DDC97", "#FFD166", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)

cairo_pdf("plots/cd/soft-flare/ibd/behaviour.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/behaviour.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Behaviour +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  GetHR(fit.me, c("BehaviourB2", "BehaviourB3"))
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ Behaviour, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal behaviour",
  palette = c("#3DDC97", "#FFD166", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/cd/hard-flare/ibd/behaviour.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/behaviour.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)


fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Behaviour +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  GetHR(fit.me, c("BehaviourB2", "BehaviourB3"))
)

invisible(cox.summary(fit.me))
```

:::

### Perinanal disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ Perianal, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Perianal disease",
  palette = c("#3DDC97", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)

cairo_pdf("plots/cd/soft-flare/ibd/perinal.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/soft-flare/ibd/perinal.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Perianal +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  GetHR(fit.me, "PerianalYes")
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ Perianal, data = flare.cd.df)
p <- ggsurvplot(fit,
  data = flare.cd.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Perianal disease",
  palette = c("#3DDC97", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/cd/hard-flare/ibd/perinal.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/cd/hard-flare/ibd/perinal.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Perianal +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  GetHR(fit.me, "PerianalYes")
)

invisible(cox.summary(fit.me))
```

:::


## Variables only relevant to UC/IBDU

```{R}
demo.uc <- readRDS(paste0(outdir, "demo-uc.RDS"))
demo.uc <- demo.uc[, c("ParticipantNo", "Extent", "Mayo")]
flare.uc.df <- merge(flare.uc.df,
  demo.uc,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
```

### Montreal extent

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ Extent, data = flare.uc.df)
p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal extent",
  palette = c("#3DDC97", "orange", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)


cairo_pdf("plots/uc/soft-flare/ibd/extent.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/soft-flare/ibd/extent.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(
  uc.clin.forest,
  GetHR(fit.me, c("ExtentE2", "ExtentE3"))
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ Extent, data = flare.uc.df)
p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Montreal extent",
  palette = c("#3DDC97", "orange", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/uc/hard-flare/ibd/extent.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/hard-flare/ibd/extent.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(
  uc.hard.forest,
  GetHR(fit.me, c("ExtentE2", "ExtentE3"))
)

invisible(cox.summary(fit.me))
```

:::

### Mayo score

```{R}
flare.uc.df$Mayo_cat <- cut(flare.uc.df$Mayo,
  c(0, 2, 5, 9),
  labels = c("Inactive", "Mild", "Moderate"),
  right = TRUE
)
```

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(softflare_time, softflare) ~ Mayo_cat, data = flare.uc.df)
p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Mayo score",
  palette = c("#3DDC97", "orange", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to clinical flare"
)

cairo_pdf("plots/uc/soft-flare/ibd/mayo.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/soft-flare/ibd/mayo.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + Mayo + Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)


uc.clin.forest <- rbind(
  uc.clin.forest,
  GetHR(fit.me, "Mayo")
)

invisible(cox.summary(fit.me))
```

#### Hard flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6
fit <- survfit(Surv(hardflare_time, hardflare) ~ Mayo_cat, data = flare.uc.df)
p <- ggsurvplot(fit,
  data = flare.uc.df,
  conf.int = TRUE,
  pval = TRUE,
  pval.method = TRUE,
  ggtheme = theme_minimal(),
  risk.table = TRUE,
  legend.title = "Mayo score",
  palette = c("#3DDC97", "orange", "#DD7373"),
  xlab = "Time from study recrutiment (days)",
  title = "Time to hard flare"
)

cairo_pdf("plots/uc/hard-flare/ibd/mayo.pdf")
print(p, newpage = FALSE)
invisible(dev.off())

png("plots/uc/hard-flare/ibd/mayo.png",
  width = 7,
  height = 7,
  units = "in",
  res = 300
)
print(p, newpage = FALSE)
invisible(dev.off())
print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Mayo +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(
  uc.hard.forest,
  GetHR(fit.me, "Mayo")
)

invisible(cox.summary(fit.me))
```

:::

```{R}
saveRDS(flare.df, paste0(outdir, "flares-IBD.RDS"))
saveRDS(flare.cd.df, paste0(outdir, "flares-IBD-cd.RDS"))
saveRDS(flare.uc.df, paste0(outdir, "flares-IBD-uc.RDS"))

saveRDS(cd.clin.forest, paste0(outdir, "cd-clin-IBD.RDS"))
saveRDS(cd.hard.forest, paste0(outdir, "cd-hard-IBD.RDS"))
saveRDS(uc.clin.forest, paste0(outdir, "uc-clin-IBD.RDS"))
saveRDS(uc.hard.forest, paste0(outdir, "uc-hard-IBD.RDS"))
```

## Reproduction and reproducibility {.appendix}

<details class = "appendix">
  <summary> Session info </summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.

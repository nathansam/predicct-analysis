---
title: "Inflammatory bowel disease"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
bibliography: Survival.bib   
---

## Introduction

```{R}
#| message: false
source("Survival/utils.R")

# Setup analysis environment
analysis_setup <- setup_analysis()
paths <- analysis_setup$paths
demo <- analysis_setup$demo

demo$FC <- log(demo$FC)

flare.df <- readRDS(paste0(paths$outdir, "flares-demographics.RDS"))
flare.cd.df <- readRDS(paste0(paths$outdir, "flares-demographics-cd.RDS"))
flare.uc.df <- readRDS(paste0(paths$outdir, "flares-demographics-uc.RDS"))

cd.clin.forest <- readRDS(paste0(paths$outdir, "cd-clin-demographics.RDS"))
cd.hard.forest <- readRDS(paste0(paths$outdir, "cd-hard-demographics.RDS"))
uc.clin.forest <- readRDS(paste0(paths$outdir, "uc-clin-demographics.RDS"))
uc.hard.forest <- readRDS(paste0(paths$outdir, "uc-hard-demographics.RDS"))
```

## IBD Control-8

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize IBD Control-8
flare.cd.df <- categorize_variable(flare.cd.df, "control_8",
                                  breaks = c(0, 13, 16),
                                  labels = c("0-12", "13-16"))

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "control_8",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "IBD Control-8",
  plot_base_path = "plots/cd/soft-flare/ibd/control-8",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for continuous control_8 variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(cd.clin.forest, get_HR(fit.me, "control_8"))

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "control_8",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "IBD Control-8",
  plot_base_path = "plots/cd/hard-flare/ibd/control-8",
  break_time_by = 500,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for continuous control_8 variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(cd.hard.forest, get_HR(fit.me, "control_8"))

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Categorize IBD Control-8
flare.uc.df <- categorize_variable(flare.uc.df, "control_8",
                                  breaks = c(0, 13, 16),
                                  labels = c("0-12", "13-16"))

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "control_8",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "IBD Control-8",
  plot_base_path = "plots/uc/soft-flare/ibd/control-8",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for continuous control_8 variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(uc.clin.forest, get_HR(fit.me, "control_8"))

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "control_8",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "IBD Control-8",
  plot_base_path = "plots/uc/hard-flare/ibd/control-8",
  break_time_by = 500,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for continuous control_8 variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + control_8 + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(uc.hard.forest, get_HR(fit.me, "control_8"))

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

## IBD Control visual analogue scale

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Handle VAS control (already categorized as character)
flare.cd.df$vas_control_cat <- factor(flare.cd.df$vas_control)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "vas_control",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "IBD Control VAS",
  plot_base_path = "plots/cd/soft-flare/ibd/control-vas",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for vas_control variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "vas_control",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "IBD Control VAS",
  plot_base_path = "plots/cd/hard-flare/ibd/control-vas",
  break_time_by = 500,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for continuous vas_control variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Handle VAS control (already categorized as character)
flare.uc.df$vas_control_cat <- factor(flare.uc.df$vas_control)

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "vas_control",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "IBD Control VAS",
  plot_base_path = "plots/uc/soft-flare/ibd/control-vas",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for vas_control variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "vas_control",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "IBD Control VAS",
  plot_base_path = "plots/uc/hard-flare/ibd/control-vas",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Extract hazard ratio for vas_control variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + vas_control + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

## Biologic use

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Transform biologic variable and create categorized version
flare.cd.df <- flare.cd.df %>%
  mutate(Biologic = plyr::mapvalues(Biologic,
                                    from = c("Current",
                                             "Previously",
                                             "Never prescribed"),
                                    to = c("Prescribed",
                                           "Not prescribed",
                                           "Not prescribed")))

# Create categorized version for survival analysis
flare.cd.df$Biologic_cat <- flare.cd.df$Biologic

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Biologic",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Biologic",
  plot_base_path = "plots/cd/soft-flare/ibd/biologic",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Biologic",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Biologic",
  plot_base_path = "plots/cd/hard-flare/ibd/biologic",
  break_time_by = 500,
  palette = c("#1A8FE3", "#E76D83")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Transform biologic variable and create categorized version
flare.uc.df <- flare.uc.df %>%
  mutate(Biologic = plyr::mapvalues(Biologic,
                                    from = c("Current",
                                             "Previously",
                                             "Never prescribed"),
                                    to = c("Prescribed",
                                           "Not prescribed",
                                           "Not prescribed")))

# Create categorized version for survival analysis
flare.uc.df$Biologic_cat <- flare.uc.df$Biologic

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Biologic",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Biologic",
  plot_base_path = "plots/uc/soft-flare/ibd/biologic",
  break_time_by = 200,
  palette = c("#1A8FE3", "#E76D83")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Biologic",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Biologic",
  plot_base_path = "plots/uc/hard-flare/ibd/biologic",
  break_time_by = 500,
  palette = c("#1A8FE3", "#E76D83")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + Biologic + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

## Variables only relevant to Crohn's disease

```{R}
demo.cd <- readRDS(paste0(paths$outdir, "demo-cd.RDS"))
demo.cd <- demo.cd[, c(
  "ParticipantNo",
  "Surgery",
  "Location",
  "L4",
  "Behaviour",
  "Perianal",
  "HBI",
  "PRO2"
)]
flare.cd.df <- merge(flare.cd.df,
  demo.cd,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

# Create categorized versions for survival analysis
flare.cd.df$Surgery_cat <- flare.cd.df$Surgery
flare.cd.df$Location_cat <- flare.cd.df$Location
flare.cd.df$L4_cat <- flare.cd.df$L4
flare.cd.df$Behaviour_cat <- flare.cd.df$Behaviour
flare.cd.df$Perianal_cat <- flare.cd.df$Perianal
```

### Surgery

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Surgery",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Previous surgery",
  plot_base_path = "plots/cd/soft-flare/ibd/surgery",
  break_time_by = 200,
  palette = c("#3DDC97", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Surgery +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
cd.clin.forest <- rbind(cd.clin.forest, get_HR(fit.me, "SurgeryYes"))

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Surgery",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Previous surgery",
  plot_base_path = "plots/cd/hard-flare/ibd/surgery",
  break_time_by = 200,
  palette = c("#3DDC97", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Surgery +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
cd.hard.forest <- rbind(cd.hard.forest, get_HR(fit.me, "SurgeryYes"))

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Montreal location 

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Location",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Montreal location",
  plot_base_path = "plots/cd/soft-flare/ibd/location",
  break_time_by = 200,
  palette = c("#3B3561", "#5BC0EB", "#FFD166", "#E4572E")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Location +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  get_HR(fit.me, c("LocationL2", "LocationL3"))
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Location",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Montreal location",
  plot_base_path = "plots/cd/hard-flare/ibd/location",
  break_time_by = 200,
  palette = c("#3B3561", "#5BC0EB", "#FFD166", "#E4572E")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Location +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  get_HR(fit.me, c("LocationL2", "LocationL3"))
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Montreal L4 

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "L4",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Montreal L4 presence",
  plot_base_path = "plots/cd/soft-flare/ibd/l4",
  break_time_by = 200,
  palette = c("#3DDC97", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + L4 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)
cd.clin.forest <- rbind(
  cd.clin.forest,
  get_HR(fit.me, "L4Present")
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "L4",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Montreal L4 presence",
  plot_base_path = "plots/cd/hard-flare/ibd/l4",
  break_time_by = 200,
  palette = c("#3DDC97", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + L4 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  get_HR(fit.me, "L4Present")
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Montreal Behaviour

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Behaviour",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Montreal behaviour",
  plot_base_path = "plots/cd/soft-flare/ibd/behaviour",
  break_time_by = 200,
  palette = c("#3DDC97", "#FFD166", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Behaviour +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  get_HR(fit.me, c("BehaviourB2", "BehaviourB3"))
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Behaviour",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Montreal behaviour",
  plot_base_path = "plots/cd/hard-flare/ibd/behaviour",
  break_time_by = 200,
  palette = c("#3DDC97", "#FFD166", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Behaviour +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  get_HR(fit.me, c("BehaviourB2", "BehaviourB3"))
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Perinanal disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Perianal",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Perianal disease",
  plot_base_path = "plots/cd/soft-flare/ibd/perinal",
  break_time_by = 200,
  palette = c("#3DDC97", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Perianal +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  get_HR(fit.me, "PerianalYes")
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Perianal",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Perianal disease",
  plot_base_path = "plots/cd/hard-flare/ibd/perinal",
  break_time_by = 200,
  palette = c("#3DDC97", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Perianal +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  get_HR(fit.me, "PerianalYes")
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::


## Variables only relevant to UC/IBDU

```{R}
demo.uc <- readRDS(paste0(paths$outdir, "demo-uc.RDS"))
demo.uc <- demo.uc[, c("ParticipantNo", "Extent", "Mayo")]
flare.uc.df <- merge(flare.uc.df,
  demo.uc,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

# Create categorized version for survival analysis
flare.uc.df$Extent_cat <- flare.uc.df$Extent
```

### Montreal extent

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Extent",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Montreal extent",
  plot_base_path = "plots/uc/soft-flare/ibd/extent",
  break_time_by = 200,
  palette = c("#3DDC97", "orange", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + IMD + Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(
  uc.clin.forest,
  get_HR(fit.me, c("ExtentE2", "ExtentE3"))
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Extent",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Montreal extent",
  plot_base_path = "plots/uc/hard-flare/ibd/extent",
  break_time_by = 200,
  palette = c("#3DDC97", "orange", "#DD7373")
)

# Cox model
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(
  uc.hard.forest,
  get_HR(fit.me, c("ExtentE2", "ExtentE3"))
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

### Mayo score

```{R}
flare.uc.df$Mayo_cat <- cut(flare.uc.df$Mayo,
  c(0, 2, 5, 9),
  labels = c("Inactive", "Mild", "Moderate"),
  right = TRUE
)
```

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Mayo",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Mayo score",
  plot_base_path = "plots/uc/soft-flare/ibd/mayo",
  break_time_by = 200,
  palette = c("#3DDC97", "orange", "#DD7373")
)

# Cox model using continuous Mayo variable
fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + cat + Mayo + Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(
  uc.clin.forest,
  get_HR(fit.me, "Mayo")
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

# Run survival analysis using utility function
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Mayo",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Mayo score",
  plot_base_path = "plots/uc/hard-flare/ibd/mayo",
  break_time_by = 200,
  palette = c("#3DDC97", "orange", "#DD7373")
)

# Cox model using continuous Mayo variable
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + cat + IMD + Mayo +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(
  uc.hard.forest,
  get_HR(fit.me, "Mayo")
)

# Display plot and model summary
print(analysis_result$plot, newpage = FALSE)
invisible(cox_summary(fit.me))
```

:::

```{R}
saveRDS(flare.df, paste0(paths$outdir, "flares-IBD.RDS"))
saveRDS(flare.cd.df, paste0(paths$outdir, "flares-IBD-cd.RDS"))
saveRDS(flare.uc.df, paste0(paths$outdir, "flares-IBD-uc.RDS"))

saveRDS(cd.clin.forest, paste0(paths$outdir, "cd-clin-IBD.RDS"))
saveRDS(cd.hard.forest, paste0(paths$outdir, "cd-hard-IBD.RDS"))
saveRDS(uc.clin.forest, paste0(paths$outdir, "uc-clin-IBD.RDS"))
saveRDS(uc.hard.forest, paste0(paths$outdir, "uc-hard-IBD.RDS"))
```

<details class = "appendix">
  <summary> Control for additional covariates </summary>
  
<h3> Crohn's disease </h3>

<h4> Patient-reported flare </h4>

<h5> IBD Control-8 </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    control_8 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> IBD Control VAS </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    vas_control +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Previous surgery </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Surgery +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal location </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Location +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal L4 presence </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    L4 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal behaviour </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Behaviour +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Perianal disease </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Perianal +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h4> Objective flare </h4>

<h5> IBD Control-8 </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    control_8 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> IBD Control VAS </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    vas_control +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Previous surgery </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Surgery +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal location </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Location +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal L4 presence </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    L4 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal behaviour </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Behaviour +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h5> Perianal disease </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Perianal +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

invisible(cox_summary(fit.me))
```

<h3> Ulcerative colitis </h3>

<h4> Patient-reported flare </h4>

<h5> IBD Control-8 </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    control_8 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> IBD Control VAS </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    vas_control +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal extent </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Mayo score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Mayo +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h4> Objective flare </h4>

<h5> IBD Control-8 </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    control_8 +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> IBD Control VAS </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    vas_control +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Montreal extent </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Extent +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

<h5> Mayo score </h5>

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    cat +
    IMD +
    `IBD Duration` +
    BMI +
    Treatment +
    Age +
    Mayo +
    frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

invisible(cox_summary(fit.me))
```

</details>
  
## Reproduction and reproducibility {.appendix}

<details class = "appendix">
  <summary> Session info </summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.

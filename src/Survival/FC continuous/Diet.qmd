---
title: "Diet"
format: 
  html:
    code-fold: true
    code-tools: true
editor: visual
toc: true
toc-expand: true
---

# Setting up in R

## Load the data

```{r}
library(splines)

source("Survival/utils.R")

# Setup analysis environment
analysis_setup <- setup_analysis()
paths <- analysis_setup$paths
demo <- analysis_setup$demo

flare.df <- readRDS(paste0(paths$outdir, "flares-biochem.RDS"))
flare.cd.df <- readRDS(paste0(paths$outdir, "flares-biochem-cd.RDS"))
flare.uc.df <- readRDS(paste0(paths$outdir, "flares-biochem-uc.RDS"))
```

## Data cleaning

```{r}
# FC has been logged twice - reverse
flare.df %<>%
  dplyr::mutate(FC = exp(FC))

flare.cd.df %<>%
  dplyr::mutate(FC = exp(FC))

flare.uc.df %<>%
  dplyr::mutate(FC = exp(FC))
# So now FC is the log of the FC measurement

# Transform age variable to decades
flare.df %<>%
  dplyr::mutate(
    age_decade = Age/10
  )

flare.cd.df %<>%
  dplyr::mutate(
    age_decade = Age/10
  )

flare.uc.df %<>%
  dplyr::mutate(
    age_decade = Age/10
  )

```

## Helper functions

```{r}

summon_reference_values <- function(data, variables){
  # Function that extracts the reference value for each variable in a data frame
  # Reference is either the first factor level or the median
  # Used for producing HR plots
  
  data %>%
    dplyr::select(tidyselect::all_of(variables)) %>%
    dplyr::summarise(across(
      .cols = everything(),
      .fns = function(x) {
        if (is.factor(x)) {
          levels(x) %>% dplyr::first()
        } else if (is.numeric(x)) {
          median(x, na.rm = TRUE)
        } else {
          NULL
        }
      }
    ))
  
}


plot_continuous_hr <- function(data, model, variable){
  # Plotting continuous Hazard Ratio curves
  
  # model is a Cox model
  # variable is the variable we are plotting
  
  # Range of the variable to plot
  variable_range <- data %>%
    dplyr::pull(variable) %>%
    quantile(., probs = seq(0, 0.95, 0.01), na.rm = TRUE) %>%
    unname() %>%
    unique()
  
  # Reference variables
  # Extract variables used in the Cox model
  # Remove the variable we want to vary and the SiteNo
  ref_variables <- all.vars(delete.response(terms(model))) %>%
    tibble(x = .) %>%
    dplyr::filter(
      x != variable,
      x != 'SiteNo'
    ) %>%
    dplyr::pull(x)
  
  # Reference level of the continuous variable
  # Set to the lowest
  ref_value <- variable_range %>% min()
  
  # Create dummy data for plotting
  # Reference levels
  data %>%
    summon_reference_values(
      data = .,
      variables = ref_variables
    ) %>% {
    # Creating dummy data
      tibble(
        .,
        !!sym(variable) := variable_range
      )
    } %>% {
      pred = predict(model, newdata = ., type = "lp", se = TRUE)
      
      tibble(., p = pred$fit, se = pred$se)
    } %>% {
      df <- .
      
      # Subtract chosen reference value to set linear predictor to 0 at that value
      denominator <- df %>% 
        dplyr::filter(!!sym(variable) == ref_value) %>%
        dplyr::pull(p)
    
      df %>% 
        dplyr::mutate(p = p - denominator)
    
    } %>%
    ggplot(aes(x = !!rlang::sym(variable), y = exp(p), ymin = exp(p - 1.96*se), ymax = exp(p + 1.96*se))) +
    geom_point() +
    geom_line() +
    geom_ribbon(alpha = 0.2) +
    ylab("HR")
  
}

# Function to perform an LRT
summon_lrt <- function(model, remove) {
  # Function that removes a term and performs a
  # Likelihood ratio test to determine its significance
  
  update(model, paste0("~ . - ", remove)) %>%
    anova(model, ., test = 'LRT') %>%
    broom::tidy() %>%
    dplyr::filter(!is.na(p.value)) %>%
    dplyr::mutate(term = remove) %>%
    dplyr::mutate(test = 'LRT') %>%
    dplyr::relocate(term) %>%
    dplyr::relocate(test, .after = term)
  
}
```

# Survival Analysis

## Shapes of continuous variables

Using splines for the continuous variables. Testing the splines significance using a likelihood ratio test.

### Crohn's disease

#### Patient reported flare

```{r}
# Just the continuous variables

cox_cd_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_cd_soft, remove = 'age_decade', add =  "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_cd_soft, remove = 'BMI', add =  "ns(BMI, df = 2)")

# FC
summon_lrt(cox_cd_soft, remove = 'FC', add =  "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_cd_soft, remove = 'dqi_tot', add =  "ns(dqi_tot, df = 2)")

# None of the continuous variables benefit from a spline term
```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = 'FC'
)


# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = 'dqi_tot'
)
```

#### Objective flare

```{r}
# Just the continuous variables

cox_cd_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_cd_hard, remove = 'age_decade', add =  "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_cd_hard, remove = 'BMI', add =  "ns(BMI, df = 2)")

# FC
summon_lrt(cox_cd_hard, remove = 'FC', add =  "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_cd_hard, remove = 'dqi_tot', add =  "ns(dqi_tot, df = 2)")

# None of the continuous variables benefit from a spline term
```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = 'FC'
)


# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = 'dqi_tot'
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}
# Just the continuous variables

cox_uc_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_uc_soft, remove = 'age_decade', add =  "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_uc_soft, remove = 'BMI', add =  "ns(BMI, df = 2)")

# FC
summon_lrt(cox_uc_soft, remove = 'FC', add = "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_uc_soft, remove = 'dqi_tot', add =  "ns(dqi_tot, df = 2)")

# FC and dqi_tot can get a spline
cox_uc_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(dqi_tot, df = 2) +
               frailty(SiteNo),
             data = flare.uc.df
)

# Test for df = 3
# FC
summon_lrt(cox_uc_soft, remove = 'ns(FC, df = 2)', add = "ns(FC, df = 3)")

# dqi_tot
summon_lrt(cox_uc_soft, remove = 'ns(dqi_tot, df = 2)', add =  "ns(dqi_tot, df = 3)")

```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_soft,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_soft,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_soft,
  variable = 'FC'
)


# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_soft,
  variable = 'dqi_tot'
)
```

#### Objective flare

```{r}
# Just the continuous variables

cox_uc_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_uc_hard, remove = 'age_decade', add =  "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_uc_hard, remove = 'BMI', add =  "ns(BMI, df = 2)")

# FC
summon_lrt(cox_uc_hard, remove = 'FC', add =  "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_uc_hard, remove = 'dqi_tot', add =  "ns(dqi_tot, df = 2)")

# FC benefits from a spline
cox_uc_hard <-  coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

# Test for df = 3
# FC
summon_lrt(cox_uc_soft, remove = 'ns(FC, df = 2)', add = "ns(FC, df = 3)")

# df = 2 is sufficient for FC
```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_hard,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_hard,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_hard,
  variable = 'FC'
)


# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_uc_hard,
  variable = 'dqi_tot'
)
```

## Total meat protein

### Crohns' disease

#### Patient reported flare

```{r}

cox_meat_cd_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(Meat_sum, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_meat_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_meat_cd_soft, remove =  "ns(Meat_sum, df = 2)")

```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  variable = 'FC'
)

# Meat sum
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  variable = 'Meat_sum'
)

# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  variable = 'dqi_tot'
)
```

#### Objective flare

```{r}

cox_meat_cd_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(Meat_sum, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_meat_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_meat_cd_hard, remove =  "ns(Meat_sum, df = 2)")
```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  variable = 'FC'
)

# Meat sum
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  variable = 'Meat_sum'
)

# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  variable = 'dqi_tot'
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}

cox_meat_uc_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(Meat_sum, df = 2) + 
               ns(dqi_tot, df = 2) +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_meat_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_meat_uc_soft, remove =  "ns(Meat_sum, df = 2)")
```

```{r}
# Age
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  variable = 'FC'
)

# Meat sum
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  variable = 'Meat_sum'
)

# DQI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  variable = 'dqi_tot'
)
```

#### Objective flare

```{r}

cox_meat_uc_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(Meat_sum, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_meat_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_meat_uc_hard, remove =  "ns(Meat_sum, df = 2)")

```

```{r}
# Age
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = 'age_decade'
)

# BMI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = 'BMI'
)

# FC
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = 'FC'
)

# Meat sum
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = 'Meat_sum'
)

# DQI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = 'dqi_tot'
)
```

## Dietary Fibre

### Crohn's disease

#### Patient reported flare

```{r}
cox_fibre_cd_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(fibre, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_fibre_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_fibre_cd_soft, remove =  "ns(fibre, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.cd.df,
                   model = cox_fibre_cd_soft,
                   variable = 'fibre')

```

#### Objective Flare

```{r}
cox_fibre_cd_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(fibre, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_fibre_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_fibre_cd_hard, remove =  "ns(fibre, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.cd.df,
                   model = cox_fibre_cd_hard,
                   variable = 'fibre')

```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_fibre_uc_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex +
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(fibre, df = 2) + 
               ns(dqi_tot, df = 2) +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_fibre_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_fibre_uc_soft, remove =  "ns(fibre, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.uc.df,
                   model = cox_fibre_uc_soft,
                   variable = 'fibre')

```

#### Objective Flare

```{r}
cox_fibre_uc_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(fibre, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_fibre_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_fibre_uc_hard, remove =  "ns(fibre, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.uc.df,
                   model = cox_fibre_uc_hard,
                   variable = 'fibre')

```

## Polyunsaturated fatty acids

### Crohn's disease

#### Patient reported flare

```{r}
cox_pufa_cd_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(PUFA_percEng, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_pufa_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_pufa_cd_soft, remove =  "ns(PUFA_percEng, df = 2)")
```

```{r}

plot_continuous_hr(data = flare.cd.df,
                   model = cox_pufa_cd_soft,
                   variable = 'PUFA_percEng')

```

#### Objective Flare

```{r}
cox_pufa_cd_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(PUFA_percEng, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_pufa_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_pufa_cd_hard, remove =  "ns(PUFA_percEng, df = 2)")
```

```{r}

plot_continuous_hr(data = flare.cd.df,
                   model = cox_pufa_cd_hard,
                   variable = 'PUFA_percEng')

```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_pufa_uc_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(PUFA_percEng, df = 2) + 
               ns(dqi_tot, df = 2) +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_pufa_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_pufa_uc_soft, remove =  "ns(PUFA_percEng, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.uc.df,
                   model = cox_pufa_uc_soft,
                   variable = 'PUFA_percEng')

```

#### Objective Flare

```{r}
cox_pufa_uc_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(PUFA_percEng, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_pufa_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_pufa_uc_hard, remove =  "ns(PUFA_percEng, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.uc.df,
                   model = cox_pufa_uc_hard,
                   variable = 'PUFA_percEng')

```

## Ultra-processed food

### Crohn's disease

#### Patient reported flare

```{r}
cox_upf_cd_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(UPF_perc, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_upf_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_upf_cd_soft, remove =  "ns(UPF_perc, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.cd.df,
                   model = cox_upf_cd_soft,
                   variable = 'UPF_perc')

```

#### Objective Flare

```{r}
cox_upf_cd_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               FC +
               ns(UPF_perc, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.cd.df
)

cox_upf_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_upf_cd_hard, remove =  "ns(UPF_perc, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.cd.df,
                   model = cox_upf_cd_hard,
                   variable = 'UPF_perc')

```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_upf_uc_soft <- coxph(Surv(softflare_time, softflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(UPF_perc, df = 2) + 
               ns(dqi_tot, df = 2) +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_upf_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_upf_uc_soft, remove =  "ns(UPF_perc, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.uc.df,
                   model = cox_upf_uc_soft,
                   variable = 'UPF_perc')

```

#### Objective Flare

```{r}
cox_upf_uc_hard <- coxph(Surv(hardflare_time, hardflare) ~
               Sex + 
               IMD +
               age_decade + 
               BMI +
               ns(FC, df = 2) +
               ns(UPF_perc, df = 2) + 
               dqi_tot +
               frailty(SiteNo),
             data = flare.uc.df
)

cox_upf_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

summon_lrt(cox_upf_uc_hard, remove = "ns(UPF_perc, df = 2)")

```

```{r}

plot_continuous_hr(data = flare.uc.df,
                   model = cox_upf_uc_hard,
                   variable = 'UPF_perc')

```

# Results

## Risk difference

### Crohn's disease

#### Patient reported flare

```{r}

# Values for calculation risk difference
rd_values_meat_cd <- quantile(flare.cd.df$Meat_sum, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round()

rd_values_fibre_cd <- quantile(flare.cd.df$fibre, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round()

rd_values_pufa_cd <- quantile(flare.cd.df$PUFA_percEng, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round(digits = 1)

rd_values_upf_cd <- quantile(flare.cd.df$UPF_perc, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round()

# Calculate risk difference for these values
data_rd_cd_soft_meat <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_cd_soft_fibre <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_fibre_cd_soft,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_cd_soft_pufa <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_pufa_cd_soft,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_cd_soft_upf <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_upf_cd_soft,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )

```

```{r}
# Plots

summon_rd_forest_plot <- function(data, time) {
  # Creating a forest plot of risk difference
  
  # Mask time
  time_point <- time
  
  data_plot <- data %>%
    dplyr::filter(time == time_point)
  
  # Forest plot
  plot <- data_plot %>%
    ggplot(aes(
      x = estimate,
      y = forcats::as_factor(term_tidy),
      xmin = conf.low,
      xmax = conf.high
    )) +
    geom_point() +
    geom_errorbarh() +
    geom_vline(xintercept = 0, linetype = "dotted") +
    theme_minimal() +
    xlab("Risk Difference") +
    theme(
    # Title
    plot.title = element_text(size = 10),
    plot.subtitle = element_text(size = 8),
    # Axes
    axis.title.y = element_blank()
    )
  
  # RD values
  rd <- data_plot %>%
    ggplot() +
    geom_text(aes(
      x = 0,
      y = forcats::as_factor(term_tidy),
      label = conf.interval.tidy
    )) +
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5))
  
  return(list(plot = plot, rd = rd))
  
}
```

```{r}
# Creating combined forest plot
# 1-year risk difference
plot_rd_cd_soft_meat_1y <- summon_rd_forest_plot(data_rd_cd_soft_meat, time = 365)

plot_rd_cd_soft_fibre_1y <- summon_rd_forest_plot(data_rd_cd_soft_fibre, time = 365)

plot_rd_cd_soft_pufa_1y <- summon_rd_forest_plot(data_rd_cd_soft_pufa, time = 365)

plot_rd_cd_soft_upf_1y <- summon_rd_forest_plot(data_rd_cd_soft_upf, time = 365)

# 2-year risk difference
plot_rd_cd_soft_meat_2y <- summon_rd_forest_plot(data_rd_cd_soft_meat, time = 730)

plot_rd_cd_soft_fibre_2y <- summon_rd_forest_plot(data_rd_cd_soft_fibre, time = 730)

plot_rd_cd_soft_pufa_2y <- summon_rd_forest_plot(data_rd_cd_soft_pufa, time = 730)

plot_rd_cd_soft_upf_2y <- summon_rd_forest_plot(data_rd_cd_soft_upf, time = 730)

```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_cd_soft_meat_1y$plot + (plot_rd_cd_soft_meat_1y$rd +
                                  labs(title = "Risk difference (95% CI)")) +
  plot_rd_cd_soft_fibre_1y$plot + plot_rd_cd_soft_fibre_1y$rd +
  plot_rd_cd_soft_pufa_1y$plot + plot_rd_cd_soft_pufa_1y$rd +
  plot_rd_cd_soft_upf_1y$plot + plot_rd_cd_soft_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = 'collect',
    axes = 'collect',
    width = c(2, 1)
  ) &
  coord_cartesian(xlim = c(-0.7, 0.3))
                                  
```

```{r}
# 2-year risk difference
plot_rd_cd_soft_meat_2y$plot + (plot_rd_cd_soft_meat_2y$rd +
                                  labs(title = "Risk difference (95% CI)")) +
  plot_rd_cd_soft_fibre_2y$plot + plot_rd_cd_soft_fibre_2y$rd +
  plot_rd_cd_soft_pufa_2y$plot + plot_rd_cd_soft_pufa_2y$rd +
  plot_rd_cd_soft_upf_2y$plot + plot_rd_cd_soft_upf_2y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = 'collect',
    axes = 'collect',
    width = c(2, 1)
  ) &
  coord_cartesian(xlim = c(-0.7, 0.3))
```

#### Objective Flare

```{r}
#| warning: false

# Calculate risk difference for these values
data_rd_cd_hard_meat <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_cd_hard_fibre <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_fibre_cd_hard,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_cd_hard_pufa <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_pufa_cd_hard,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_cd_hard_upf <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_upf_cd_hard,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_cd,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )

```

### Ulcerative colitis

#### Patient reported flare

```{r}

# Values for calculation risk difference
rd_values_meat_uc <- quantile(flare.uc.df$Meat_sum, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round()

rd_values_fibre_uc <- quantile(flare.uc.df$fibre, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round()

rd_values_pufa_uc <- quantile(flare.uc.df$PUFA_percEng, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round(digits = 1)

rd_values_upf_uc <- quantile(flare.uc.df$UPF_perc, probs = c(0, 0.25, 0.5, 0.75, 0.95), na.rm = TRUE) %>% round()

# Calculate risk difference for these values
data_rd_uc_soft_meat <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_uc_soft_fibre <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_fibre_uc_soft,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_uc_soft_pufa <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_pufa_uc_soft,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_uc_soft_upf <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_upf_uc_soft,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )

```

```{r}
# Creating combined forest plot
# 1-year risk difference
plot_rd_uc_soft_meat_1y <- summon_rd_forest_plot(data_rd_uc_soft_meat, time = 365)

plot_rd_uc_soft_fibre_1y <- summon_rd_forest_plot(data_rd_uc_soft_fibre, time = 365)

plot_rd_uc_soft_pufa_1y <- summon_rd_forest_plot(data_rd_uc_soft_pufa, time = 365)

plot_rd_uc_soft_upf_1y <- summon_rd_forest_plot(data_rd_uc_soft_upf, time = 365)

# 2-year risk difference
plot_rd_uc_soft_meat_2y <- summon_rd_forest_plot(data_rd_uc_soft_meat, time = 730)

plot_rd_uc_soft_fibre_2y <- summon_rd_forest_plot(data_rd_uc_soft_fibre, time = 730)

plot_rd_uc_soft_pufa_2y <- summon_rd_forest_plot(data_rd_uc_soft_pufa, time = 730)

plot_rd_uc_soft_upf_2y <- summon_rd_forest_plot(data_rd_uc_soft_upf, time = 730)

```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_uc_soft_meat_1y$plot + (plot_rd_uc_soft_meat_1y$rd +
                                  labs(title = "Risk difference (95% CI)")) +
  plot_rd_uc_soft_fibre_1y$plot + plot_rd_uc_soft_fibre_1y$rd +
  plot_rd_uc_soft_pufa_1y$plot + plot_rd_uc_soft_pufa_1y$rd +
  plot_rd_uc_soft_upf_1y$plot + plot_rd_uc_soft_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = 'collect',
    axes = 'collect',
    width = c(2, 1)
  ) &
  coord_cartesian(xlim = c(-0.6, 0.3))
                                  
```

```{r}
# 2-year risk difference
plot_rd_uc_soft_meat_2y$plot + (plot_rd_uc_soft_meat_2y$rd +
                                  labs(title = "Risk difference (95% CI)")) +
  plot_rd_uc_soft_fibre_2y$plot + plot_rd_uc_soft_fibre_2y$rd +
  plot_rd_uc_soft_pufa_2y$plot + plot_rd_uc_soft_pufa_2y$rd +
  plot_rd_uc_soft_upf_2y$plot + plot_rd_uc_soft_upf_2y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = 'collect',
    axes = 'collect',
    width = c(2, 1)
  ) &
  coord_cartesian(xlim = c(-0.6, 0.3))
```

#### Objective Flare

```{r}
#| warning: false

# Calculate risk difference for these values
data_rd_uc_hard_meat <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_uc_hard_fibre <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_fibre_uc_hard,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_uc_hard_pufa <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_pufa_uc_hard,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_uc_hard_upf <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_upf_uc_hard,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_uc,
  ref_value = NULL,
  nboot = 9
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )

```

```{r}
# Creating combined forest plot
# 1-year risk difference
plot_rd_uc_hard_meat_1y <- summon_rd_forest_plot(data_rd_uc_hard_meat, time = 365)

plot_rd_uc_hard_fibre_1y <- summon_rd_forest_plot(data_rd_uc_hard_fibre, time = 365)

plot_rd_uc_hard_pufa_1y <- summon_rd_forest_plot(data_rd_uc_hard_pufa, time = 365)

plot_rd_uc_hard_upf_1y <- summon_rd_forest_plot(data_rd_uc_hard_upf, time = 365)

# 2-year risk difference
plot_rd_uc_hard_meat_2y <- summon_rd_forest_plot(data_rd_uc_hard_meat, time = 730)

plot_rd_uc_hard_fibre_2y <- summon_rd_forest_plot(data_rd_uc_hard_fibre, time = 730)

plot_rd_uc_hard_pufa_2y <- summon_rd_forest_plot(data_rd_uc_hard_pufa, time = 730)

plot_rd_uc_hard_upf_2y <- summon_rd_forest_plot(data_rd_uc_hard_upf, time = 730)
```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_uc_hard_meat_1y$plot + (plot_rd_uc_hard_meat_1y$rd +
                                  labs(title = "Risk difference (95% CI)")) +
  plot_rd_uc_hard_fibre_1y$plot + plot_rd_uc_hard_fibre_1y$rd +
  plot_rd_uc_hard_pufa_1y$plot + plot_rd_uc_hard_pufa_1y$rd +
  plot_rd_uc_hard_upf_1y$plot + plot_rd_uc_hard_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = 'collect',
    axes = 'collect',
    width = c(2, 1)
  ) &
  coord_cartesian(xlim = c(-0.3, 0.1))
```

```{r}
# 2-year risk difference
plot_rd_uc_hard_meat_2y$plot + (plot_rd_uc_hard_meat_2y$rd +
                                  labs(title = "Risk difference (95% CI)")) +
  plot_rd_uc_hard_fibre_2y$plot + plot_rd_uc_hard_fibre_2y$rd +
  plot_rd_uc_hard_pufa_2y$plot + plot_rd_uc_hard_pufa_2y$rd +
  plot_rd_uc_hard_upf_2y$plot + plot_rd_uc_hard_upf_2y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = 'collect',
    axes = 'collect',
    width = c(2, 1)
  ) &
  coord_cartesian(xlim = c(-0.5, 0.2))
```

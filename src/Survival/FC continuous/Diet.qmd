---
title: "Diet"
format: 
  html:
    code-fold: true
    code-tools: true
editor: visual
toc: true
toc-expand: true
---

# Setting up in R

## Load the data

```{r}
library(splines)
library(patchwork)

source("Survival/utils.R")

# Setup analysis environment
analysis_setup <- setup_analysis()
paths <- analysis_setup$paths
demo <- analysis_setup$demo

flare.df <- readRDS(paste0(paths$outdir, "flares-biochem.RDS"))
flare.cd.df <- readRDS(paste0(paths$outdir, "flares-biochem-cd.RDS"))
flare.uc.df <- readRDS(paste0(paths$outdir, "flares-biochem-uc.RDS"))
```

## Data cleaning

```{r}
# FC has been logged twice - reverse
flare.df %<>%
  dplyr::mutate(FC = exp(FC))

flare.cd.df %<>%
  dplyr::mutate(FC = exp(FC))

flare.uc.df %<>%
  dplyr::mutate(FC = exp(FC))
# So now FC is on the original measurement scale (log transformation reversed)

# Transform age variable to decades
flare.df %<>%
  dplyr::mutate(
    age_decade = Age / 10
  )

flare.cd.df %<>%
  dplyr::mutate(
    age_decade = Age / 10
  )

flare.uc.df %<>%
  dplyr::mutate(
    age_decade = Age / 10
  )
```

## Helper functions

```{r}

plot_continuous_hr <- function(data, model, variable, splineterm = NULL){
  
  # Plotting continuous Hazard Ratio curves
  # Data is the same data used to fit the Cox model
  # model is a Cox model
  # variable is the variable we are plotting
  # splineterm is the spline used in the model, if there is one
  
  
  # Range of the variable to plot
  variable_range <- data %>%
    dplyr::pull(variable) %>%
    quantile(., probs = seq(0, 0.9, 0.01), na.rm = TRUE) %>%
    unname() %>%
    unique()
  
  # If there is a spline
  if (!is.null(splineterm)){
    
    # Recreate the spline
    spline <- with(data, eval(parse(text = splineterm)))
    
    # Get the spline terms for the variable values we are plotting
    spline_values <- predict(spline, newx = variable_range)
    
    # Get the reference values of the variables that were used to fit the Cox model
    X_ref <- model$means
    
    # New values to calculate the HR at 
    # Take the ref values and vary our variable of interest
    
    # Number of values
    n_values <- variable_range %>% length()
    
    X_ref <- matrix(rep(X_ref, n_values), nrow = n_values, byrow = TRUE)
    # Fix the column names
    colnames(X_ref) <- names(model$means)
    
    # Now add our new variable values
    X_new <- X_ref
    # Identify the correct columns
    column_pos <- stringr::str_detect(colnames(X_new), variable)
    # Add the values - ordering of columns and model term names should be preserved
    X_new[,column_pos] <- spline_values
    
    # Calculate the linear predictor and se
    # Method directly from predict.coxph from the survival package
    lp <- (X_new - X_ref)%*%coef(model) 
    
    lp_se <- rowSums((X_new - X_ref)%*%vcov(model)*(X_new - X_ref)) %>%
      as.numeric() %>%
      sqrt()
    
  } else {
    # If there is no spline then it is easier
    
    # Get the reference values of the variables that were used to fit the Cox model
    X_ref <- model$means
    
    # New values to calculate the HR at 
    # Take the ref values and vary our variable of interest
    
    # Number of values
    n_values <- variable_range %>% length()
    
    X_ref <- matrix(rep(X_ref, n_values), nrow = n_values, byrow = TRUE)
    # Fix the column names
    colnames(X_ref) <- names(model$means)
    
    # Now add our new variable values
    X_new <- X_ref
    
    # Add the values
    X_new[,variable] <- variable_range
    
    # Calculate the linear predictor and se
    # Method directly from predict.coxph from the survival package
    lp <- (X_new - X_ref)%*%coef(model) %>% as.numeric() 
    
    lp_se <- rowSums((X_new - X_ref)%*%vcov(model)*(X_new - X_ref)) %>% 
      as.numeric() %>%
      sqrt()
    
  }
  
  # Store results in a tibble
  data_pred <- tibble(
    !!sym(variable) := variable_range,
    p = lp,
    se = lp_se
  )
  
  # Plot
  data_pred %>%
    ggplot(aes(
      x = !!rlang::sym(variable),
      y = exp(p),
      ymin = exp(p - 1.96 * se),
      ymax = exp(p + 1.96 * se)
    )) +
    geom_point() +
    geom_line() +
    geom_ribbon(alpha = 0.2) +
    ylab("HR") + 
    theme_minimal()
  
}

# Function to perform an LRT
summon_lrt <- function(model, remove = NULL, add = NULL) {
  # Function that removes a term and performs a
  # Likelihood ratio test to determine its significance

  new_formula <- "~ ."

  if (!is.null(remove)) {
    new_formula <- paste0(new_formula, " - ", remove)
  } else {
    remove <- NA
  }

  if (!is.null(add)) {
    new_formula <- paste0(new_formula, " + ", add)
  } else {
    add <- NA
  }

  update(model, new_formula) %>%
    anova(model, ., test = "LRT") %>%
    broom::tidy() %>%
    dplyr::filter(!is.na(p.value)) %>%
    dplyr::select(-term) %>%
    dplyr::mutate(
      removed = remove,
      added = add
    ) %>%
    dplyr::mutate(test = "LRT") %>%
    dplyr::select(test, removed, added, tidyselect::everything())
}


summon_population_risk_difference <- function(data,
                                              model,
                                              times,
                                              variable,
                                              values,
                                              ref_value = NULL) {
  # Function that calculates (population average) risk difference of a variable
  # at given time points with respect to specified value of the variable from a
  # Cox model

  # If no reference value then use one in the middle
  if (is.null(ref_value)) {
    pos <- (length(values) / 2) %>% ceiling()
    ref_value <- values %>% purrr::pluck(pos)
  }

  # Identify the time variable - to differentiate between soft and hard flare models
  time_variable <- all.vars(terms(model))[1]

  df <- tidyr::expand_grid(times, values)

  purrr::map2(
    .x = df$times,
    .y = df$values,
    .f = function(x, y) {
      data %>%
        # Set values for time and the variable
        dplyr::mutate(!!sym(time_variable) := x, !!sym(variable) := y) %>%
        # Estimate expected for entire population
        predict(model, newdata = ., type = "expected") %>%
        tibble(expected = .) %>%
        # Remove NA
        dplyr::filter(!is.na(expected)) %>%
        # Calculate survival and cumulative incidence (1 - survival)
        dplyr::mutate(
          survival = exp(-expected),
          cum_incidence = 1 - survival
        ) %>%
        dplyr::select(cum_incidence) %>%
        dplyr::summarise(cum_incidence = mean(cum_incidence)) %>%
        # Note time, value and variable
        dplyr::mutate(time = x, value = y, variable = variable)
    }
  ) %>%
    purrr::list_rbind() %>%
    # Calculate risk difference relative to a reference
    {
      df <- .

      # Subtract chosen reference value to set linear predictor to 0 at that value
      cum_incidence_ref <- df %>%
        dplyr::filter(value == ref_value) %>%
        dplyr::rename(cum_incidence_ref = cum_incidence) %>%
        dplyr::select(time, cum_incidence_ref)

      df %>%
        dplyr::left_join(cum_incidence_ref, by = "time") %>%
        dplyr::mutate(rd = (cum_incidence - cum_incidence_ref)*100, .keep = "unused")
    }
}


summon_population_risk_difference_boot <- function(data,
                                                   model,
                                                   times,
                                                   variable,
                                                   values,
                                                   ref_value = NULL,
                                                   nboot = 99,
                                                   seed = 1) {
  # Function to calculate population risk difference for a given variable at given time points
  # relative to a specified reference value
  # Confidence intervals calculated using bootstrapping.

  # Set seed
  set.seed(seed)

  # If no reference value then use one in the middle
  if (is.null(ref_value)) {
    pos <- (length(values) / 2) %>% ceiling()
    ref_value <- values %>% purrr::pluck(pos)
  }

  purrr::map_dfr(
    .x = seq_len(nboot),
    .f = function(b) {
      # Variable used in the model
      all_variables <- all.vars(terms(model))

      # Bootstrap sample of the data
      data_boot <- data %>%
        # Remove any NAs as Cox doesn't use these
        dplyr::select(tidyselect::all_of(all_variables)) %>%
        dplyr::filter(!dplyr::if_any(.cols = everything(), .fns = is.na)) %>%
        # Sample the df
        dplyr::slice_sample(prop = 1, replace = TRUE)

      # Refit cox model of bootstrapped data
      model_boot <- coxph(formula(model), data = data_boot, model = TRUE)

      # Calculate risk differences
      summon_population_risk_difference(
        data = data_boot,
        model = model_boot,
        times = times,
        variable = variable,
        values = values,
        ref_value = ref_value
      )
    }
  ) %>%
    dplyr::group_by(time, value) %>%
    # Bootstrapped estimate and confidence intervals
    dplyr::summarise(
      mean_rd = mean(rd),
      conf.low = quantile(rd, prob = 0.025),
      conf.high = quantile(rd, prob = 0.975)
    ) %>%
    dplyr::ungroup() %>%
    dplyr::rename(estimate = mean_rd) %>%
    # Note variable, reference level flag
    dplyr::mutate(
      variable = variable,
      reference_flag = (value == ref_value)
    ) %>%
    # Ordering for plotting
    dplyr::arrange(time, value) %>%
    dplyr::group_by(time) %>%
    dplyr::mutate(ordering = dplyr::row_number()) %>%
    # Tidy confidence intervals
    # Remove confidence intervals for reference level
    dplyr::mutate(
      conf.low = dplyr::case_when(reference_flag == TRUE ~ NA,
        .default = conf.low
      ),
      conf.high = dplyr::case_when(reference_flag == TRUE ~ NA,
        .default = conf.high
      )
    ) %>%
    dplyr::mutate(
      conf.interval.tidy = dplyr::case_when(
        (is.na(conf.low) & is.na(conf.high)) ~ "-",
        TRUE ~ paste0(
          sprintf("%.3g", estimate),
          " (",
          sprintf("%.3g", conf.low),
          ", ",
          sprintf("%.3g", conf.high),
          ")"
        )
      )
    ) %>%
    # Significance
    dplyr::mutate(
      significance = dplyr::case_when(
        reference_flag == TRUE ~ "Reference level",
        sign(conf.low) == sign(conf.high) ~ "Significant",
        sign(conf.low) != sign(conf.high) ~ "Not Significant"
      )
    )
}


summon_rd_forest_plot <- function(data, time) {
  # Creating a forest plot of risk difference from the result of
  # summon_population_risk_difference_boot

  # Mask time
  time_point <- time

  data_plot <- data %>%
    dplyr::filter(time == time_point)

  # Forest plot
  plot <- data_plot %>%
    ggplot(aes(
      x = estimate,
      y = forcats::as_factor(term_tidy),
      xmin = conf.low,
      xmax = conf.high
    )) +
    geom_point() +
    geom_errorbarh() +
    geom_vline(xintercept = 0, linetype = "dotted") +
    theme_minimal() +
    xlab("Risk Difference (%)") +
    theme(
      # Title
      plot.title = element_text(size = 10),
      plot.subtitle = element_text(size = 8),
      # Axes
      axis.title.y = element_blank()
    )

  # RD values
  rd <- data_plot %>%
    ggplot() +
    geom_text(aes(
      x = 0,
      y = forcats::as_factor(term_tidy),
      label = conf.interval.tidy
    )) +
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5))

  return(list(plot = plot, rd = rd))
}
```

# Survival Analysis

## Shapes of continuous variables

Using splines for the continuous variables. Testing the splines significance using a likelihood ratio test.

### Crohn's disease

#### Patient reported flare

```{r}
# Just the continuous variables

cox_cd_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_cd_soft, remove = "age_decade", add = "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_cd_soft, remove = "BMI", add = "ns(BMI, df = 2)")

# FC
summon_lrt(cox_cd_soft, remove = "FC", add = "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_cd_soft, remove = "dqi_tot", add = "ns(dqi_tot, df = 2)")

# None of the continuous variables benefit from a spline term
```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = "age_decade"
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = "BMI"
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = "FC"
)


# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_soft,
  variable = "dqi_tot"
)
```

#### Objective flare

```{r}
# Just the continuous variables

cox_cd_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_cd_hard, remove = "age_decade", add = "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_cd_hard, remove = "BMI", add = "ns(BMI, df = 2)")

# FC
summon_lrt(cox_cd_hard, remove = "FC", add = "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_cd_hard, remove = "dqi_tot", add = "ns(dqi_tot, df = 2)")

# None of the continuous variables benefit from a spline term
```

```{r}
# Age
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = "age_decade"
)

# BMI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = "BMI"
)

# FC
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = "FC"
)


# DQI
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_cd_hard,
  variable = "dqi_tot"
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}
# Just the continuous variables

cox_uc_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_uc_soft, remove = "age_decade", add = "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_uc_soft, remove = "BMI", add = "ns(BMI, df = 2)")

# FC
summon_lrt(cox_uc_soft, remove = "FC", add = "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_uc_soft, remove = "dqi_tot", add = "ns(dqi_tot, df = 2)")

# FC and dqi_tot can get a spline
cox_uc_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    ns(dqi_tot, df = 2) +
    frailty(SiteNo),
  data = flare.uc.df
)

# Test for df = 3
# FC
summon_lrt(cox_uc_soft, remove = "ns(FC, df = 2)", add = "ns(FC, df = 3)")

# dqi_tot
summon_lrt(cox_uc_soft,
  remove = "ns(dqi_tot, df = 2)",
  add = "ns(dqi_tot, df = 3)"
)
```

```{r}
# Age
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_soft,
  variable = "age_decade"
)

# BMI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_soft,
  variable = "BMI"
)

# FC
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_soft,
  variable = "FC",
  splineterm = "ns(FC, df = 2)"
)


# DQI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_soft,
  variable = "dqi_tot",
  splineterm = "ns(dqi_tot, df = 2)"
)
```

#### Objective flare

```{r}
# Just the continuous variables

cox_uc_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

# Is there any benefit to using spline for:

# age
summon_lrt(cox_uc_hard, remove = "age_decade", add = "ns(age_decade, df = 2)")

# BMI
summon_lrt(cox_uc_hard, remove = "BMI", add = "ns(BMI, df = 2)")

# FC
summon_lrt(cox_uc_hard, remove = "FC", add = "ns(FC, df = 2)")

# dqi_tot
summon_lrt(cox_uc_hard, remove = "dqi_tot", add = "ns(dqi_tot, df = 2)")

# FC benefits from a spline
cox_uc_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

# Test for df = 3
# FC
summon_lrt(cox_uc_hard, remove = "ns(FC, df = 2)", add = "ns(FC, df = 3)")

# df = 2 is sufficient for FC
```

```{r}
# Age
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_hard,
  variable = "age_decade"
)

# BMI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_hard,
  variable = "BMI"
)

# FC
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_hard,
  variable = "FC",
  splineterm = "ns(FC, df = 2)"
)


# DQI
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_uc_hard,
  variable = "dqi_tot"
)
```

## Total meat protein

### Crohn's disease

#### Patient reported flare

```{r}
cox_meat_cd_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    Meat_sum +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_meat_cd_soft, remove = "Meat_sum", add = "ns(Meat_sum, df = 2)")
# No

cox_meat_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
# Meat sum
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  variable = "Meat_sum"
)
```

#### Objective flare

```{r}
cox_meat_cd_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    Meat_sum +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_meat_cd_hard, remove = "Meat_sum", add = "ns(Meat_sum, df = 2)")
# No

cox_meat_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
# Meat sum
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  variable = "Meat_sum"
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_meat_uc_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    Meat_sum +
    ns(dqi_tot, df = 2) +
    frailty(SiteNo),
  data = flare.uc.df
)

# Do we need a spline?
summon_lrt(cox_meat_uc_soft, remove = "Meat_sum", add = "ns(Meat_sum, df = 2)")
# No

cox_meat_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
# Meat sum
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  variable = "Meat_sum"
)
```

#### Objective flare

```{r}
cox_meat_uc_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    Meat_sum +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

# Do we need a spline?
summon_lrt(cox_meat_uc_hard, remove = "Meat_sum", add = "ns(Meat_sum, df = 2)")
# No

cox_meat_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
# Meat sum
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = "Meat_sum"
)

plot_continuous_hr(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  variable = "FC",
  splineterm = "ns(FC, df = 2)"
)
```

## Dietary Fibre

### Crohn's disease

#### Patient reported flare

```{r}
cox_fibre_cd_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    fibre +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_fibre_cd_soft, remove = "fibre", add = "ns(fibre, df = 2)")
# No

cox_fibre_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_fibre_cd_soft,
  variable = "fibre"
)
```

#### Objective Flare

```{r}
cox_fibre_cd_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    fibre +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

summon_lrt(cox_fibre_cd_hard, remove = "fibre", add = "ns(fibre, df = 2)")

cox_fibre_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_fibre_cd_hard,
  variable = "fibre"
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_fibre_uc_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    fibre +
    ns(dqi_tot, df = 2) +
    frailty(SiteNo),
  data = flare.uc.df
)

summon_lrt(cox_fibre_uc_soft, remove = "fibre", add = "ns(fibre, df = 2)")


cox_fibre_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_fibre_uc_soft,
  variable = "fibre"
)
```

#### Objective Flare

```{r}
cox_fibre_uc_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    fibre +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

summon_lrt(cox_fibre_uc_hard, remove = "fibre", add = "ns(fibre, df = 2)")

cox_fibre_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_fibre_uc_hard,
  variable = "fibre"
)
```

## Polyunsaturated fatty acids

### Crohn's disease

#### Patient reported flare

```{r}
cox_pufa_cd_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    PUFA_percEng +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_pufa_cd_soft,
  remove = "PUFA_percEng",
  add = "ns(PUFA_percEng, df = 2)"
)
# Close to 0.05, lets add one

cox_pufa_cd_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    ns(PUFA_percEng, df = 2) +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

summon_lrt(cox_pufa_cd_soft,
  remove = "ns(PUFA_percEng, df = 2)",
  add = "ns(PUFA_percEng, df = 3)"
)
# df = 2 is sufficient

cox_pufa_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)

# Significance - need to use LRT
summon_lrt(cox_pufa_cd_soft, remove = "ns(PUFA_percEng, df = 2)")
```

```{r}
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_pufa_cd_soft,
  variable = "PUFA_percEng",
  splineterm = "ns(PUFA_percEng, df = 2)"
)
```

#### Objective Flare

```{r}
cox_pufa_cd_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    PUFA_percEng +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_pufa_cd_hard,
  remove = "PUFA_percEng",
  add = "ns(PUFA_percEng, df = 2)"
)
# No

cox_pufa_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_pufa_cd_hard,
  variable = "PUFA_percEng"
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_pufa_uc_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    PUFA_percEng +
    ns(dqi_tot, df = 2) +
    frailty(SiteNo),
  data = flare.uc.df
)

# Do we need a spline?
summon_lrt(cox_pufa_uc_soft,
  remove = "PUFA_percEng",
  add = "ns(PUFA_percEng, df = 2)"
)
# No

cox_pufa_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_pufa_uc_soft,
  variable = "PUFA_percEng"
)
```

#### Objective Flare

```{r}
cox_pufa_uc_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    PUFA_percEng +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

# Do we need a spline?
summon_lrt(cox_pufa_uc_hard,
  remove = "PUFA_percEng",
  add = "ns(PUFA_percEng, df = 2)"
)
# No

cox_pufa_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_pufa_uc_hard,
  variable = "PUFA_percEng"
)
```

## Ultra-processed food

### Crohn's disease

#### Patient reported flare

```{r}
cox_upf_cd_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    UPF_perc +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_upf_cd_soft, remove = "UPF_perc", add = "ns(UPF_perc, df = 2)")
# No

cox_upf_cd_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_upf_cd_soft,
  variable = "UPF_perc"
)
```

#### Objective Flare

```{r}
cox_upf_cd_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    FC +
    UPF_perc +
    dqi_tot +
    frailty(SiteNo),
  data = flare.cd.df
)

# Do we need a spline?
summon_lrt(cox_upf_cd_hard, remove = "UPF_perc", add = "ns(UPF_perc, df = 2)")
# No

cox_upf_cd_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.cd.df,
  model = cox_upf_cd_hard,
  variable = "UPF_perc"
)
```

### Ulcerative colitis

#### Patient reported flare

```{r}
cox_upf_uc_soft <- coxph(
  Surv(softflare_time, softflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    UPF_perc +
    ns(dqi_tot, df = 2) +
    frailty(SiteNo),
  data = flare.uc.df
)

# Do we need a spline?
summon_lrt(cox_upf_uc_soft, remove = "UPF_perc", add = "ns(UPF_perc, df = 2)")
# Nop

cox_upf_uc_soft %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_upf_uc_soft,
  variable = "UPF_perc"
)
```

#### Objective Flare

```{r}
cox_upf_uc_hard <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex +
    IMD +
    age_decade +
    BMI +
    ns(FC, df = 2) +
    UPF_perc +
    dqi_tot +
    frailty(SiteNo),
  data = flare.uc.df
)

# Do we need a spline?
summon_lrt(cox_upf_uc_hard, remove = "UPF_perc", add = "ns(UPF_perc, df = 2)")
# No

cox_upf_uc_hard %>%
  broom::tidy(exp = TRUE, conf.int = TRUE)
```

```{r}
plot_continuous_hr(
  data = flare.uc.df,
  model = cox_upf_uc_hard,
  variable = "UPF_perc"
)
```

# Results

## Risk difference

### Crohn's disease

#### Patient reported flare

```{r}
# Values for calculation risk difference
rd_values_meat_cd <- quantile(flare.cd.df$Meat_sum,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round()

rd_values_fibre_cd <- quantile(flare.cd.df$fibre,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round()

rd_values_pufa_cd <- quantile(flare.cd.df$PUFA_percEng,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round(digits = 1)

rd_values_upf_cd <- quantile(flare.cd.df$UPF_perc,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round()

# Calculate risk difference for these values
data_rd_cd_soft_meat <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_meat_cd_soft,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_cd_soft_fibre <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_fibre_cd_soft,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_cd_soft_pufa <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_pufa_cd_soft,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_cd_soft_upf <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_upf_cd_soft,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )


# Creating combined forest plot
# 1-year risk difference
plot_rd_cd_soft_meat_1y <- summon_rd_forest_plot(data_rd_cd_soft_meat,
  time = 365
)

plot_rd_cd_soft_fibre_1y <- summon_rd_forest_plot(data_rd_cd_soft_fibre,
  time = 365
)

plot_rd_cd_soft_pufa_1y <- summon_rd_forest_plot(data_rd_cd_soft_pufa,
  time = 365
)

plot_rd_cd_soft_upf_1y <- summon_rd_forest_plot(data_rd_cd_soft_upf,
  time = 365
)

```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_cd_soft_meat_1y$plot + (plot_rd_cd_soft_meat_1y$rd +
  labs(title = "Risk difference (%) (95% CI)")) +
  plot_rd_cd_soft_fibre_1y$plot + plot_rd_cd_soft_fibre_1y$rd +
  plot_rd_cd_soft_pufa_1y$plot + plot_rd_cd_soft_pufa_1y$rd +
  plot_rd_cd_soft_upf_1y$plot + plot_rd_cd_soft_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = "collect",
    axes = "collect",
    width = c(2, 1)
  ) +
  patchwork::plot_annotation(
    title = "1-year risk difference",
    subtitle = "Crohn's, patient reported flare."
  ) &
  coord_cartesian(xlim = c(-30, 60))
```

#### Objective Flare

```{r}
#| warning: false

# Calculate risk difference for these values
data_rd_cd_hard_meat <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_meat_cd_hard,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_cd_hard_fibre <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_fibre_cd_hard,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_cd_hard_pufa <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_pufa_cd_hard,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_cd_hard_upf <- summon_population_risk_difference_boot(
  data = flare.cd.df,
  model = cox_upf_cd_hard,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_cd,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )


# Creating combined forest plot
# 1-year risk difference
plot_rd_cd_hard_meat_1y <- summon_rd_forest_plot(data_rd_cd_hard_meat,
  time = 365
)

plot_rd_cd_hard_fibre_1y <- summon_rd_forest_plot(data_rd_cd_hard_fibre,
  time = 365
)

plot_rd_cd_hard_pufa_1y <- summon_rd_forest_plot(data_rd_cd_hard_pufa,
  time = 365
)

plot_rd_cd_hard_upf_1y <- summon_rd_forest_plot(data_rd_cd_hard_upf,
  time = 365
)

```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_cd_hard_meat_1y$plot + (plot_rd_cd_hard_meat_1y$rd +
  labs(title = "Risk difference (%) (95% CI)")) +
  plot_rd_cd_hard_fibre_1y$plot + plot_rd_cd_hard_fibre_1y$rd +
  plot_rd_cd_hard_pufa_1y$plot + plot_rd_cd_hard_pufa_1y$rd +
  plot_rd_cd_hard_upf_1y$plot + plot_rd_cd_hard_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = "collect",
    axes = "collect",
    width = c(2, 1)
  ) +
  patchwork::plot_annotation(
    title = "1-year risk difference",
    subtitle = "Crohn's, objective flare."
  ) &
  coord_cartesian(xlim = c(-10, 20))
```

### Ulcerative colitis

#### Patient reported flare

```{r}
# Values for calculation risk difference
rd_values_meat_uc <- quantile(flare.uc.df$Meat_sum,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round()

rd_values_fibre_uc <- quantile(flare.uc.df$fibre,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round()

rd_values_pufa_uc <- quantile(flare.uc.df$PUFA_percEng,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round(digits = 1)

rd_values_upf_uc <- quantile(flare.uc.df$UPF_perc,
  probs = c(0, 0.25, 0.5, 0.75, 0.95),
  na.rm = TRUE
) %>%
  round()

# Calculate risk difference for these values
data_rd_uc_soft_meat <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_meat_uc_soft,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_uc_soft_fibre <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_fibre_uc_soft,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_uc_soft_pufa <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_pufa_uc_soft,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_uc_soft_upf <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_upf_uc_soft,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )

# Creating combined forest plot
# 1-year risk difference
plot_rd_uc_soft_meat_1y <- summon_rd_forest_plot(data_rd_uc_soft_meat,
  time = 365
)

plot_rd_uc_soft_fibre_1y <- summon_rd_forest_plot(data_rd_uc_soft_fibre,
  time = 365
)

plot_rd_uc_soft_pufa_1y <- summon_rd_forest_plot(data_rd_uc_soft_pufa,
  time = 365
)

plot_rd_uc_soft_upf_1y <- summon_rd_forest_plot(data_rd_uc_soft_upf,
  time = 365
)

```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_uc_soft_meat_1y$plot + (plot_rd_uc_soft_meat_1y$rd +
  labs(title = "Risk difference (%) (95% CI)")) +
  plot_rd_uc_soft_fibre_1y$plot + plot_rd_uc_soft_fibre_1y$rd +
  plot_rd_uc_soft_pufa_1y$plot + plot_rd_uc_soft_pufa_1y$rd +
  plot_rd_uc_soft_upf_1y$plot + plot_rd_uc_soft_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = "collect",
    axes = "collect",
    width = c(2, 1)
  ) +
  patchwork::plot_annotation(
    title = "1-year risk difference",
    subtitle = "Ulcerative colitis, patient reported flare."
  ) &
  coord_cartesian(xlim = c(-20, 40))
```

#### Objective Flare

```{r}
#| warning: false

# Calculate risk difference for these values
data_rd_uc_hard_meat <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_meat_uc_hard,
  times = c(365, 730),
  variable = "Meat_sum",
  values = rd_values_meat_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Total meat protein: ", value)
  )

data_rd_uc_hard_fibre <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_fibre_uc_hard,
  times = c(365, 730),
  variable = "fibre",
  values = rd_values_fibre_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("Dietary fibre: ", value)
  )

data_rd_uc_hard_pufa <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_pufa_uc_hard,
  times = c(365, 730),
  variable = "PUFA_percEng",
  values = rd_values_pufa_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("PUFA: ", value)
  )

data_rd_uc_hard_upf <- summon_population_risk_difference_boot(
  data = flare.uc.df,
  model = cox_upf_uc_hard,
  times = c(365, 730),
  variable = "UPF_perc",
  values = rd_values_upf_uc,
  ref_value = NULL,
  nboot = 99
) %>%
  dplyr::mutate(
    term_tidy = paste0("UPF (%): ", value)
  )


# Creating combined forest plot
# 1-year risk difference
plot_rd_uc_hard_meat_1y <- summon_rd_forest_plot(data_rd_uc_hard_meat,
  time = 365
)

plot_rd_uc_hard_fibre_1y <- summon_rd_forest_plot(data_rd_uc_hard_fibre,
  time = 365
)

plot_rd_uc_hard_pufa_1y <- summon_rd_forest_plot(data_rd_uc_hard_pufa,
  time = 365
)

plot_rd_uc_hard_upf_1y <- summon_rd_forest_plot(data_rd_uc_hard_upf,
  time = 365
)

```

```{r}
#| warning: false
# Final plots using patchwork

# 1-year risk difference
plot_rd_uc_hard_meat_1y$plot + (plot_rd_uc_hard_meat_1y$rd +
  labs(title = "Risk difference (%) (95% CI)")) +
  plot_rd_uc_hard_fibre_1y$plot + plot_rd_uc_hard_fibre_1y$rd +
  plot_rd_uc_hard_pufa_1y$plot + plot_rd_uc_hard_pufa_1y$rd +
  plot_rd_uc_hard_upf_1y$plot + plot_rd_uc_hard_upf_1y$rd +
  patchwork::plot_layout(
    ncol = 2,
    guides = "collect",
    axes = "collect",
    width = c(2, 1)
  ) +
  patchwork::plot_annotation(
    title = "1-year risk difference",
    subtitle = "Ulcerative colitis, objective flare."
  ) &
  coord_cartesian(xlim = c(-10, 20))
```

---
title: "Demographic data"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
bibliography: Survival.bib   
---

## Introduction

```{R}
#| message: false
source("Survival/utils.R")
library(forestplot)

# Setup analysis environment
analysis_setup <- setup_analysis()
paths <- analysis_setup$paths
demo <- analysis_setup$demo

flare.df <- readRDS(paste0(paths$outdir, "flares-controlled.RDS"))
flare.cd.df <- readRDS(paste0(paths$outdir, "flares-controlled-cd.RDS"))
flare.uc.df <- readRDS(paste0(paths$outdir, "flares-controlled-uc.RDS"))

cd.clin.forest <- readRDS(paste0(paths$outdir, "cd-clin-controlled.RDS"))
cd.hard.forest <- readRDS(paste0(paths$outdir, "cd-hard-controlled.RDS"))
uc.clin.forest <- readRDS(paste0(paths$outdir, "uc-clin-controlled.RDS"))
uc.hard.forest <- readRDS(paste0(paths$outdir, "uc-hard-controlled.RDS"))
```

This page describes associations between demographic data and time-to-flare. Sex
and IMD are not covered here as they are covered in the
[controlled variables section](Controlled.qmd)

The page describing demographic variables in a descriptive manner can be found
[here](../Baseline/Demographics.qmd).

## Age

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

# Categorize age
flare.cd.df <- categorize_variable(flare.cd.df, "Age", 
                                   breaks = c(0, 18, 30, 45, 65, Inf),
                                   labels = c("Under 18", "18-29", "30-44", "45-64", "65+"))

# Generate survival plot and run Cox model
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Age",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Age",
  plot_base_path = "plots/cd/soft-flare/demographics/age",
  break_time_by = 200
)

# Extract hazard ratio for Age (continuous variable)
fit.me <- coxph(
  Surv(softflare_time, softflare) ~ Sex + IMD + cat + Age + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(cd.clin.forest, get_HR(fit.me, "Age"))

# Display plot and model summary
analysis_result$plot
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

# Generate survival plot and run Cox model for objective flare
analysis_result <- run_survival_analysis(
  data = flare.cd.df,
  var_name = "Age",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Age",
  plot_base_path = "plots/cd/hard-flare/demographics/age",
  break_time_by = 500
)

# Extract hazard ratio for Age (continuous variable)
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~ Sex + IMD + cat + Age + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(cd.hard.forest, get_HR(fit.me, "Age"))

# Display plot and model summary
analysis_result$plot
invisible(cox_summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

# Categorize age
flare.uc.df <- categorize_variable(flare.uc.df, "Age", 
                                   breaks = c(0, 18, 30, 45, 65, Inf),
                                   labels = c("Under 18", "18-29", "30-44", "45-64", "65+"))

# Generate survival plot and run Cox model
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Age",
  outcome_time = "softflare_time",
  outcome_event = "softflare",
  legend_title = "Age",
  plot_base_path = "plots/uc/soft-flare/demographics/age",
  break_time_by = 200
)

# Extract hazard ratio for Age (continuous variable)
fit.me <- coxph(
  Surv(softflare_time, softflare) ~ Sex + IMD + cat + Age + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.clin.forest <- rbind(uc.clin.forest, get_HR(fit.me, "Age"))

# Display plot and model summary
analysis_result$plot
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

# Generate survival plot and run Cox model for objective flare
analysis_result <- run_survival_analysis(
  data = flare.uc.df,
  var_name = "Age",
  outcome_time = "hardflare_time",
  outcome_event = "hardflare",
  legend_title = "Age",
  plot_base_path = "plots/uc/hard-flare/demographics/age",
  break_time_by = 500
)

# Extract hazard ratio for Age (continuous variable)
fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~ Sex + IMD + cat + Age + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)

uc.hard.forest <- rbind(uc.hard.forest, get_HR(fit.me, "Age"))

# Display plot and model summary
analysis_result$plot
invisible(cox_summary(fit.me))
```

:::

## BMI

### Crohn's disease

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

p <- generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(softflare_time, softflare) ~ BMIcat,
  legend_title = "BMI",
  legend_labs = c("Underweight", "Normal", "Overweight", "Obese"),
  palette = c("#1A8FE3", "#E76D83", "#5FB49C", "#FED766"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/cd/soft-flare/demographics/bmi"
)

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + BMI + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.clin.forest <- rbind(
  cd.clin.forest,
  get_HR(fit.me, c("BMI"))
)

invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

p <- generate_survival_plot(
  data = flare.cd.df,
  formula = Surv(hardflare_time, hardflare) ~ BMIcat,
  legend_title = "BMI",
  legend_labs = c("Underweight", "Normal", "Overweight", "Obese"),
  palette = c("#1A8FE3", "#E76D83", "#5FB49C", "#FED766"),
  xlab = "Time from study recruitment (days)",
  title = "Time to objective flare",
  break_time_by = 500,
  plot_path = "plots/cd/hard-flare/demographics/bmi"
)

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + BMI + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.cd.df
)

cd.hard.forest <- rbind(
  cd.hard.forest,
  get_HR(fit.me, c("BMI"))
)

invisible(cox_summary(fit.me))
```

:::

### Ulcerative colitis

::: {.panel-tabset group="followup"}

#### Patient-reported flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

p <- generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(softflare_time, softflare) ~ BMIcat,
  legend_title = "BMI",
  legend_labs = c("Underweight", "Normal", "Overweight", "Obese"),
  palette = c("#1A8FE3", "#E76D83", "#5FB49C", "#FED766"),
  xlab = "Time from study recruitment (days)",
  title = "Time to clinical flare",
  break_time_by = 200,
  plot_path = "plots/uc/soft-flare/demographics/bmi"
)

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(softflare_time, softflare) ~
    Sex + IMD + cat + BMI + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)
uc.clin.forest <- rbind(
  uc.clin.forest,
  get_HR(fit.me, c("BMI"))
)
invisible(cox_summary(fit.me))
```

#### Objective flare

```{R}
#| results: "hold"
#| output: "asis"
#| fig-height: 6.5

p <- generate_survival_plot(
  data = flare.uc.df,
  formula = Surv(hardflare_time, hardflare) ~ BMIcat,
  legend_title = "BMI",
  legend_labs = c("Underweight", "Normal", "Overweight", "Obese"),
  palette = c("#1A8FE3", "#E76D83", "#5FB49C", "#FED766"),
  xlab = "Time from study recruitment (days)",
  title = "Time to objective flare",
  break_time_by = 500,
  plot_path = "plots/uc/hard-flare/demographics/bmi"
)

print(p, newpage = FALSE)

fit.me <- coxph(
  Surv(hardflare_time, hardflare) ~
    Sex + IMD + cat + BMI + frailty(SiteNo),
  control = coxph.control(outer.max = 20),
  data = flare.uc.df
)
uc.hard.forest <- rbind(
  uc.hard.forest,
  get_HR(fit.me, "BMI")
  )
invisible(cox_summary(fit.me))
```

:::

```{R}
saveRDS(flare.df, paste0(paths$outdir, "flares-demographics.RDS"))
saveRDS(flare.cd.df, paste0(paths$outdir, "flares-demographics-cd.RDS"))
saveRDS(flare.uc.df, paste0(paths$outdir, "flares-demographics-uc.RDS"))

saveRDS(cd.clin.forest, paste0(paths$outdir, "cd-clin-demographics.RDS"))
saveRDS(cd.hard.forest, paste0(paths$outdir, "cd-hard-demographics.RDS"))
saveRDS(uc.clin.forest, paste0(paths$outdir, "uc-clin-demographics.RDS"))
saveRDS(uc.hard.forest, paste0(paths$outdir, "uc-hard-demographics.RDS"))
```

## Reproduction and reproducibility {.appendix}

<details class = "appendix">
  <summary> Session info </summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.

---
title: "Baseline PREdiCCt data"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
format:
  html:
    theme:
      light: [default, theme.scss]
      dark: [darkly]
    css: theme.css
    code-fold: true
    code-link: true
    toc: true
    code-tools:
      source: true
      toggle: true
    html-math-method: katex
    embed-resources: true
    mainfont: "Mulish"
    monofont: "Noto Sans Mono"
  pdf: 
    toc: true
    number-sections: false
    colorlinks: true
    execute:
      echo: false
      warning: false
---

## Introduction

```{R}
set.seed(123)

##############
## Packages ##
##############

library(plyr) # Used for mapping values
suppressPackageStartupMessages(library(tidyverse)) # ggplot2, dplyr, and magrittr
library(readxl) # Read in Excel files
library(datefixR) # Standardise dates  

# Generate tables
suppressPackageStartupMessages(library(table1))
library(knitr)
library(pander)

# Generate flowchart of cohort derivation
library(DiagrammeR)
library(DiagrammeRsvg)

# paths to PREdiCCt data
if (file.exists("/docker")) { # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed"
} else { # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
}

```

This report explores the baseline data for the PREdiCCt study, generating
inferences and producing display items for publication.

There are three main data sources for baseline demographic and phenotypic data
in PREdiCCt. 

1. Patient questionnaires
1. Forms completed by a subject's clinical team (via REDCap) during recruitment
1. Data collected retrospectively during the end-of-study (EoS) phenotyping by
   a subject's clinical team

As this report used all three, it will be made clear which source the data
presented originated from. 

A docker image [nathansam/predicct](#future-link) has been used to ensure this 
analysis remains reproducible.

## Variables relevant to all subjects

```{R}
# Demographic data as reported by subjects
demo <- read_xlsx(paste0(data.path, "Baseline2022/demographics.xlsx"),
  col_types = c(
    "text",
    "text",
    "text",
    "text",
    "numeric",
    "numeric",
    "text",
    "text",
    "date",
    "numeric",
    "text"
  )
)
```

Only variables relevant to all subjects will be considered in this section.
Later sections examine
[variables only relevant to CD subjects](##variables-only-relevant-to-crohns-disease-subjects) and
[variables only relevant to UC/IBDU subjects](#variables-only-relevant-to-ucibdu-subjects).

### Faecal calprotectin at study recruitment

```{R}
fcal <- read_xlsx(paste0(data.path, "Baseline2022/calprotectin.xlsx"))
fcal$Result <- as.numeric(plyr::mapvalues(fcal$Result, from = "<20", to = 20))

fcal <- fcal[, c("ParticipantNo", "Result")]

fcal.eof <- read_xlsx(paste0(prefix, "EOF_fcal.xlsx"))

fcal.eof <- subset(fcal.eof, IsBaseline == 1)
fcal.eof <- subset(fcal.eof, FCALLevel != ".")
fcal.eof$FCALLevel <- as.numeric(fcal.eof$FCALLevel)
fcal.eof <- fcal.eof[, c("ParticipantNo", "FCALLevel")]
names(fcal.eof)[2] <- "Result"

fcal <- rbind(fcal, fcal.eof)
fcal <- distinct(fcal, ParticipantNo, .keep_all = TRUE)
```

For faecal calprotectin (FC), data from both study recruitment and EoS
phenotyping have been used. Data from the latter was only used if no data
were available from recruitment. It should be noted that as the EoS FC tests
were performed at local sites, there is no guarantee the same assay was used and
there may therefore be site-based variation. Tests at recruitment were performed
using the same assay at the Western General Hospital and therefore free of
this issue. 

Plotting the distribution of baseline FC shows one subject has been reported
to have significantly elevated FC. As we later discretise FC into three groups,
this observation has not been removed. 

```{R}
fcal %>%
  ggplot(aes(x = Result)) +
  geom_histogram(bins = 60, fill = "#00A6ED", color = "#003459") +
  theme_minimal() +
  xlab("Baseline FCAL") +
  ylab("Frequency")
```

In addition to being reported as a continuous variable, it is common to group FC
into intervals. We have grouped FC into $FC < 50$, $50 \leq FC \leq 250$, and
$FC > 250$. Associations for all following variables will be reported against
these FC groups. 

```{R}
fcal$cat <- 0
for (i in 1:nrow(fcal)) {
  if (fcal[i, "Result"] < 50) fcal[i, "cat"] <- 1
  if ((fcal[i, "Result"] >= 50) & (fcal[i, "Result"] <= 250)) fcal[i, "cat"] <- 2
  if (fcal[i, "Result"] > 250) fcal[i, "cat"] <- 3
}


demo <- merge(demo, fcal[, c("ParticipantNo", "Result", "cat")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

demo$cat <- factor(demo$cat,
  levels = c(1, 2, 3),
  labels = c("FC < 50", "FC 50-250", "FC > 250")
)

names(demo)[12] <- "FC"

ggplot(demo, aes(x = cat, fill = cat, color = cat)) +
  geom_bar() +
  ylab("Frequency") +
  xlab("FC category") +
  theme_minimal() +
  scale_fill_manual(values = c("#508484", "#FCAA67", "#EB5160")) +
  scale_color_manual(values = c("#355C5C", "#B96E03", "#B12537")) +
  guides(fill = guide_legend(title = "FC category"),
         color = guide_legend(title = "FC category"))
```

`r sum(is.na(demo$cat))` subjects do not have a FCAL available for when they
joined PREdiCCt. Moving forward, we will only consider subjects with a baseline
FC available. 

```{R}
demo <- demo[!is.na(demo$cat),]
```

### Sex

Sex was self-reported via subject questionnaires. As can be seen in the below
figure, the PREdiCCt cohort is female by majority. 

```{R}
demo$Sex <- factor(demo$Sex, levels = c("1", "2"), labels = c("Male", "Female"))
ggplot(demo, aes(x = Sex, fill = Sex, color = Sex)) +
  geom_bar() +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#FCA17D", "#60D394")) +
  scale_color_manual(values = c("#B22A21","#034C3C"))
``` 

Moreover, sex is significantly different between FCAL groups. 

```{R}
pander(chisq.test(demo$Sex, demo$cat))
```

### IBD type

For this study, we have grouped ulcerative colitis (UC) and inflammatory bowel
disease unclassified (IBDU) into one category. 
IBD type is self-reported.

There are more Crohn's disease than UC/IBDU subjects. This suggests our
inclusion criteria may have biased against UC/IBDU subjects as prevalence for UC
is approximately double that of CD.

```{R}
demo$diagnosis2 <- plyr::mapvalues(demo$diagnosis,
  from = seq(1, 4),
  to = c(1, 2, 2, 2)
) %>%
  factor(levels = c("1", "2"), labels = c("CD", "UC/IBDU"))


ggplot(demo, aes(x = diagnosis2, fill = diagnosis2, color = diagnosis2)) +
  geom_bar() +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#2B2D42", "#92DCE5")) +
  scale_color_manual(values = c("#1E203A", "#1D9BA5")) +
    guides(fill = guide_legend(title = "IBD type"),
         color = guide_legend(title = "IBD type"))
```

```{R}
pander(chisq.test(demo$diagnosis2, demo$cat))
```

### Ethnicity

Due to low counts for non-white ethnicities, we are only able to report
frequencies for subjects who reported themselves as being of white or non-white
ethnicities. 

```{R}
demo$ethnic_gp <- factor(demo$ethnic_gp,
  levels = c("1", "2"),
  labels = c("White", "Non-white")
)
colnames(demo)[10:11] <- c("Age", "Ethnicity")

ggplot(demo, aes(x = Ethnicity, fill = Ethnicity, color = Ethnicity)) +
  geom_bar() +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#F24236", "#2E86AB"), na.value = "#5E5759") +
  scale_color_manual(values = c("#C0362C","#1E556C"), na.value = "#2E282A")

```

```{R}
pander(chisq.test(demo$Ethnicity, demo$cat))
```

###  Disease duration

Disease duration has been calculated by subtracting reported date of
diagnosis from the date of entry into PREdiCCt. Date of diagnosis has been
obtained via REDcap. Where only year was available, 
the [datefixR R package](https://docs.ropensci.org/datefixR/) was used to impute
the middle of the year. Any disease durations reported to be <0 using this
method were mapped to 0. 

```{R}
#| warning: false
redcap <- read_xlsx(paste0(redcap.path,"redcap_clean.xlsx"))
redcap <- distinct(redcap, participantno, .keep_all = TRUE)
```

```{R}
diag.date <- redcap[, c("participantno", "date_diag")]
colnames(diag.date)[1] <- "ParticipantNo"
diag.date <- subset(diag.date, (!is.na(date_diag)) &
  (!is.null(date_diag)) &
  date_diag != "")
duration <- merge(diag.date,
  demo,
  by = "ParticipantNo",
  all.x = FALSE,
  all.y = TRUE
)
duration <- distinct(duration, ParticipantNo, .keep_all = TRUE)

duration <- subset(duration, tolower(date_diag) != "unknown")
duration[duration[, "date_diag"] == "16/032016", "date_diag"] <- "16/03/2016"
duration[duration[, "date_diag"] == "19/04/2017P", "date_diag"] <- "19/04/2017"
duration[duration[, "date_diag"] == "2007 APPROX", "date_diag"] <- "2007"
duration[duration[, "date_diag"] == "approx 1988", "date_diag"] <- "1988"
duration[duration[, "date_diag"] == "?2014", "date_diag"] <- "2014"

duration <- fix_date_df(duration, c("entry_date", "date_diag"))

duration$duration <- as.numeric(with(duration,
                                     (entry_date - date_diag) / 365.25))

duration[duration[, "duration"] < 0, "duration"] <- 0


duration.cd <- subset(duration, diagnosis == "1")

duration.uc <- subset(duration, diagnosis != "1")

ggplot(
  duration,
  aes(x = duration, color = diagnosis == 1, fill = diagnosis == 1)
) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  labs(
    x = "Duration (years)",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#5EB1BF", "#C24343")
  )
```

Whilst disease duration was not significantly different between FC groups, a 
low p-value was observed. 

```{R}
demo <- merge(demo, duration[, c("ParticipantNo", "duration")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

names(demo)[15] <- "IBD Duration"
pander(summary(aov(`IBD Duration` ~ cat, data = demo)))
```

### Steroids

```{R}
extract_steroid_date <- function(steroid.dates) {
  tryCatch(expr = {
    if (!is.na(steroid.dates)) {
      fix_date_char(steroid.dates)
    }
  },
  error = function(e) {
    message("Could not fix ", steroid.dates)
    NA
  }
  )
}


demo$CST <- NA
demo$ivCST <- NA

for (row in 1:nrow(demo)) {
  id <- demo[row, "ParticipantNo" ]
  ster_dates <- subset(redcap, participantno == id)$oral_ster_start_date
  
  if (length(ster_dates) != 0) {
    ster_dates <- stringr::str_split(ster_dates,
                                     ", ",
                                     n = Inf,
                                     simplify = FALSE)[[1]]
  }
  if (all(is.na(ster_dates))) {
    demo[row, "CST"] <- NA
  } else {
    last_ster_date <- ster_dates[length(ster_dates)]
    demo[row, "CST"] <- extract_steroid_date(last_ster_date)
  }
  
  
  iv_ster_dates <- subset(redcap, participantno == id)$iv_ster_start_date
  
   if (length(iv_ster_dates) != 0) {
    iv_ster_dates <- stringr::str_split(iv_ster_dates,
                                     ", ",
                                     n = Inf,
                                     simplify = FALSE)[[1]]
  }
  if (all(is.na(iv_ster_dates))) {
    demo[row, "ivCST"] <- NA
  } else {
    # Assumes dates are given in order
    last_iv_ster_date <- iv_ster_dates[length(iv_ster_dates)]
    demo[row, "ivCST"] <- extract_steroid_date(last_iv_ster_date)
  }
}

demo$CST <- as.Date(demo$CST)
demo$ivCST <- as.Date(demo$ivCST)

demo$recent_ster <- pmax(demo$CST, demo$ivCST)
demo$`Time since last steroid` <- as.numeric(as.Date(demo$entry_date) - demo$recent_ster) / 365.25
```


```{R}
ggplot(demo, aes(x = `Time since last steroid`, color = diagnosis == 1, fill = diagnosis == 1)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  labs(
    x = "Time since last steroid Rx (years)",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#5EB1BF", "#C24343")
  )
```


### Bio-naive status

Bio-naive status has been determined using REDCap and EoS data. As clinical
teams were not explicitly asked if a subject was bio-naive, the subject is
instead defined as being bio-naive if there are no recorded biologics for the
subject (which may bias subjects with missing data towards incorrectly being
reported as bio-naive). Non bio-naive subjects are categorised further into
either "currently using" or "previously used". 

Biologic treatments were defined as infliximab, adalimumab, golimumab,
vedolizumab, and ustekinumab.

Small molecule treatments are not considered in this report due to their
low prescribing rates during the recruitment period (which ended March 2020).

```{R}
bio.naive <- data.frame(ParticipantNo = redcap$participantno)
bio.naive <- subset(bio.naive, ParticipantNo %in% demo$ParticipantNo)
bio.naive <- merge(bio.naive,
  demo[, c("ParticipantNo", "diagnosis")],
  all.y = TRUE,
  all.x = FALSE
)
bio.naive <- distinct(bio.naive, ParticipantNo, .keep_all = TRUE)
bio.naive$naive <- "yes"

bio.vars <- c("inflix", "ada", "goli", "vedo", "ust")

for (i in 1:nrow(bio.naive)) {
  temp.df <- as.data.frame(subset(redcap, participantno == bio.naive[i, 1]))
  temp.df <- temp.df[, paste0("curr_on_", bio.vars)]
  temp.df <- temp.df[, !is.na(temp.df[1, ])]

  if (any(temp.df == 1)) {
    bio.naive[i, "naive"] <- "no-using"
  } else if (any(temp.df == 2)) {
    bio.naive[i, "naive"] <- "no-not-using"
  } # else naive
}

drugs.eof <- read_xlsx(paste0(prefix, "EOF_drugs.xlsx"))
using <- subset(drugs.eof, AtRecruitmentYN == 1)
bio.list <- seq(4, 8)
using <- subset(using, DrugType %in% bio.list)
using <- subset(demo, ParticipantId %in% using$ParticipantId)
using <- using[, c("ParticipantNo", "diagnosis")]
using$naive <- c("no-using")

bio.naive <- rbind(bio.naive, using)

for (i in unique(bio.naive$ParticipantNo)) {
  temp <- subset(bio.naive, ParticipantNo == i)
  # if "no-using" in either extract then report using
  if (nrow(temp) > 1) {
    if (any(temp$naive == "no-using")) {
      bio.naive <- subset(bio.naive, ParticipantNo != i)
      bio.naive <- rbind(
        bio.naive,
        data.frame(
          ParticipantNo = i,
          diagnosis = temp[1, "diagnosis"],
          naive = "no-using"
        )
      )
    }
  }
}

bio.naive <- distinct(bio.naive, ParticipantNo, .keep_all = TRUE)

demo <- merge(demo,
  bio.naive[, c(1, 3)],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

demo$naive <- factor(demo$naive,
  levels = c("no-using", "no-not-using", "yes"),
  labels = c("Current Rx", "Previous Rx", "Never prescribed")
)

colnames(demo)[20] <- c("Biologic")

ggplot(demo, aes(x = Biologic, fill = Biologic, color = Biologic)) +
  geom_bar() +
  xlab("Biologic status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#CACF85", "#8CBA80", "#E58F65")) +
  scale_color_manual(values = c("#747825", "#4A6E3F", "#934D1B")) +
  guides(fill = guide_legend(title = "Biologic status"),
         color = guide_legend(title = "Biologic status"))
```

### Dietary data

#### Meat sum

```{R}
FFQ <- read_xlsx(paste0(
  prefix,
  "predicct ffq_nutrientfood groupDQI all foods_data (n1092)Nov2022.xlsx"
))
FFQ <- subset(FFQ, participantno %in% fcal$ParticipantNo)



FFQ$ParticipantNo <- FFQ$participantno
demo <- merge(demo,
      FFQ[, c("ParticipantNo", "Meat_sum", "fibre", "PUFAg", "NOVAScore_cat")],
      by = "ParticipantNo",
      all.x = TRUE,
      all.y = FALSE)

demo$NOVAScore_cat <- factor(demo$NOVAScore_cat,
                             levels = 1:4,
                             labels = c("Unprocessed",
                                        "Processed culinary",
                                        "Proccesed food",
                                        "Ultra-processed"))

demo %>%
  ggplot(aes(x = Meat_sum, color = diagnosis == 1, fill = diagnosis == 1)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  labs(
    x = "Meat Sum",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#5EB1BF", "#C24343")
  )
```

#### Fibre

```{R}
demo %>%
  ggplot(aes(x = fibre, color = diagnosis == 1, fill = diagnosis == 1)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  labs(
    x = "Dietary fibre",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#5EB1BF", "#C24343")
  )
```

#### PUFAs

```{R}
demo %>%
  ggplot(aes(x = PUFAg, color = diagnosis == 1, fill = diagnosis == 1)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  labs(
    x = "PUFAs",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#5EB1BF", "#C24343")
  )
```

### Medication use

#### Current IBD medication

From REDCAP

```{R}
drugs <- data.frame(ParticipantNo = demo$ParticipantNo)

drugs$ASA <- FALSE
drugs$imm <- FALSE
drugs$bio <- FALSE
drugs$category <- NA

redcap <- redcap %>% mutate(curr_on_mesa = ifelse(is.na(curr_on_mesa),
                                                  0,
                                                  curr_on_mesa),
                            curr_on_aza = ifelse(is.na(curr_on_aza),
                                                 0,
                                                 curr_on_aza),
                            curr_on_merc = ifelse(is.na(curr_on_merc),
                                                 0,
                                                 curr_on_merc),
                            curr_on_metho = ifelse(is.na(curr_on_metho),
                                                 0,
                                                 curr_on_metho),
                            curr_on_ciclo = ifelse(is.na(curr_on_ciclo),
                                                 0,
                                                 curr_on_ciclo),
                            curr_on_inflix = ifelse(is.na(curr_on_inflix),
                                                 0,
                                                 curr_on_inflix),
                            curr_on_ada = ifelse(is.na(curr_on_ada),
                                                 0,
                                                 curr_on_ada),
                            curr_on_goli = ifelse(is.na(curr_on_goli),
                                                 0,
                                                 curr_on_goli),
                            curr_on_vedo = ifelse(is.na(curr_on_vedo),
                                                 0,
                                                 curr_on_vedo),
                            curr_on_goli = ifelse(is.na(curr_on_goli),
                                                 0,
                                                 curr_on_goli),
                            curr_on_ust = ifelse(is.na(curr_on_ust),
                                                 0,
                                                 curr_on_ust)
                            )


for (i in 1:nrow(drugs)){
  
  if (drugs[i, "ParticipantNo"] %in% redcap$participantno) {
    
    
    subject.data <- subset(redcap, participantno == drugs[i, "ParticipantNo"])[1,]
      if (subject.data$curr_on_mesa == 1) drugs[i, "ASA"] <- TRUE
    
    # Immunosuppressants
    if (subject.data$curr_on_aza == 1 |
        subject.data$curr_on_merc == 1 | 
        subject.data$curr_on_metho == 1 |
        subject.data$curr_on_ciclo == 1) {
      drugs[i, "imm"] <- TRUE
    }
    
    # Biologics
    if (subject.data$curr_on_inflix == 1 |
        subject.data$curr_on_ada == 1 | 
        subject.data$curr_on_goli == 1 |
        subject.data$curr_on_vedo == 1 |
        subject.data$curr_on_ust == 1) {
      drugs[i, "bio"] <- TRUE
    }
    if (drugs[i, "imm"] &  drugs[i, "bio"]) {
      drugs[i, "category"] <- 4
    } else if (drugs[i, "imm"]) {
      drugs[i, "category"] <- 2
    } else if (drugs[i, "bio"]) {
      drugs[i, "category"] <- 3
    } else if (drugs[i,"ASA"]) {
      drugs[i, "category"] <- 1
    }
  }
}

drugs$category <- factor(drugs$category,
                         levels = 1:4,
                         labels = c("5ASA",
                                    "Mono immunotherapy",
                                    "Mono biologic",
                                    "Combo therapy"))

drugs <- merge(drugs, demo[, c("ParticipantNo", "cat")], by = "ParticipantNo")
colnames(drugs)[5] <- "Treatment"


plt.cols <- c("#52528C", "#DD6E42", "#048A81", "#C585B3")

ggplot(drugs, aes(x = Treatment, fill = Treatment, color = Treatment)) +
  geom_bar() +
  theme_minimal() +
  ylab("Frequnecy") +
  scale_fill_manual(values = plt.cols) +
  scale_colour_manual(values = colorspace::darken(plt.cols, 0.3)) 
```

```{R}
pander(chisq.test(drugs$Treatment , drugs$cat))
```

#### Antibiotics

Patient reported. 

```{R}
meds <- read_xlsx(paste0(data.path, "Baseline2022/medicines.xlsx"))
drugs <- merge(drugs,
               meds[, c("ParticipantNo", "Antibiotics6Mths")],
               by = "ParticipantNo",
               all.x = TRUE,
               all.y = FALSE)
drugs$Antibiotics6Mths <- factor(drugs$Antibiotics6Mths, c(1,2), c("Yes", "No"))
colnames(drugs)[7] <- "Antibiotic use in 6 months"

plt.cols <- c("#FE5F55", "#004E89")

ggplot(drugs, aes(x = `Antibiotic use in 6 months`, 
                  color = `Antibiotic use in 6 months`,
                  fill = `Antibiotic use in 6 months`)) +
  geom_bar() +
  theme_minimal() +
  xlab("Antibiotic use in the previous six months") +
  ylab("Frequency") + theme(legend.position = "none") +
  scale_fill_manual(values = plt.cols) +
  scale_colour_manual(values = colorspace::darken(plt.cols, 0.5)) 
```

```{R}
pander(chisq.test(drugs$`Antibiotic use in 6 months`, drugs$cat))
```

#### Table

```{R}
table1(~ Treatment + `Antibiotic use in 6 months` | cat,
       drugs)
```


### Flowchart

The below flowchart gives a simple explanation of how the sub-cohort of subjects
with analysed food frequency questionnaires (FFQs) was obtained. 

```{R}
#|fig-align: center
#|
#| resresults: "hold"
flow <- grViz(paste0("digraph flowchart {

graph[splines = ortho]
  # node definitions with substituted label text
  node [fontname = Helvetica, shape = rectangle, fixedsize = false, width = 1]
  1 [label = 'Recruited to PREdiCCt\n n = 2629']
  2 [label = 'Baseline FC available\n n = 2144']
  3 [label = 'Food frequency questionnaire\n analysed\n n = ",nrow(FFQ),"']

  node [shape=none, width=0, height=0, label='']
  1 -> 2; 2-> 3
}"))
htmltools::HTML(export_svg(flow))
```

### Table of baseline data by IBD type

The below table summarises the data presented thus far in a demographics table
stratified by IBD type.

```{R}
#| label: tbl-tab1
#| tbl-cap: "Baseline data by IBD type"
demo$BMI <- with(demo, Weight / ((Height / 100)^2))



my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}



table1::table1(~ Age + Sex + Ethnicity + `IBD Duration` + BMI + FC + Biologic | diagnosis2,
  data = demo[,c(-16,-17)],
  render.continuous = my.render.cont
)
```

### Table of baseline data by FC groups

Instead of stratifying by IBD type, this table instead stratifies by FC groups


```{R}
#| label: tbl-tab2
#| tbl-cap: "Baseline data by FCAL"
demo.fcal <- subset(demo, !is.na(FC))

table1(~ Age + Sex + Ethnicity + diagnosis2 + `IBD Duration` + BMI + FC + Biologic | cat,
  data = demo.fcal,
  render.continuous = my.render.cont
)
```

```{R}
smoking <- read_xlsx(paste0(data.path, "Baseline2022/lifestyle.xlsx")) %>%
  select(ParticipantNo, Smoke, SmokedInPast)
smoking$Smoke <- plyr::mapvalues(smoking$Smoke, from = 2, to = 3)

for (i in 1:nrow(smoking)) {
  if ((!is.na(smoking[i, "SmokedInPast"] == 1) & smoking[i, "SmokedInPast"] == 1) & (!is.na(smoking[i, "Smoke"]) & smoking[i, "Smoke"] == 3)){
    smoking[i, "Smoke"] <- 2
  }
}

smoking$Smoke <- factor(smoking$Smoke,
                        levels = seq(1,3),
                        labels = c("Current", "Previous", "Never"))

smoking <- smoking[,-3]


demo.fcal <- merge(demo.fcal,
                 smoking,
                 by = "ParticipantNo",
                 all.x = TRUE,
                 all.y = FALSE)
```


```{R}
esmoking <- read_xlsx(paste0(data.path, "Baseline2022/lifestyle.xlsx")) %>%
  select(ParticipantNo, ECigs, ECigsPast)
esmoking$ECigs <- plyr::mapvalues(esmoking$ECigs, from = 2, to = 3)

for (i in 1:nrow(esmoking)) {
  if ((!is.na(esmoking[i, "ECigsPast"] == 1) & esmoking[i, "ECigsPast"] == 1) & (!is.na(esmoking[i, "ECigs"]) & esmoking[i, "ECigs"] == 3)){
    esmoking[i, "ECigs"] <- 2
  }
}

esmoking$ECigs <- factor(esmoking$ECigs,
                        levels = seq(1,3),
                        labels = c("Current", "Previous", "Never"))

esmoking <- esmoking[,-3]


demo.fcal <- merge(demo.fcal,
                 esmoking,
                 by = "ParticipantNo",
                 all.x = TRUE,
                 all.y = FALSE)
```

## Variables only relevant to Crohn's disease subjects

This section looks at data only applicable to subjects with CD. The following 
variables are considered: surgery, Montreal location, and Montreal behaviour.
As PREdiCCt required subjects to be able to flare, this effectively excluded UC
subjects who had undergone a proctocolectomy. 

### Surgery

Surgical data has been obtained from both REDCap and patient-completed
questionnaires. Where data was available from both data sources, REDCap was
the preferred data source. 

```{R}
predicct.surgery <- read_xlsx(paste0(
  data.path,
  "Baseline2022/IBD.xlsx"
))[, c("ParticipantNo", "HadSurgeryForIBD")]
colnames(predicct.surgery)[2] <- "Surgery"


redcap.surgery <- redcap[, c("participantno", "surgery")]


names(redcap.surgery) <- c("ParticipantNo", "Surgery")

surgery <- rbind(redcap.surgery, predicct.surgery)
surgery <- subset(surgery, !is.na(surgery$Surgery))

# As REDCap is first, this will be prioritised over subject (if not NA)
surgery <- distinct(surgery, ParticipantNo, .keep_all = TRUE)

demo.cd <- subset(demo.fcal, diagnosis2 == "CD")
demo.cd <- merge(demo.cd, surgery, all.x = TRUE, all.y = FALSE)
demo.cd$Surgery <- factor(demo.cd$Surgery,
  levels = c(1, 2),
  labels = c("Yes", "No")
)

ggplot(demo.cd, aes(x = Surgery, fill = Surgery, color = Surgery)) +
  geom_bar() +
  xlab("Previous surgery") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#F9B9B7", "#96C9DC"), na.value = "#5E5759") +
  scale_color_manual(values = c("#D06965", "#448CA2"), na.value = "#2E282A")

```

FCAL at study recruitment is significantly associated with having previously
undergone surgery for CD.

```{R}
pander(chisq.test(demo.cd$Surgery, demo.cd$cat))
```

### Montreal location

```{R}
mapping <- data.frame(
  code = seq(1, 6),
  definition = c(
    "Oesophago-gastric",
    "Duodenal",
    "Jejunal",
    "Ileal",
    "Colonic",
    "Rectal"
  ))

cd.location <- redcap[, c("participantno", paste0("mac_extent___", 1:6))] 
L4 <- rep(0, nrow(cd.location))
Location <- rep(NA, nrow(cd.location))

for (i in 1:nrow(cd.location)) {
  if (any(cd.location[i, 2:4] == 1)) L4[i] <- 1
  if (cd.location[i, 5] == 1  &  cd.location[i, 6] == 1) {
    Location[i] <- 3
  } else if (cd.location[i, 5] == 1  &  cd.location[i, 6] == 0) {
    Location[i] <- 1
  } else if (cd.location[i, 5] == 0  &  cd.location[i, 6] == 1) {
    Location[i] <- 2
  }
  if (is.na(Location[i]) & L4[i] == 1) {
    Location[i] <- 4 # L4 Only
  }
  
}

L4[is.na(Location) & L4 == 0] <- NA

mont.df <- data.frame(cd.location[, "participantno"],
                      Location,
                      L4)
colnames(mont.df)[1] <- "ParticipantNo"
demo.cd <- merge(demo.cd, mont.df,
                 by = "ParticipantNo",
                 all.x = TRUE,
                 all.y = FALSE)
```

Montreal location has been obtained from REDcap data. Rather than being asked
for Montreal location directly, clinical teams were asked to provide more
granular detail by ticking boxes if inflammation was in any of the following
areas `r mapping$definition`. If only any of the first 3 were reported then
the subject was assigned "L4 only". L1-L3 were assigned as per convention. If
no location was reported at all then location was assigned `NA`. 

As can be seen, L3 is the most common Montreal location in this cohort with 
roughly an equal amount of subjects having either L1 or L2. 

```{R}
demo.cd$Location <- factor(demo.cd$Location,
  levels = c(1, 2, 3, 4),
  labels = c("L1", "L2", "L3", "L4 only")
)

ggplot(demo.cd, aes(x = Location, fill = Location, color = Location)) +
  geom_bar() +
  xlab("Montreal location") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#33CA7F", "#96C9DC", "#C33C54", "#FCB97D")) +
  scale_color_manual(values = c("#318859", "#448CA2", "#80333E", "#BD7700")) +
  guides(fill = guide_legend(title = "Montreal location"),
         color = guide_legend(title = "Montreal location"))
```

Due to the low number of subjects with L4-only, Fisher's exact test has been
used to compare with FC.  

```{R}
pander(fisher.test(demo.cd$Location , demo.cd$cat, workspace = 200000 * 100))
```

In addition to L4 only being considered, we also investigate L4 as a modifier. 

```{R}
demo.cd$L4 <- factor(demo.cd$L4,
  levels = c(0, 1),
  labels = c("Not present", "Present")
)

ggplot(demo.cd, aes(x = L4, fill = L4, color = L4)) +
  geom_bar() +
  xlab("Presence of L4") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#51E5FF", "#EC368D")) +
  scale_color_manual(values = c("#079DB1", "#AF0863")) +
  guides(fill = guide_legend(title = "Presence of L4"),
         color = guide_legend(title = "Presence of L4"))
```

```{R}
pander(chisq.test(demo.cd$L4 , demo.cd$cat))
```

### Montreal behaviour

Montreal behaviour has been obtained from REDCap data and was recorded
conventionally. 

```{R}
cd.behaviour <- redcap[, c("participantno", "behaviour", "perianal")] 
colnames(cd.behaviour) <- c("ParticipantNo", "Behaviour", "Perianal")
cd.behaviour$Perianal[!is.na(cd.behaviour$Perianal) & cd.behaviour$Perianal == 3] <- NA


demo.cd <- merge(demo.cd,
                 cd.behaviour,
                 by = "ParticipantNo",
                 all.x = TRUE,
                 all.y = FALSE)
```

As should be expected, the majority of CD subjects have B1.

```{R}
demo.cd$Behaviour <- factor(demo.cd$Behaviour,
  levels = c(1, 2, 3),
  labels = c("B1", "B2", "B3")
)

ggplot(demo.cd, aes(x = Behaviour, fill = Behaviour, color = Behaviour)) +
  geom_bar() +
  xlab("Montreal behaviour") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#7AE7C7", "#440381", "#D64045")) +
  scale_color_manual(values = c("#07A282", "#340165", "#942E31")) +
  guides(fill = guide_legend(title = "Montreal behaviour"),
         color = guide_legend(title = "Montreal behaviour"))
```

Montreal behaviour is not significantly associated with FCAL at recruitment.

```{R}
pander(chisq.test(demo.cd$Behaviour , demo.cd$cat))
```

Around a third of CD subjects are reported to have perianal disease

```{R}
demo.cd$Perianal <- factor(demo.cd$Perianal,
  levels = c(1, 2),
  labels = c("Yes", "No")
)

ggplot(demo.cd, aes(x = Perianal, fill = Perianal, color = Perianal)) +
  geom_bar() +
  xlab("Perianal disease") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#023C40", "#AF5B5B")) +
  scale_color_manual(values = c("#002C30", "#754242")) +
  guides(fill = guide_legend(title = "Perianal disease"),
         color = guide_legend(title = "Perianal disease"))
```

Perianal disease is not associated with FCAL at recruitment. 

```{R}
pander(chisq.test(demo.cd$Perianal , demo.cd$cat))
```

### Smoking

We will consider smoking for CD and UC separately as smoking is often reported
to worsen outcomes in CD but be protective in UC. 

```{R}
ggplot(demo.cd, aes(x = Smoke, fill = Smoke, color = Smoke)) +
  geom_bar() +
  xlab("Smoking status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#4E0250", "#517664", "#1C448E")) +
  scale_color_manual(values = c("#3D003F", "#385245", "#033070")) +
  guides(fill = guide_legend(title = "Smoking status"),
         color = guide_legend(title = "Smoking status"))
```

```{R}
pander(chisq.test(demo.cd$Smoke , demo.cd$cat))
```

### E-cigarette use

```{R}
ggplot(demo.cd, aes(x = ECigs, fill = ECigs, color = ECigs)) +
  geom_bar() +
  xlab("E-cigarette status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#4E0250", "#517664", "#1C448E")) +
  scale_color_manual(values = c("#3D003F", "#385245", "#033070")) +
  guides(fill = guide_legend(title = "E-cigarette status"),
         color = guide_legend(title = "E-cigarette status"))
```

```{R}
pander(chisq.test(demo.cd$ECigs , demo.cd$cat))
```

### Table of CD variables

```{R}
table1(~ Location + L4 + Behaviour + Perianal + Surgery + Smoke + ECigs | cat,
       data = demo.cd)
```

## Variables only relevant to UC/IBDU subjects

This section looks at variables only relevant to UC/IBDU subjects (Montreal 
severity is not available.)

### Montreal extent

Montreal extent has been obtained from REDCap. 

Similar to Montreal location, the extent of inflammation has been reported 
in more granular detail than the Montreal classification. The below table 
shows how these definitions have been mapped to Montreal extent. 

```{R}
mapping <- data.frame(
  code = seq(1, 6),
  definition = c(
    "Rectum",
    "Recto-sigmoid",
    "< Splenic",
    "< Hepatic",
    "Total",
    "Unknown"
  ),
  mont = c(1, 2, 2, 3, 3, NA)
)
kable(mapping,
  col.names = c("Coding", "Definition", "Montreal extent"),
  align = c("l", "c", "c")
)
```

E2 is the most common Montreal extent classification.

```{R}
demo.uc <- subset(demo.fcal, diagnosis2 == "UC/IBDU")
redcap.uc <- subset(redcap, participantno %in% demo.uc$ParticipantNo)
names(redcap.uc)[names(redcap.uc) == "participantno"] <- "ParticipantNo"
redcap.uc <- redcap.uc[, c("ParticipantNo", "max_extent")]
redcap.uc$Extent <- mapvalues(redcap.uc$max_extent,
  from = mapping$code,
  to = mapping$mont
)

demo.uc <- merge(demo.uc,
  redcap.uc[, c("ParticipantNo", "Extent")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
demo.uc$Extent <- factor(demo.uc$Extent,
  levels = seq(1, 3),
  labels = c("E1", "E2", "E3")
)


ggplot(demo.uc, aes(x = Extent, fill = Extent, color = Extent)) +
  geom_bar() +
  xlab("Montreal extent") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#7AE7C7", "#440381", "#D64045")) +
  scale_color_manual(values = c("#07A282", "#340165", "#942E31")) +
  guides(fill = guide_legend(title = "Montreal extent"),
         color = guide_legend(title = "Montreal extent"))
```

Montreal extent is not associated with FC

```{R}
pander(chisq.test(demo.uc$Extent, demo.uc$cat))
```

### Smoking

```{R}
ggplot(demo.uc, aes(x = Smoke, fill = Smoke, color = Smoke)) +
  geom_bar() +
  xlab("Smoking status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#4E0250", "#517664", "#1C448E")) +
  scale_color_manual(values = c("#3D003F", "#385245", "#033070")) +
  guides(fill = guide_legend(title = "Smoking status"),
         color = guide_legend(title = "Smoking status"))
```

```{R}
pander(chisq.test(demo.uc$Smoke , demo.uc$cat))
```

### E-cigarette use

```{R}
ggplot(demo.uc, aes(x = ECigs, fill = ECigs, color = ECigs)) +
  geom_bar() +
  xlab("E-cigarette status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#4E0250", "#517664", "#1C448E")) +
  scale_color_manual(values = c("#3D003F", "#385245", "#033070")) +
  guides(fill = guide_legend(title = "E-cigarette status"),
         color = guide_legend(title = "E-cigarette status"))
```

```{R}
pander(fisher.test(demo.uc$ECigs, demo.uc$cat))
```

### Table of UC variables

```{R}
table1(~ Extent + Smoke + ECigs | cat, data = demo.uc)
```


```{R}
saveRDS(demo.fcal, paste0(outdir, "demo.RDS"))
```

## Reuse {.appendix}

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.
 
## {.appendix}

<div>
  <img class = "center" style="padding-left:200px" src="../images/PREdiCCtlogo.png" alt=" The PREdiCCt study logo" height = 200px> <br>
  <img style="padding-right:25px;padding-left:115px" src="../images/cgem-logo.png" alt="Centre for Genomic & Experimental Medicine logo" height = 50px>
  <img class = "center" src="../images/MRC_HGU_Edinburgh RGB.png" alt="MRC Human Genetics Unit logo" height = 50px>
</div>

---

## Session info {.appendix}

```{R Session info}
pander::pander(sessionInfo())
```

---
title: "Baseline PREdiCCt data"
author:
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
  - name: "Chiara Cotronei"
    url: https://www.research.ed.ac.uk/en/persons/chiara-cotronei
    affiliations:
      - ref: Lothian
bibliography: Baseline.bib   
---

## Introduction 

```{R}
set.seed(123)

##############
## Packages ##
##############

library(plyr) # Used for mapping values
suppressPackageStartupMessages(library(tidyverse)) # ggplot2, dplyr, and magrittr
library(readxl) # Read in Excel files
library(lubridate) # Handle dates
library(datefixR) # Standardise dates
library(patchwork) # Arrange ggplots

# Generate tables
suppressPackageStartupMessages(library(table1))
library(knitr)
library(pander)

# Generate flowchart of cohort derivation
library(DiagrammeR)
library(DiagrammeRsvg)

# paths to PREdiCCt data
if (file.exists("/docker")) { # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed"
} else { # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
}


theme_light <- function() {
  theme_minimal(base_size = 11) %+%
    theme(
      panel.border = element_blank(),
      panel.grid.major.y = element_line(color = "gray"),
      panel.grid.minor.y = element_line(color = "gray"),
      panel.grid.major.x = element_line(color = "gray"),
      panel.grid.minor.x = element_line(color = "gray"),
      text = element_text(colour = "black"),
      axis.text = element_text(colour = "black"),
      rect = element_rect(colour = "white", fill = "black"),
      plot.background = element_rect(fill = "white", colour = NA),
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(colour = "black")
    )
}


theme_dark <- function() {
  theme_minimal(base_size = 11) %+%
    theme(
      panel.border = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      text = element_text(colour = "white"),
      axis.text = element_text(colour = "white"),
      rect = element_rect(colour = "#222222", fill = "#222222"),
      plot.background = element_rect(fill = "#222222", colour = NA),
      axis.line = element_line(colour = "white"),
      axis.ticks = element_line(colour = "white")
    )
}

darksvglite <- function(file, width, height) {
  on.exit(reset_theme_settings())
  theme_set(theme_dark())
  ggsave(
    filename = file,
    width = width,
    height = height,
    dev = "svg",
    bg = "transparent"
  )
}

# theme_set(theme_light())
```

This report explores the baseline data for the PREdiCCt study, generating
inferences and producing display items for publication.

There are three main data sources for baseline demographic and phenotypic data
in PREdiCCt: 

1. Participant questionnaires.
1. Forms completed by a subject's clinical team (via REDCap) during recruitment.
1. Data collected retrospectively during the end-of-study (EoS) phenotyping
   which was completed by a member of the subject's IBD care team.

As this report uses all three, it will be made clear which source the data
presented originate from. 

A docker image, [nathansam/predicct](#future-link), has been used to ensure this 
analysis remains reproducible.

## Variables relevant to all subjects

```{R}
# Demographic data as reported by subjects
demo <- read_xlsx(paste0(data.path, "Baseline2022/demographics.xlsx"),
  col_types = c(
    "text",
    "text",
    "text",
    "text",
    "numeric",
    "numeric",
    "text",
    "text",
    "date",
    "numeric",
    "text"
  )
)
```

Only variables relevant to all subjects will be considered in this section.
Later sections examine
[variables only relevant to CD subjects](#variables-only-relevant-to-crohns-disease-subjects) and
[variables only relevant to UC/IBDU subjects](#variables-only-relevant-to-ulcerative-colitisibdu-subjects).

### Month of recruitment

There is potential for seasonality to confound interpretations of our results,
particularly when making inferences regarding diet. As such,
month of recruitment is explored ([@fig-month]).

Recruitment was low in December, which is to be as expected as there are
typically fewer clinic appointments in December and participants were recruited
in IBD clinics.

However, recruitment was also low in April and July. As such, the impact of
seasonality is likely to be minimal for this cohort and will be ignored for all
analyses. 

```{R}
#| label: fig-month
#| fig-cap: "Distribution of month of diagnosis."
demo$entry_date <- as.Date(demo$entry_date)
demo$month <- month(demo$entry_date, label = TRUE)
ggplot(demo, aes(x = as.factor(month), color = as.factor(month), fill = as.factor(month))) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  xlab("Month of recruitment") +
  ylab("Frequency")
```


### Country of recruitment

PREdiCCt is a pan-UK study which recruited across
`r length(unique(demo$SiteName))` sites. @fig-country shows the distribution of
the PREdiCCt cohort by country of the recruiting site. 

```{R}
#| label: fig-country
#| fig-cap: "Distribution of the PREdiCCt cohort by country of recruitment site."
site.data <- read.csv(paste0("/Volumes/igmm/cvallejo-predicct/predicct/",
                             "metadata/sites.csv"))
sites <- demo %>%
  select(ParticipantNo, SiteNo)
sites <- merge(sites, site.data, by = "SiteNo", all.x = TRUE, all.y = FALSE)

plt.cols <- c( "#003459", "#DB5461", "#41D3BD", "#F09D51")

sites$Country <- factor(sites$Country,
                        levels = c("Scotland",
                                   "England",
                                   "Wales",
                                   "Northern Ireland"))


sites %>%
  ggplot(aes(x = Country, color = Country, fill = Country)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  xlab("Country of recruiting site") +
  ylab("Frequency") +
  scale_fill_manual(values = plt.cols) +
  scale_color_manual(values = colorspace::darken(plt.cols, 0.2))
```

### Faecal calprotectin at study recruitment

```{R}
fcal <- read_xlsx(paste0(data.path, "Baseline2022/calprotectin.xlsx"))
fcal$Result <- as.numeric(plyr::mapvalues(fcal$Result, from = "<20", to = 20))

fcal <- fcal[, c("ParticipantNo", "Result")]

fcal.eof <- read_xlsx(paste0(prefix, "EOF_fcal.xlsx"))

fcal.eof <- subset(fcal.eof, IsBaseline == 1)
fcal.eof <- subset(fcal.eof, FCALLevel != ".")
fcal.eof$FCALLevel <- as.numeric(fcal.eof$FCALLevel)
fcal.eof <- fcal.eof[, c("ParticipantNo", "FCALLevel")]
names(fcal.eof)[2] <- "Result"

fcal <- rbind(fcal, fcal.eof)
fcal <- distinct(fcal, ParticipantNo, .keep_all = TRUE)
```

For faecal calprotectin (FC), data from both study recruitment and EoS
phenotyping have been used. Data from the latter was only used if no data
were available from recruitment. It should be noted that as the EoS FC tests
were performed at local sites, it is unlikely the same assay was used across
all subjects and there may be between-site variation in reported FC values
[@Whitehead_2012]. Tests reported at recruitment were all performed
using the same assay at the Western General Hospital. 

Plotting the distribution of baseline FC shows one subject has been reported
to have significantly elevated FC. As we later discretise FC into three groups,
this observation has not been removed. 

```{R}
#| label: fig-fc-recruit
#| fig-cap: "Distribution of FC at diagnosis."
fcal %>%
  ggplot(aes(x = Result)) +
  geom_histogram(bins = 60, fill = "#00A6ED", color = "#003459") +
  theme_minimal() +
  xlab("Baseline FC") +
  ylab("Frequency")
```

FC has been grouped into intervals of $FC < 50$, $50 \leq FC \leq 250$, and
$FC > 250$. Associations for all following variables will be reported using
these FC groups. 

```{R}
#| label: fig-fc-group
#| fig-cap: "Distribution of FC groupings."
fcal$cat <- 0
for (i in 1:nrow(fcal)) {
  if (fcal[i, "Result"] < 50) fcal[i, "cat"] <- 1
  if ((fcal[i, "Result"] >= 50) & (fcal[i, "Result"] <= 250)) fcal[i, "cat"] <- 2
  if (fcal[i, "Result"] > 250) fcal[i, "cat"] <- 3
}


demo <- merge(demo, fcal[, c("ParticipantNo", "Result", "cat")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

demo$cat <- factor(demo$cat,
  levels = c(1, 2, 3),
  labels = c("FC < 50", "FC 50-250", "FC > 250")
)

names(demo)[13] <- "FC"

ggplot(demo, aes(x = cat, fill = cat, color = cat)) +
  geom_bar() +
  ylab("Frequency") +
  xlab("FC category") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#508484", "#FCAA67", "#EB5160"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#355C5C", "#B96E03", "#B12537"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "FC category"),
    color = guide_legend(title = "FC category")
  )
```

`r sum(is.na(demo$cat))` subjects do not have an FC available for when they
joined PREdiCCt. Moving forward, we will only consider subjects with a baseline
FC available as this is the primary analysis cohort.  

### Sex

Sex was self-reported via subject questionnaires. As can be seen in
@fig-sex-dist, the PREdiCCt cohort is female by majority. 

```{R}
#| label: fig-sex-dist
#| fig-cap: "Distribution of sex in the FC cohort."
demo$Sex <- factor(demo$Sex, levels = c("1", "2"), labels = c("Male", "Female"))

demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = Sex, fill = Sex, color = Sex)) +
  geom_bar() +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#FCA17D", "#60D394")) +
  scale_color_manual(values = c("#B22A21", "#034C3C"))
``` 

Moreover, the distribution of sex is significantly different between FCAL groups. 

```{R}
#| label: tbl-sex-fc
#| tbl-cap: "Chi-squared test between Sex and FC groups."
pander(chisq.test(demo$Sex, demo$cat))
```

### BMI

Body mass index is given by weight (in $Kg$) divided by height (in $M$) squared.

As threshold differ in the paediatric population, differing by age and sex, BMI
has not been calculated for those less than 18 years of age. BMI is first
considered as a continuous variable. 

```{R}
#| label: fig-BMI-dist
#| fig-cap: "Distribution of BMI in the FC cohort."
#| warning: false
demo$BMI <- with(demo, Weight / ((Height / 100)^2))
demo[demo[, "age"] < 18, "BMI"] <- NA
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = BMI)) +
  geom_histogram(color = "#AD013B", fill = "#F0386B", bins = 30) +
  theme_minimal() +
  ylab("Frequency")
```


BMI as a continuous variable is not associated with FC groups. 

```{R}
#| label: tbl-BMI-fc
#| tbl-cap: "Fisher's exact test between BMI and FC groups."
pander(summary(aov(BMI ~ cat, data = demo)))
```

We also consider BMI grouped into underweight, normal, overweight, and obese
categories using the definitions used by the NIH and WHO
[@weirBMIClassificationPercentile2024]. 

A cut-off of $30 KgM^{-2}$ is used to denote obesity in adults without
Asian/South Asian backgrounds. As data on Asian and South Asian ethnicity is not
available (See [Ethnicity](#ethnicity)), we are unable to adjust the threshold
based on ethnicity. However, this is expected to be relevant to relatively few
subjects.

```{R}
#| label: fig-BMIcat-dist
#| fig-cap: "Distribution of BMI categories in the FC cohort."
demo$BMIcat <- cut(demo$BMI,
  c(0, 18.5, 25, 30, Inf),
  include.lowest = TRUE,
  right = FALSE,
  labels = c("Underweight", "Normal", "Overweight", "Obese")
)
demo[demo[, "age"] < 18, "BMIcat"] <- NA

plt.cols <- c("#F6AE2D", "#C81D25", "#1481BA", "#7E1F86")


demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = BMIcat, color = BMIcat, fill = BMIcat)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = plt.cols, na.value = "#032B43") +
  scale_color_manual(
    values = colorspace::darken(plt.cols, 0.2),
    na.value = "#032B43"
  ) +
  xlab("BMI category") +
  ylab("Frequency")
```

BMI by category is not associated with FC groups. 

```{R}
#| label: tbl-BMIcat-fc
#| tbl-cap: "Chi-squared test between BMI categories and FC groups."
pander(chisq.test(demo$BMIcat, demo$cat))
```


### IBD type

For this study, we have grouped ulcerative colitis (UC) and inflammatory bowel
disease unclassified (IBDU) into one category. 
IBD type is self-reported.

Whilst PREdiCCt was designed to recruit an equal number of CD and UC/IBDU
subjects, the COVID-19 pandemic halted recruitment which has resulted in there
not being an equal balance of CD and UC/IBDU subjects.There are slightly more
Crohn's disease (CD) than UC/IBDU subjects in the FC cohort.

```{R}
#| label: fig-IBD-dist
#| fig-cap: "Distribution of IBD type in the FC cohort."
demo$diagnosis2 <- plyr::mapvalues(demo$diagnosis,
  from = seq(1, 4),
  to = c(1, 2, 2, 2)
) %>%
  factor(levels = c("1", "2"), labels = c("CD", "UC/IBDU"))

demo$diagnosis <- plyr::mapvalues(demo$diagnosis,
  from = seq(1, 4),
  to = c(1, 2, 3, 3)
) %>%
  factor(levels = c("1", "2", "3"), labels = c("CD", "UC", "IBDU"))


demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = diagnosis2, fill = diagnosis2, color = diagnosis2)) +
  geom_bar() +
  ylab("Frequency") +
  xlab("IBD type") +
  theme_minimal() +
  scale_fill_manual(values = c("#2B2D42", "#92DCE5")) +
  scale_color_manual(values = c("#1E203A", "#1D9BA5")) +
  guides(
    fill = guide_legend(title = "IBD type"),
    color = guide_legend(title = "IBD type")
  )
```

IBD type is significantly associated with FC at recruitment. 

```{R}
#| label: tbl-IBD-fc
#| tbl-cap: "Chi-squared test between IBD type and FC groups."
pander(chisq.test(demo$diagnosis2, demo$cat))
```

###  Disease duration

Disease duration has been calculated by subtracting reported date of
diagnosis from the date of entry into PREdiCCt. Date of diagnosis has been
obtained via REDcap. Where only year was available, 
the [datefixR R package](https://docs.ropensci.org/datefixR/) was used to impute
the middle of the year. Any disease durations reported to be negative using this
method were mapped to 0. 

```{R}
#| warning: false
#| label: fig-duration-hist
#| fig-caption: "Distribution of disease duration at study recruitment stratified by IBD type."
redcap <- read_xlsx(paste0(redcap.path, "redcap_clean.xlsx"))
redcap <- distinct(redcap, participantno, .keep_all = TRUE)

diag.date <- redcap[, c("participantno", "date_diag")]
colnames(diag.date)[1] <- "ParticipantNo"
diag.date <- subset(diag.date, (!is.na(date_diag)) &
  (!is.null(date_diag)) &
  date_diag != "")
duration <- merge(diag.date,
  demo,
  by = "ParticipantNo",
  all.x = FALSE,
  all.y = TRUE
)
duration <- distinct(duration, ParticipantNo, .keep_all = TRUE)

duration <- subset(duration, tolower(date_diag) != "unknown")
duration[duration[, "date_diag"] == "16/032016", "date_diag"] <- "16/03/2016"
duration[duration[, "date_diag"] == "19/04/2017P", "date_diag"] <- "19/04/2017"
duration[duration[, "date_diag"] == "2007 APPROX", "date_diag"] <- "2007"
duration[duration[, "date_diag"] == "approx 1988", "date_diag"] <- "1988"
duration[duration[, "date_diag"] == "?2014", "date_diag"] <- "2014"

duration <- fix_date_df(duration, c("entry_date", "date_diag"))

duration$duration <- as.numeric(with(
  duration,
  (entry_date - date_diag) / 365.25
))

duration[duration[, "duration"] < 0, "duration"] <- 0


duration.cd <- subset(duration, diagnosis == "1")

duration.uc <- subset(duration, diagnosis != "1")


duration %>%
  drop_na(duration) %>%
  ggplot(aes(x = duration, color = diagnosis2, fill = diagnosis2)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  labs(
    x = "Duration (years)",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    values = c("#5EB1BF", "#C24343")
  )
```

Whilst a  low p-value was observed, disease duration was not significantly
different between FC groups.

```{R}
#| label: tbl-duration-fc
#| tbl-cap: "ANOVA between IBD disease duration and FC groups."
demo <- merge(demo, duration[, c("ParticipantNo", "duration")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

names(demo)[18] <- "IBD Duration"
pander(summary(aov(`IBD Duration` ~ cat, data = demo)))
```

### Ethnicity

Due to low counts for non-white ethnicities, we are only able to report
frequencies of white and non-white ethnicities. 

```{R}
#| label: fig-ethnic-dist
#| fig-cap: "Distribution of ethnicity in the FC cohort."
demo$ethnic_gp <- factor(demo$ethnic_gp,
  levels = c("1", "2"),
  labels = c("White", "Non-white")
)
colnames(demo)[10:11] <- c("Age", "Ethnicity")


demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = Ethnicity, fill = Ethnicity, color = Ethnicity)) +
  geom_bar() +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#F24236", "#2E86AB"), na.value = "#032B43") +
  scale_color_manual(values = c("#C0362C", "#1E556C"), na.value = "#032B43")
```

```{R}
#| label: tbl-ethnicity-fc
#| tbl-cap: "Chi-squared test between ethnicity and FC groups."
pander(chisq.test(demo$Ethnicity, demo$cat))
```

### Index of multiple deprivation

The PREdiCCt SAP states the primary analyses will be controlled for by index
of multiple deprivation (IMD). However, the PREdiCCt study recruited across the
UK and there is no consistent measure of IMD across the UK. Instead IMD measures
are specific to constituent nations.  

```{R}
#| label: fig-imd-dist
#| fig-cap: "Distribution of IMD."
#| warning: false

IMD <- read_xlsx(paste0(
  "/Volumes/igmm/cvallejo-predicct/predicct/",
  "final/20231030/IMD.xlsx"
))
IMD <- as.data.frame(IMD)
names(IMD)[2] <- "IMD"
demo <- merge(demo, IMD, by = "ParticipantNo", all.x = TRUE, all.y = FALSE)
demo$IMD <- as.factor(demo$IMD)

cols <- c("#A8F9FF", "#EF8275", "#6D326D", "#0B6E4F", "#F4D35E")

demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = IMD, color = as.factor(IMD), fill = as.factor(IMD))) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  ylab("Frequency") +
  xlab("IMD (most deprived to least deprived)") +
  scale_fill_manual(values = cols) +
  scale_color_manual(values = colorspace::darken(cols, amount = 0.3))
```

```{R}
#| label: tbl-IMD-fc
#| tbl-cap: "CHI-squared test between IMD and FC groups."
pander(chisq.test(demo$IMD, demo$cat))
```

### IBD Control

```{R}
#| label: control-8-dist
#| fig-cap: "Distribution of Control-8 scores (least to most controlled)."

IBD <- read_xlsx(paste0(data.path, "Baseline2022/IBD.xlsx"))

# create flare_group in IBD_C and make into level
IBD <- IBD %>%
  mutate(flare_group = ifelse(FlaresInPastYear == 0,
    "No Flares",
    "1 or More Flares"
  ))
IBD$flare_group <- factor(IBD$flare_group,
  levels = c("No Flares", "1 or More Flares")
)

IBD <- IBD %>%
  mutate(treatment = ifelse(TreatmentUseful == 4,
    "Not On Treatment",
    "On Treatment"
  ))
IBD$treatment <- factor(IBD$treatment,
  levels = c("Not On Treatment", "On Treatment")
)

# correcting scores where No is favourable and Yes is unfavourable outcomes
# answer options were always YES/NO/Not sure
if (any(IBD$MissPlannedActivities == 3)) {
  IBD <- IBD %>%
    mutate_at(
      vars("MissPlannedActivities":"NewSymptoms"),
      ~ recode(., `3` = 1, `2` = 2, `1` = 0)
    )
}

# correct TreatmentUseful (Yes is favourable, No unfavourable)
# not on treatment was assigned the value 1
if (any(IBD$TreatmentUseful == 3)) {
  IBD <- IBD %>%
    mutate_at(
      "TreatmentUseful",
      ~ recode(., `4` = 2, `3` = 1, `2` = 0, `1` = 2)
    )
}

# exclude rows with missing data, 17 participants excluded for missing IBD-control questionnaire data
IBD <- IBD %>%
  filter(!rowSums(is.na(select(., 17:27))) > 0)

# new column with total control score
IBD <- IBD %>%
  mutate(control_score = rowSums(select(., 17:27), na.rm = TRUE))

# new column with IBD-control-8 score
# added 2 to make comparable to future scores where the first question is asked to make comparable to future and against the cut off of 13 which indicates remission
IBD <- IBD %>%
  mutate(control_8 = TreatmentUseful +
    MissPlannedActivities +
    WakeUpAtNight +
    SignificantPain +
    OftenLackEnergy +
    AnxiousDepressed +
    NeedChangeTreatment +
    2)

# create groups with cut off of IBD-control-8 scores quiescent (13 or above)/not quiescent
IBD <- IBD %>%
  mutate(control_grouped = ifelse(control_8 >= 13, "13-16", "0-12"))

IBD$control_8 <- as.factor(IBD$control_8)

IBD <- IBD %>%
  mutate(vas_control = ifelse(OverallControl >= 85, "85+", "<85"))

demo <- merge(demo, IBD[, c("ParticipantNo", "control_8", "OverallControl", "vas_control")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
```

IBD Control is a validated questionnaire designed to assess disease control
from a patient's perspective [@Bodger_2013]. We considered an eight question
subset, IBD-Control-8 which ranges in potential scores from 0 to 16. We also
consider the IBD-Control visual analogue scale (VAS). @Bodger_2013 found a
cut-off of $\geq 13$ for IBD-Control-8 and a cut-off of $\geq 85$ for
IBD-Control-VAS to be optimal for identifying quiescent disease.

```{R}
#| label: fig-IBD-control
#| fig-cap: "Distributiuon of IBD Control scores for (A) Control-8 and (B) Visual analogue scale. The vertical red lines denote the cut-offs for quiescent disease reported by @Bodger_2013."
#| warning: false
p1 <- demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = control_8, color = control_8, fill = control_8)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  xlab("Control-8 Scores") +
  ylab("Frequency") +
  scale_color_manual(values = viridis::viridis(15), na.value = "#032B43") +
  scale_fill_manual(values = viridis::viridis(15), na.value = "#032B43") +
  geom_vline(xintercept = 11.5, color = "#FF4B3E")

p2 <- demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = OverallControl)) +
  geom_histogram(binwidth = 5, fill = "#FFD23F", color = "#947805") +
  theme_minimal() +
  xlab("VAS Scores") +
  ylab("Frequency") +
  geom_vline(xintercept = 85, color = "#FF4B3E") +
  scale_x_continuous(breaks = seq(0, 100, 10))
p1/p2 + plot_annotation(tag_levels = 'A')
```

IBD-Control-8 scores and VAS were both found to be significantly associated with
FC.

```{R}
#| label: tbl-control-8-fc
#| tbl-cap: "ANOVA between control-8 and FC groups."
pander(summary(aov(as.numeric(control_8) ~ cat, data = demo)))
```


```{R}
#| label: tbl-control-vas-fc
#| tbl-cap: "ANOVA between control VAS and FC groups."
pander(summary(aov(OverallControl ~ cat, data = demo)))
```

Instead to treating VAS as a continuous value, going forward, VAS will be
discretised into  below 85 and 85 and above as a VAS of 85 was found by
@Bodger_2013 to be predictive of quiescent disease.

```{R}
#| label: fig-VAS-dist
#| fig-cap: "Distribution of discretised IBD-Control-VAS scores."
demo <- demo %>%
  select(-OverallControl)
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = vas_control, color = vas_control, fill = vas_control)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  xlab("Visual analogue scores") +
  ylab("Frequency") +
  scale_color_manual(values = c("#D00000", "#447604"), na.value = "#032B43") +
  scale_fill_manual(values = c("#D00000", "#447604"), na.value = "#032B43")
```

The discretised VAS is continued to be significantly associated with FC. 

```{R}
#| label: tbl-vas-fc
#| tbl-cap: "Chi squared test between VAS and FC groups."
pander(chisq.test(demo$vas_control, demo$cat))
```

### Biochemistry results

```{R}
labs <- as.data.frame(read_xlsx(paste0(
  data.path,
  "Baseline2022/bloodtestresults.xlsx"
)))

labs <- labs %>%
  distinct(ParticipantNo, .keep_all = TRUE)


labs <- labs[, c(
  "ParticipantNo",
  "CReactiveProtein",
  "Haemoglobin",
  "HaemoglobinUnit",
  "WCC",
  "WCCUnit",
  "Albumin",
  "AlbuminUnit"
)]
demo <- merge(demo, labs, by = "ParticipantNo", all.x = TRUE, all.y = FALSE)
```

Participants' IBD care teams reported biochemistry results via REDCap. Whilst
data from many types of blood tests were collected, only the tests most relevant
to IBD will be presented here. Where possible, reference levels have been
denoted on plots via vertical lines. 

#### C-reactive protein

```{R}
perc <- (1 - demo %>%
  drop_na(cat) %>%
  select(CReactiveProtein) %>%
  is.na() %>%
  sum() /
  demo %>%
    drop_na(cat) %>%
    nrow()) * 100
```

Alongside FC, CRP is the most requested laboratory test for monitoring IBD
disease activity. Unlike FC which acts as a proxy for gastrointestinal
inflammation, CRP provides an indication of inflammation across the body. The
reference level for CRP is considered to be < 5 mg/L. 

CRP was generally well-completed with `r round(perc, 2)`% of subjects having an
associated CRP. As can be seen in @fig-crp-dist, there were some extreme, albeit
physiologically plausible, values reported. 
  
```{R}
#| label: fig-crp-dist
#| fig-cap: "Distribution of CRP at recruitment for the FC cohort."
#| warning: false
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = CReactiveProtein)) +
  geom_histogram(bins = 100, fill = "#EB9486", color = "#BF7163") +
  theme_minimal() +
  xlab("CRP (mg/L)") +
  ylab("Frequency")
```

As should be expected, CRP was found to be associated with FC. 

```{R}
#| label: tbl-crp-fc
#| tbl-cap: "ANOVA between CRP and FC groups."
pander(summary(aov(CReactiveProtein ~ cat, data = demo)))
```

#### Haemoglobin

```{R}
perc <- (1 - demo %>%
  drop_na(cat) %>%
  select(Haemoglobin) %>%
  is.na() %>%
  sum() /
  demo %>%
    drop_na(cat) %>%
    nrow()) * 100
```

Haemoglobin is a protein which facilitates the transport of oxygen in red blood
cells. Haemoglobin has been reported for `r round(perc, 2)`% of subjects in the
FC cohort. Haemoglobin differs between sex and accordingly has sex-specific
reference levels (130-170 g/L for men and 120-150g/L for women).

Whilst a normal distribution for haemoglobin is observed overall
(@fig-hb-dist-old), there appears to be some observations substantially lower
than one would expect for this distribution. Investigating these observations
suggests that these observations are likely to be in units of g/dL instead of
the common g/L units (@tbl-hb-units). 

```{R}
#| label: fig-hb-dist-old
#| fig-cap: "Distribution of haemoglobin before processing."
#| warning: false
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = Haemoglobin)) +
  geom_histogram(bins = 100, fill = "#76E5FC", color = "#2EB6CD") +
  theme_minimal() +
  xlab("Haemoglobin") +
  ylab("Frequency")
```


```{R}
#| label: tbl-hb-units
#| tbl-cap: "Reported unit measurements for Haemoglobin reported less than 50."
knitr::kable(table(subset(demo, Haemoglobin < 50)$HaemoglobinUnit),
  col.names = c("Units", "Frequency")
)
```

Having assumed any Haemoglobin < 50 has been reported in g/dL, any Haemoglobin
observations <50  have been multiplied by 10 to be in g/L units. This results
in the distribution seen in @fig-hb-dist-new. 

```{R}
#| label: fig-hb-dist-new
#| fig-cap: "Distribution of haemoglobin after processing."
#| warning: false
demo <- demo %>%
  mutate(Haemoglobin = if_else(Haemoglobin < 50,
    Haemoglobin * 10,
    Haemoglobin
  )) %>%
  select(-HaemoglobinUnit)

p1 <- demo %>%
  drop_na(cat) %>%
  filter(Sex == "Female") %>%
  ggplot(aes(x = Haemoglobin)) +
  geom_histogram(bins = 100, fill = "#8789C0", color = "#6A6B9C") +
  theme_minimal() +
  xlab("Haemoglobin (g/L)") +
  ylab("Frequency") +
  xlim(0, 190) +
  geom_vline(xintercept = c(120, 150), color = "#93032E") +
  ggtitle("Female haemoglobin")



p2 <- demo %>%
  drop_na(cat) %>%
  filter(Sex == "Male") %>%
  ggplot(aes(x = Haemoglobin, fill = Sex, color = Sex)) +
  geom_histogram(bins = 100, fill = "#225560", color = "#044651") +
  theme_minimal() +
  xlab("Haemoglobin (g/L)") +
  ylab("Frequency") +
  xlim(0, 190) +
  geom_vline(xintercept = c(130, 170), color = "#93032E") +
  ggtitle("Male haemoglobin")

(p1 / p2)
```

Haemoglobin was not found to be significantly associated with FC at a 5%
significance level. 

```{R}
#| label: tbl-hb-fc
#| tbl-cap: "ANOVA between haemoglobin and FC groups."
pander(summary(aov(Haemoglobin ~ cat, data = demo)))
```

#### White cell count

```{R}
perc <- (1 - demo %>%
  drop_na(cat) %>%
  select(WCC) %>%
  is.na() %>%
  sum() /
  demo %>%
    drop_na(cat) %>%
    nrow()) * 100
```

White cell count (WCC) is a measurement of all white blood cells (neutrophils,
lymphocytes, monocytes, basophils and eosinophils) which help to fight
infections. `r round(perc, 2)`% of subjects have a WCC recorded. 

Whilst some extreme WCC values are observed, most observations fall within the
reference range (4-11 (×10^9/L)) and a conventional bell curve is seen overall. 

```{R}
#| label: fig-WCC-dist
#| fig-cap: "Distrbution of WCC for the FC cohort. Vertical lines indicate the reference range."
#| warning: false
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = WCC)) +
  geom_histogram(bins = 100, fill = "#7FD8BE", color = "#2D977E") +
  theme_minimal() +
  xlab("White cell count (×10^9/L") +
  ylab("Frequency") +
  geom_vline(xintercept = c(4, 11), color = "#FF686B", alpha = 0.8)
```

WCC is reported to be associated with FC. 

```{R}
#| label: tbl-wcc-fc
#| tbl-cap: "ANOVA between WCC and FC groups."
pander(summary(aov(WCC ~ cat, data = demo)))
```

#### Albumin

```{R}
perc <- (1 - demo %>%
  drop_na(cat) %>%
  select(Albumin) %>%
  is.na() %>%
  sum() /
  demo %>%
    drop_na(cat) %>%
    nrow()) * 100
```

Albumin is globular protein made in the liver which carries hormones, vitamins,
and enzymes. Albumin has a reference range of 35-50 (g/L).
`r round(perc, 2)`% of subjects in the FC cohort have a recorded Albumin
result. 

```{R}
#| label: fig-Albumin-dist-old
#| fig-cap: "Distribution of Albumin before processing."
#| warning: false
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = Albumin)) +
  geom_histogram(bins = 100, fill = "#21D19F", color = "#26A37D") +
  theme_minimal() +
  xlab("Albumin") +
  ylab("Frequency") +
  geom_vline(xintercept = c(35, 50), color = "#FF686B")
```

As can be seen in @fig-Albumin-dist-old, a very extreme value has been reported. 
This has been assumed to have been off by a factor of 10. Adjusting this
observation results in the distribution seen in @fig-Albumin-dist-new.

```{R}
#| label: fig-Albumin-dist-new
#| fig-cap: "Distribution of Albumin after processing."
#| warning: false
demo <- demo %>%
  mutate(Albumin = if_else(Albumin > 100, Albumin / 10, Albumin)) %>%
  select(-AlbuminUnit)
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = Albumin)) +
  geom_histogram(bins = 40, fill = "#21D19F", color = "#26A37D") +
  theme_minimal() +
  xlab("Albumin (g/L)") +
  ylab("Frequency") +
  geom_vline(xintercept = c(35, 50), color = "#FF686B")
```

There is strong evidence for an association between Albumin and FC. 

```{R}
#| label: tbl-Albumin-fc
#| tbl-cap: "ANOVA between Albumin and FC groups."
pander(summary(aov(Albumin ~ cat, data = demo)))
```

### Dietary data

```{R}
FFQ <- read_xlsx(paste0(
  prefix,
  "predicct ffq_nutrientfood groupDQI all foods_data (n1092)Nov2022.xlsx"
))

FFQ <- subset(FFQ, participantno %in% fcal$ParticipantNo)

FFQ$ParticipantNo <- FFQ$participantno
demo <- merge(demo,
  FFQ[, c("ParticipantNo", "Meat_sum", "fibre", "PUFA_percEng", "NOVAScore_cat")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
```

PREdiCCt has collected data on diet via food frequency questionnaires (FFQs) and
food diaries. This dietary data has been analysed by staff at the
[University of Aberdeen](https://www.abdn.ac.uk/), primarily by
[Dr Janet Kyle](https://www.abdn.ac.uk/iahs/profiles/j.kyle), 
[Dr Graham Horgan](https://www.bioss.ac.uk/people/graham), and
[Professor Alex Johnstone](https://www.abdn.ac.uk/rowett/research/profiles/alex.johnstone).

Whilst data for many dietary variables have been collected, this report
will focus on the data outlined in the SAP.

1. Protein from animal-sources
1. Dietary fibre
1. Polyunsaturated fatty acids (PUFAs)
1. Nova intake score

The data for these variables were extracted from the FFQs. As reported
associations between dietary data and IBD are often specific to a form of IBD
rather than IBD as a whole, these data will be presented stratified by disease
type. 

#### Protein from meat sources

@fig-meat-sum-dist suggests there are relatively few vegetarians in the PREdiCCt
cohort. Whilst some extreme values were observed for protein from meat sources,
they remain plausible. 

```{R}
#| label: fig-meat-sum-dist
#| fig-cap: "Distribution of protein intake from meat."
#| warning: false
demo %>%
  drop_na(Meat_sum) %>%
  ggplot(aes(x = Meat_sum, color = diagnosis2, fill = diagnosis2)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Protein from meat sources (g)",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    labels = c("UC/IBDU", "Crohn's"),
    values = c("#5EB1BF", "#C24343")
  ) +
  facet_grid(rows = vars(diagnosis2))
```

No association was observed between protein intake from meat and FC.

```{R}
#| label: tbl-meat-sum
#| tbl-cap: "ANOVA between protein intake from meat and FC groups."
pander(summary(aov(Meat_sum ~ cat, data = demo)))
```

#### Dietary fibre

Fibre has frequently investigated as a potential factor in IBD pathogenesis,
particularly in CD. 

A study of 170,776 women across 26 years found fibre
intake, particularly fibre derived from fruits, to be low for incident CD
patients [@ananthakrishnan_2013].

A US study of 1,130 CD subjects found CD patients who reported that they did not
avoid high-fibre foods were approximately 40\% less likely to have a disease
flare in a 6-month period than those who avoided high-fibre foods [@brotherton_2016].

There is less evidence of a relationship between UC and dietary fibre.  

There does not appear to be substantial differences in fibre between CD and
UC/IBDU PREdiCCt participants. 

```{R}
#| label: fig-fibre-dist
#| fig-cap: "Distribution of dietary fibre."
#| warning: false
demo %>%
  drop_na(fibre) %>%
  ggplot(aes(x = fibre, color = diagnosis2, fill = diagnosis2)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Dietary fibre",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    values = c("#5EB1BF", "#C24343")
  ) +
  facet_grid(rows = vars(diagnosis2))
```

No association was found between dietary fibre intake and FC. 

```{R}
#| label: tbl-fibre
#| tbl-cap: "ANOVA between dietary fibre and FC groups."
pander(summary(aov(fibre ~ cat, data = demo)))
```

#### Polyunsaturated fatty acids

PUFAs exhibit anti-inflammatory properties and there is evidence of a
relationship between PUFAs and UC incidence [@Marion_Letellier_2013]. Research
suggests that a diet with a poor balance of n-3 and n-6 PUFAs, commonly seen in
"Western" diets is associated with IBD risk. 

The PREdiCCt SAP states n-6 PUFAs will be examined. However, the data obtained
from the FFQs describes PUFAs as a whole (including n-3 PUFAs).

```{R}
#| label: fig-pufa-dist
#| fig-cap: "Distribution of polyunsaturated fatty acids."
#| warning: false
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = PUFA_percEng, color = diagnosis2, fill = diagnosis2)) +
  geom_histogram(bins = 25) +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "PUFA intake",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    values = c("#5EB1BF", "#C24343")
  ) +
  facet_grid(rows = vars(diagnosis2))
```

A significant association was not seen between PUFA intake and FC. 

```{R}
#| label: tbl-pufa
#| tbl-cap: "ANOVA between polyunsaturated fatty acids and FC groups."
pander(summary(aov(PUFA_percEng ~ cat, data = demo)))
```

#### Nova intake score

There has been a great deal of recent research interest in ultra processed food
(UPF) and IBD. For example, @Narula_2021 found UPF intake to be positively
associated with IBD risk. 

The Nova score is a popular approach for classifying UPFs [@Monteiro_2017]. Food
is classified as either unprocessed, processed culinary, processed food, or
ultra-processed via the Nova score. The University of Aberdeen have developed an
extension of the Nova score, the Nova intake score, which can be used to
categorise individuals and their diets instead of individual food items.

The following definition of the Nova intake score was written by Liam McAdie 
during a 5th year medical elective in which he worked on the PREdiCCt dietary
data. The formulae have received minor modifications, but otherwise the
definitions remain unchanged from McAdie's work. 

##### Definition

When completing the FFQ, participants were asked to report ($a$) portion size
normally consumed, ($b$) number of times this portion is consumed in one day and
($c$) number of days per week food type is consumed. Participant’s daily average
consumption (in grams) of a food and drink type ($x$) was calculated by:

$$
x=\frac{c}{7}(a+b)
$$

Standardised number of portions consumed daily for food and drink type ($y$) was
calculated by dividing consumption ($x$) by the Foods Standard Agency average
UK-portion size ($z$). 

$$
y= \frac{x}{z}
$$

Nova intake scores ($N$) were calculated by multiplying the number of
standardised portions consumed ($y$) by their corresponding Nova score ($M$)
assigned in the database. This process is repeated for all 169 food and drink
types and totalled to give one overall Nova intake score. This score is a marker
representative of UPF intake.

$$
N = \sum_{i = 1}^{169} (y_i M_i)
$$

##### Results

The distribution of Nova intake score appears to be uniform across the cohort.

```{R}
#| label: fig-novas-dist
#| fig-cap: "Distribution of Nova intake scores."
demo$NOVAScore_cat <- factor(demo$NOVAScore_cat,
  levels = 1:4,
  labels = c(
    "Unprocessed",
    "Processed culinary",
    "Procesed food",
    "Ultra-processed"
  )
)

demo %>%
  drop_na(NOVAScore_cat) %>%
  ggplot(aes(x = NOVAScore_cat, color = diagnosis2, fill = diagnosis2)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Nova intake score",
    y = "Frequency",
    color = "IBD type",
    fill = "IBD type"
  ) +
  scale_fill_manual(
    values = c("#CDEDF6", "#FF6B6B")
  ) +
  scale_color_manual(
    values = c("#5EB1BF", "#C24343")
  ) +
  facet_grid(rows = vars(diagnosis2))
```

No significant association was observed between Nova intake scores and FC
groups. 

```{R}
#| tbl-cap: "Chi-squared test between Nova intake score and FC groups."
pander(chisq.test(demo$NOVAScore_cat, demo$cat))
```

### Medication use

This section is concerned with medication used by study participants. Current
treatment strategy, bio-naive status and antibiotic use are considered. 

#### IBD treatment strategy

```{R}
drugs <- data.frame(ParticipantNo = demo$ParticipantNo)

drugs$ASA <- FALSE
drugs$imm <- FALSE
drugs$bio <- FALSE
drugs$category <- NA

redcap <- redcap %>% mutate(
  curr_on_mesa = ifelse(is.na(curr_on_mesa),
    0,
    curr_on_mesa
  ),
  curr_on_aza = ifelse(is.na(curr_on_aza),
    0,
    curr_on_aza
  ),
  curr_on_merc = ifelse(is.na(curr_on_merc),
    0,
    curr_on_merc
  ),
  curr_on_metho = ifelse(is.na(curr_on_metho),
    0,
    curr_on_metho
  ),
  curr_on_ciclo = ifelse(is.na(curr_on_ciclo),
    0,
    curr_on_ciclo
  ),
  curr_on_inflix = ifelse(is.na(curr_on_inflix),
    0,
    curr_on_inflix
  ),
  curr_on_ada = ifelse(is.na(curr_on_ada),
    0,
    curr_on_ada
  ),
  curr_on_goli = ifelse(is.na(curr_on_goli),
    0,
    curr_on_goli
  ),
  curr_on_vedo = ifelse(is.na(curr_on_vedo),
    0,
    curr_on_vedo
  ),
  curr_on_ust = ifelse(is.na(curr_on_ust),
    0,
    curr_on_ust
  )
)

for (i in 1:nrow(drugs)) {
  if (drugs[i, "ParticipantNo"] %in% redcap$participantno) {
    subject.data <- subset(redcap, participantno == drugs[i, "ParticipantNo"])[1, ]
    if (subject.data$curr_on_mesa == 1) drugs[i, "ASA"] <- TRUE

    # Immunosuppressants
    if (subject.data$curr_on_aza == 1 |
      subject.data$curr_on_merc == 1 |
      subject.data$curr_on_metho == 1 |
      subject.data$curr_on_ciclo == 1) {
      drugs[i, "imm"] <- TRUE
    }

    # Biologics
    if (subject.data$curr_on_inflix == 1 |
      subject.data$curr_on_ada == 1 |
      subject.data$curr_on_goli == 1 |
      subject.data$curr_on_vedo == 1 |
      subject.data$curr_on_ust == 1) {
      drugs[i, "bio"] <- TRUE
    }
    if (drugs[i, "imm"] & drugs[i, "bio"]) {
      drugs[i, "category"] <- 4
    } else if (drugs[i, "imm"]) {
      drugs[i, "category"] <- 2
    } else if (drugs[i, "bio"]) {
      drugs[i, "category"] <- 3
    } else if (drugs[i, "ASA"]) {
      drugs[i, "category"] <- 1
    }
  }
}

drugs$category <- factor(drugs$category,
  levels = 1:4,
  labels = c(
    "5ASA",
    "Mono immunotherapy",
    "Mono biologic",
    "Combo therapy"
  )
)

drugs <- merge(drugs, demo[, c("ParticipantNo", "cat", "diagnosis2")], by = "ParticipantNo")
colnames(drugs)[5] <- "Treatment"
```

For IBD treatment, subjects are categorised as being on either a 5ASA, mono
immunotherapy, mono biologic, or immuno-biologic combination treatment strategy
based upon REDCap data provided by participants' IBD care teams. 

Treatments. in REDCap were selected via check boxes. As such, `NA` (unticked) is
assumed to mean the participant is not on a given medication. 

Immunosuppressants are defined as:

* Azathioprine
* Mercaptopurine
* Methotrexate
* Ciclosporin

Biologics are defined as:

* Infliximab
* Adalimumab 
* Golimumab
* Vedolizumab
* Ustekinumab

Patients are only categorised as receiving a 5ASA treatment plan if 5ASA is the
only IBD treatment they are receiving (I.E no immunotherapy or biologics).

As should be expected given poor efficacy in CD, a 5ASA treatment strategy is
much more common for UC/IBDU participants (@fig-treatments). Mono biologic
therapy is the most common treatment strategy for CD subjects.

```{R}
#| label: fig-treatments
#| fig-cap: "Reported treatment strategies for the FC cohort."
#| fig-width: 8
plt.cols <- c("#52528C", "#DD6E42", "#048A81", "#C585B3")


drugs %>%
  drop_na(cat) %>%
  ggplot(aes(x = Treatment, fill = Treatment, color = Treatment)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  xlab("Treatment strategy") +
  ylab("Frequency") +
  scale_fill_manual(values = plt.cols, na.value = "#032B43") +
  scale_colour_manual(
    values = colorspace::darken(plt.cols, 0.3),
    na.value = "#032B43"
  ) +
  facet_grid(rows = vars(diagnosis2))
```

```{R}
#| label: tbl-treatments-cd
#| tbl-cap: "Chi-squared test between treatment strategy and FC groups for participants with Crohn's disease."
pander(with(subset(drugs, diagnosis2 == "CD"), chisq.test(Treatment, cat)))
```

```{R}
#| label: tbl-treatments-uc
#| tbl-cap: "Chi-squared test between treatment strategy and FC groups for participants with Ulcerative colitis/IBDU."
pander(with(subset(drugs, diagnosis2 == "UC/IBDU"), chisq.test(Treatment, cat)))
```

#### Bio-naive status

```{R}
bio.naive <- data.frame(ParticipantNo = redcap$participantno)
bio.naive <- subset(bio.naive, ParticipantNo %in% demo$ParticipantNo)
bio.naive <- merge(bio.naive,
  demo[, c("ParticipantNo", "diagnosis")],
  all.y = TRUE,
  all.x = FALSE
)
bio.naive <- distinct(bio.naive, ParticipantNo, .keep_all = TRUE)
bio.naive$naive <- "yes"

bio.vars <- c("inflix", "ada", "goli", "vedo", "ust")

for (i in 1:nrow(bio.naive)) {
  temp.df <- as.data.frame(subset(redcap, participantno == bio.naive[i, 1]))
  temp.df <- temp.df[, paste0("curr_on_", bio.vars)]
  temp.df <- temp.df[, !is.na(temp.df[1, ])]

  if (any(temp.df == 1)) {
    bio.naive[i, "naive"] <- "no-using"
  } else if (any(temp.df == 2)) {
    bio.naive[i, "naive"] <- "no-not-using"
  } # else naive
}

drugs.eof <- read_xlsx(paste0(prefix, "EOF_drugs.xlsx"))
using <- subset(drugs.eof, AtRecruitmentYN == 1)
bio.list <- seq(4, 8)
using <- subset(using, DrugType %in% bio.list)
using <- subset(demo, ParticipantId %in% using$ParticipantId)
using <- using[, c("ParticipantNo", "diagnosis")]
using$naive <- c("no-using")

bio.naive <- rbind(bio.naive, using)

for (i in unique(bio.naive$ParticipantNo)) {
  temp <- subset(bio.naive, ParticipantNo == i)
  # if "no-using" in either extract then report using
  if (nrow(temp) > 1) {
    if (any(temp$naive == "no-using")) {
      bio.naive <- subset(bio.naive, ParticipantNo != i)
      bio.naive <- rbind(
        bio.naive,
        data.frame(
          ParticipantNo = i,
          diagnosis = temp[1, "diagnosis"],
          naive = "no-using"
        )
      )
    }
  }
}

bio.naive <- distinct(bio.naive, ParticipantNo, .keep_all = TRUE)

demo <- merge(demo,
  bio.naive[, c(1, 3)],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

demo$naive <- factor(demo$naive,
  levels = c("no-using", "no-not-using", "yes"),
  labels = c("Current", "Previously", "Never prescribed")
)

colnames(demo)[colnames(demo) == "naive"] <- "Biologic"
```

Bio-naive status has been determined using REDCap and EoS data. As clinical
teams were not explicitly asked if a subject was bio-naive, the subject is
instead defined as being bio-naive if there are no recorded biologics for the
subject (which may bias subjects with missing data towards incorrectly being
reported as bio-naive). Non bio-naive subjects are categorised further into
either "currently using" or "previously used". 

Biologic treatments are defined as infliximab, adalimumab, golimumab,
vedolizumab, and ustekinumab.

Small molecule treatments are not considered in this report due to their
low prescribing rates during the recruitment period (which ended March 2020).

```{R}
#| label: fig-biologic-use
#| fig-cap: "Bio-naivety in the FC cohort."
demo %>%
  drop_na(cat) %>%
  ggplot(aes(x = Biologic, fill = Biologic, color = Biologic)) +
  geom_bar() +
  xlab("Biologic status") +
  ylab("Frequency") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(values = c("#CACF85", "#8CBA80", "#E58F65")) +
  scale_color_manual(values = c("#747825", "#4A6E3F", "#934D1B")) +
  guides(
    fill = guide_legend(title = "Biologic status"),
    color = guide_legend(title = "Biologic status")
  ) +
  facet_grid(rows = vars(diagnosis2))
```

Bio-naive status was found to be associated with FC groups which may be due to 
patients with more active disease being more likely to be prescribed a biologic. 

```{R}
#| label: tbl-biologic
#| tbl-cap: "Chi-squared test between bio-naive status and FC groups."
pander(chisq.test(demo$Biologic, demo$cat))
```

#### Antibiotics

```{R}
#| warning: false
meds <- read_xlsx(paste0(data.path, "Baseline2022/medicines.xlsx"))
drugs <- merge(drugs,
  meds[, c("ParticipantNo", "Antibiotics6Mths")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
drugs$Antibiotics6Mths <- factor(drugs$Antibiotics6Mths, c(1, 2), c("Yes", "No"))
colnames(drugs)[8] <- "Antibiotic use in 6 months"
percAntibiotic <- round(
  sum(drugs$`Antibiotic use in 6 months` == "Yes", na.rm = TRUE) /
    sum(!is.na(drugs$`Antibiotic use in 6 months`), na.rm = TRUE),
  2
) * 100
```

Study participants were asked if they had taken an antibiotic in the last six
months. As the answer to this question was provided via a drop down box, `NA` 
indicates a missing value and not "No". 

Out of all participants who answered the question, `r percAntibiotic`% reporting 
using an antibiotic within the six months prior to recruitment. 

```{R}
#| label: fig-antibiotic
#| fig-cap: "Antibiotic use in the previous six months."
plt.cols <- c("#FE5F55", "#004E89")
drugs %>%
  drop_na(cat) %>%
  ggplot(aes(
    x = `Antibiotic use in 6 months`,
    color = `Antibiotic use in 6 months`,
    fill = `Antibiotic use in 6 months`
  )) +
  geom_bar() +
  theme_minimal() +
  xlab("Used antibiotics") +
  ylab("Frequency") +
  theme(legend.position = "none") +
  scale_fill_manual(values = plt.cols, na.value = "#032B43") +
  scale_colour_manual(
    values = colorspace::darken(plt.cols, 0.5),
    na.value = "#032B43"
  )
```

Recent antibiotic usage is not associated with FC. 

```{R}
#| label: tbl-antibiotics
#| tbl-cap: "Chi-squared test between antibiotic use and FC groups."
pander(chisq.test(drugs$`Antibiotic use in 6 months`, drugs$cat))
```

### Cohort derivation

The below flowchart gives a simple explanation of how the sub-cohort of subjects
with analysed food frequency questionnaires (FFQs) was obtained. 

```{R}
#| class-output: output
flow <- grViz(paste0("digraph flowchart {

graph[splines = ortho]
  # node definitions with substituted label text
  node [fontname = Helvetica, shape = rectangle, fixedsize = false, width = 1]
  1 [label = 'Recruited to PREdiCCt\n n = ", nrow(demo), "']
  2 [label = 'Baseline FC available\n n = ", nrow(drop_na(demo, cat)), "']
  3 [label = 'Food frequency questionnaire\n analysed\n n = ", nrow(FFQ), "']

  node [shape=none, width=0, height=0, label='']
  1 -> 2; 2-> 3
}"))
htmltools::HTML(export_svg(flow))
```



### Table of baseline data by cohort


```{R}
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}

demo$control_8 <- as.numeric(demo$control_8)


comp <- demo
comp$cohort <- "All"

temp <- demo %>%
  drop_na(cat)
temp$cohort <- "FC"

comp <- rbind(comp, temp)

temp <- subset(demo, ParticipantNo %in% FFQ$participantno)
temp$cohort <- "FFQ"

comp <- rbind(comp, temp)

comp$cohort <- factor(comp$cohort,
  levels = c("All", "FC", "FFQ"),
  labels = c("Full cohort", "FC cohort", "FFQ cohort")
)

table1(
  ~ Age +
    Sex +
    Ethnicity +
    BMIcat +
    diagnosis +
    `IBD Duration` +
    IMD +
    control_8 +
    vas_control +
    FC +
    CReactiveProtein +
    Haemoglobin +
    WCC +
    Albumin +
    Meat_sum +
    fibre +
    PUFA_percEng +
    NOVAScore_cat +
    Biologic | cohort,
  data = comp,
  render.continuous = my.render.cont,
  overall = FALSE
)
```

#### Associations with cohort membership 

Only age, biologic use, and albumin were found to be significantly different
across cohorts. 

##### Age

There is a significant difference in age across cohorts with subjects in the FFQ
sub-cohort being more likely to be older than the Full or FC cohorts. 

```{R}
pander(summary(aov(Age ~ cohort, data = comp)))
```

##### Sex

```{R}
pander(chisq.test(comp$Sex, comp$cohort))
```

##### IBD type

```{R}
pander(chisq.test(comp$diagnosis2, comp$cohort))
```

##### Index of multiple deprivation

```{R}
pander(chisq.test(comp$IMD, comp$cohort))
```

##### Disease duration

```{R}
pander(summary(aov(`IBD Duration` ~ cohort, data = comp)))
```

##### IBD Control-8

```{R}
pander(summary(aov(control_8 ~ cohort, data = comp)))
```

##### IBD visual analogue score

```{R}
pander(chisq.test(comp$vas_control, comp$cohort))
```

##### Body mass index

```{R}
pander(summary(aov(BMI ~ cohort, data = comp)))
```

##### Faecal calprotectin

FC has been treated as a continuous variable for this test. FC has not been 
discretised.

```{R}
pander(summary(aov(FC ~ cohort, data = comp)))
```

##### C-reactive protein

```{R}
pander(summary(aov(CReactiveProtein ~ cohort, data = comp)))
```

##### Haemoglobin

```{R}
pander(summary(aov(Haemoglobin ~ cohort, data = comp)))
```

##### White cell count

```{R}
pander(summary(aov(WCC ~ cohort, data = comp)))
```

##### Albumin 

There is a significant difference in albumin across the cohorts. However, this
difference appears to be negligible. 

```{R}
pander(summary(aov(Albumin ~ cohort, data = comp)))
```

##### Dietary data

Dietary data have not been compared across cohorts.

##### Biologic usage

There is a significant difference in biologic usage across the cohorts with
subjects in the FFQ sub-cohort being less likely to have been prescribed a
biologic than the full cohort or the FC sub-cohort. 

```{R}
pander(chisq.test(comp$Biologic, comp$cohort))
```

### Table of baseline data by FC groups


```{R}
#| label: tbl-tab2
#| tbl-cap: "Baseline data by FC."

demo %>%
  drop_na(cat) %>%
  table1(
    x = ~ Age +
    Sex +
    Ethnicity +
    BMIcat +
    diagnosis +
    `IBD Duration` +
    IMD +
    control_8 +
    vas_control +
    FC +
    CReactiveProtein +
    Haemoglobin +
    WCC +
    Albumin +
    Meat_sum +
    fibre +
    PUFA_percEng +
    NOVAScore_cat +
    Biologic | cat,
    render.continuous = my.render.cont
  )
```

### Table of baseline data by IBD type

```{R}
#| label: tbl-tab1
#| tbl-cap: "Baseline data by IBD type."

demo %>%
  drop_na(cat) %>%
  table1::table1(
    x = ~ Age +
    Sex +
    Ethnicity +
    BMIcat +
    diagnosis +
    `IBD Duration` +
    IMD +
    control_8 +
    vas_control +
    FC +
    CReactiveProtein +
    Haemoglobin +
    WCC +
    Albumin +
    Meat_sum +
    fibre +
    PUFA_percEng +
    NOVAScore_cat +
    Biologic |
      diagnosis2,
    render.continuous = my.render.cont
  )
```

## Variables only relevant to Crohn's disease subjects

```{R}
smoking <- read_xlsx(paste0(data.path, "Baseline2022/lifestyle.xlsx")) %>%
  select(ParticipantNo, Smoke, SmokedInPast)
smoking$Smoke <- plyr::mapvalues(smoking$Smoke, from = 2, to = 3)

for (i in 1:nrow(smoking)) {
  if ((!is.na(smoking[i, "SmokedInPast"]) & smoking[i, "SmokedInPast"] == 1) & (!is.na(smoking[i, "Smoke"]) & smoking[i, "Smoke"] == 3)) {
    smoking[i, "Smoke"] <- 2
  }
}

smoking$Smoke <- factor(smoking$Smoke,
  levels = seq(1, 3),
  labels = c("Current", "Previous", "Never")
)

smoking <- smoking[, -3]


demo <- merge(demo,
  smoking,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

esmoking <- read_xlsx(paste0(data.path, "Baseline2022/lifestyle.xlsx")) %>%
  select(ParticipantNo, ECigs, ECigsPast)
esmoking$ECigs <- plyr::mapvalues(esmoking$ECigs, from = 2, to = 3)

for (i in 1:nrow(esmoking)) {
  if ((!is.na(esmoking[i, "ECigsPast"] == 1) & esmoking[i, "ECigsPast"] == 1) & (!is.na(esmoking[i, "ECigs"]) & esmoking[i, "ECigs"] == 3)) {
    esmoking[i, "ECigs"] <- 2
  }
}

esmoking$ECigs <- factor(esmoking$ECigs,
  levels = seq(1, 3),
  labels = c("Current", "Previous", "Never")
)

esmoking <- esmoking[, -3]


demo <- merge(demo,
  esmoking,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
```

This section looks at data only applicable to subjects with CD. The following 
variables are considered: surgery, Montreal location, Montreal behaviour,
Harvey-Bradshaw index, and smoking. 

Smoking for CD and UC is considered separately as smoking is often reported to
worsen outcomes in CD but may be protective in UC. 

### Surgery

```{R}
predicct.surgery <- read_xlsx(paste0(
  data.path,
  "Baseline2022/IBD.xlsx"
))[, c("ParticipantNo", "HadSurgeryForIBD")]
colnames(predicct.surgery)[2] <- "Surgery"


redcap.surgery <- redcap[, c("participantno", "surgery")]


names(redcap.surgery) <- c("ParticipantNo", "Surgery")

surgery <- rbind(redcap.surgery, predicct.surgery)
surgery <- subset(surgery, !is.na(surgery$Surgery))

# As REDCap is first, this will be prioritised over subject (if not NA)
surgery <- distinct(surgery, ParticipantNo, .keep_all = TRUE)

demo.cd <- subset(demo, diagnosis2 == "CD")
demo.cd <- merge(demo.cd, surgery, all.x = TRUE, all.y = FALSE)
demo.cd$Surgery <- factor(demo.cd$Surgery,
  levels = c(1, 2),
  labels = c("Yes", "No")
)
```

Surgical data has been obtained from both REDCap and patient-completed
questionnaires. Where data are available from both data sources, REDCap is
the preferred data source. 


```{R}
#| label: fig-surgery-dist
#| fig-cap: "Previous surgery for Crohn's disease subjects in the FC cohort."
demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = Surgery, fill = Surgery, color = Surgery)) +
  geom_bar() +
  xlab("Previous surgery") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#F9B9B7", "#96C9DC"), na.value = "#032B43") +
  scale_color_manual(values = c("#D06965", "#448CA2"), na.value = "#032B43")
```

FC at study recruitment is significantly associated with having previously
undergone surgery for CD.

```{R}
#| label: tbl-surgery
#| tbl-cap: "Chi-squared test between previous surgery and FC groups."
pander(chisq.test(demo.cd$Surgery, demo.cd$cat))
```

### Montreal location

```{R}
mapping <- data.frame(
  code = seq(1, 6),
  definition = c(
    "Oesophago-gastric",
    "Duodenal",
    "Jejunal",
    "Ileal",
    "Colonic",
    "Rectal"
  )
)

cd.location <- redcap[, c("participantno", paste0("mac_extent___", 1:6))]
L4 <- rep(0, nrow(cd.location))
Location <- rep(NA, nrow(cd.location))

for (i in 1:nrow(cd.location)) {
  # If Oesophago-gastric, Duodenal, Jejunal, then L4 is present
  if (any(cd.location[i, 2:4] == 1)) L4[i] <- 1
  if (cd.location[i, 5] == 1 & cd.location[i, 6] == 1) {
    Location[i] <- 3 # Ileal-colonic
  } else if (cd.location[i, 5] == 1 & cd.location[i, 6] == 0) {
    Location[i] <- 1 # Ileal only
  } else if (cd.location[i, 5] == 0 & cd.location[i, 6] == 1) {
    Location[i] <- 2 # Colonic only
  }
  if (is.na(Location[i]) & L4[i] == 1) {
    Location[i] <- 4 # L4 Only
  }
}

L4[is.na(Location) & L4 == 0] <- NA

mont.df <- data.frame(
  cd.location[, "participantno"],
  Location,
  L4
)
colnames(mont.df)[1] <- "ParticipantNo"
demo.cd <- merge(demo.cd, mont.df,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

demo.cd$Location <- factor(demo.cd$Location,
  levels = c(1, 2, 3, 4),
  labels = c("L1", "L2", "L3", "L4 only")
)

demo.cd$L4 <- factor(demo.cd$L4,
  levels = c(0, 1),
  labels = c("Not present", "Present")
)
```

Montreal location has been obtained from REDcap data. Rather than being asked
for Montreal location directly, clinical teams were asked to provide more
granular detail by ticking boxes if inflammation was in any of the following
areas `r mapping$definition`. If only any of the first 3 were reported then
the subject was assigned "L4 only". L1-L3 were assigned as per convention 
[@silverbergIntegratedClinicalMolecular2005]. If no location was reported then
location was assigned `NA`. 

As can be seen in @fig-location, L3 is the most common Montreal location in this
cohort with  roughly an equal amount of subjects having either L1 or L2. 

```{R}
#| label: fig-location
#| fig-cap: "Montreal location for CD subjects in the FC cohort."
demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = Location, fill = Location, color = Location)) +
  geom_bar() +
  xlab("Montreal location") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#33CA7F", "#96C9DC", "#C33C54", "#FCB97D"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#318859", "#448CA2", "#80333E", "#BD7700"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "Montreal location"),
    color = guide_legend(title = "Montreal location")
  )
```

Due to the low number of subjects with L4-only, Fisher's exact test has been
used to compare with FC.  

```{R}
#| label: tbl-location
#| tbl-cap: "Fisher's exact test between Montreal location and FC groups."
pander(fisher.test(demo.cd$Location, demo.cd$cat, workspace = 20000000))
```

In addition to L4-only being considered, we also investigate L4 as a modifier. 

```{R}
#| label: fig-L4
#| fig-cap: "L4 (upper GI involvement) in the FC cohort."
demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = L4, fill = L4, color = L4)) +
  geom_bar() +
  xlab("Presence of L4") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#51E5FF", "#EC368D"), na.value = "#032B43") +
  scale_color_manual(values = c("#079DB1", "#AF0863"), na.value = "#032B43") +
  guides(
    fill = guide_legend(title = "Presence of L4"),
    color = guide_legend(title = "Presence of L4")
  )
```

```{R}
#| label: tbl-L4
#| tbl-cap: "Chi-squared test between L4 and FC groups."
pander(chisq.test(demo.cd$L4, demo.cd$cat))
```

### Montreal behaviour

```{R}
cd.behaviour <- redcap[, c("participantno", "behaviour", "perianal")]
colnames(cd.behaviour) <- c("ParticipantNo", "Behaviour", "Perianal")
cd.behaviour$Perianal[!is.na(cd.behaviour$Perianal) & cd.behaviour$Perianal == 3] <- NA


demo.cd <- merge(demo.cd,
  cd.behaviour,
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)

demo.cd$Behaviour <- factor(demo.cd$Behaviour,
  levels = c(1, 2, 3),
  labels = c("B1", "B2", "B3")
)
```

Montreal behaviour has been obtained from REDCap data and was recorded
conventionally. The majority of CD subjects have the B1 (inflammatory)
phenotype.

```{R}
#| label: fig-behaviour
#| fig-cap: "Montreal behaviour for CD subjects in the FC cohort."

demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = Behaviour, fill = Behaviour, color = Behaviour)) +
  geom_bar() +
  xlab("Montreal behaviour") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#7AE7C7", "#440381", "#D64045"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#07A282", "#340165", "#942E31"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "Montreal behaviour"),
    color = guide_legend(title = "Montreal behaviour")
  )
```

Montreal behaviour is not significantly associated with FC at recruitment.

```{R}
#| label: tbl-behaviour
#| tbl-cap: "Chi-squared test between Montreal behaviour and FC groups."
pander(chisq.test(demo.cd$Behaviour, demo.cd$cat))
```

Approximately a third of CD subjects are reported to have perianal disease.

```{R}
#| label: fig-peri
#| fig-cap: "Perianal disease for CD subjects in the FC cohort."
demo.cd$Perianal <- factor(demo.cd$Perianal,
  levels = c(1, 2),
  labels = c("Yes", "No")
)

demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = Perianal, fill = Perianal, color = Perianal)) +
  geom_bar() +
  xlab("Perianal disease") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(values = c("#023C40", "#AF5B5B"), na.value = "#032B43") +
  scale_color_manual(values = c("#002C30", "#754242"), na.value = "#032B43") +
  guides(
    fill = guide_legend(title = "Perianal disease"),
    color = guide_legend(title = "Perianal disease")
  )
```

Perianal disease is not associated with FC at recruitment. 

```{R}
#| label: tbl-peri
#| tbl-cap: "Chi-squared test between between perianal disease and FC groups."
pander(chisq.test(demo.cd$Perianal, demo.cd$cat))
```

### Harvey-Bradshaw Index

```{R}
HBI.df <- redcap[, c("participantid", "current_hb")]
colnames(HBI.df) <- c("ParticipantId", "HBI")
HBI.df <- subset(HBI.df, ParticipantId %in% demo.cd$ParticipantId)

demo.cd <- merge(demo.cd, HBI.df, by = "ParticipantId", all.x = TRUE)

temp <- demo.cd %>%
  drop_na(cat)
percHBI <- round(sum(is.na(temp$HBI)) / nrow(temp), 2) * 100
```

Whilst HBI was collected via REDCap, substantial missingness is observed with
`r percHBI`% of CD subjects in the FC sub-cohort missing HBI.

```{R}
#| label: fig-hbi
#| fig-cap: "Harvey-Bradshaw index for CD subjects in the FC cohort."
demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = as.factor(HBI))) +
  geom_bar(fill = "#A167A5", color = "#4A306D") +
  theme_minimal() +
  ylab("Frequency") +
  xlab("Harvey-Bradshaw index at time of recruitment")
```

```{R}
#| label: tbl-hbi
#| tbl-cap: "ANOVA between between Harvey-Bradshaw index and FC groups."
summary(aov(HBI ~ cat, data = demo.cd))
```

### PRO-2 in Crohn's disease

Sum of liquid stools per day and abdominal pain. 

```{R}
PRO2 <- redcap[, c("participantno", "liq_stool_day", "abdo_pain")]
PRO2$liq_stool_day <- as.numeric(PRO2$liq_stool_day) # Drop ileostomies

PRO2$PRO2 <- with(PRO2, liq_stool_day + abdo_pain)

PRO2$ParticipantNo <- PRO2$participantno
demo.cd <- merge(demo.cd,
              PRO2[, c("ParticipantNo", "PRO2")],
              by = "ParticipantNo",
              all.x = TRUE,
              all.y = FALSE)
```

```{R}
demo.cd %>%
  ggplot(aes(x = as.factor(PRO2))) +
  geom_bar(fill = "#FF8552", color = "#D2632A") +
  scale_fill_manual(na.value = "#032B43") +
  scale_color_manual(na.value = "#032B43") +
  theme_minimal()
```


### Smoking

```{R}
percPrev <- round(sum(temp$Smoke == "Previous", na.rm = TRUE) / nrow(temp), 2) * 100
```

We consider smoking for CD and UC separately as smoking is often reported to
worsen outcomes in CD but is possibly protective in UC. Smoking status is
self-reported by study participants. 

Whilst most subjects have never been a smoker, a substantial proportion of
subjects (`r percPrev`%) have previously been smokers. 

```{R}
#| label: fig-smoke-cd
#| fig-cap: "Smoking status for CD subjects in the FC cohort."
demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = Smoke, fill = Smoke, color = Smoke)) +
  geom_bar() +
  xlab("Smoking status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#4E0250", "#517664", "#1C448E"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#3D003F", "#385245", "#033070"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "Smoking status"),
    color = guide_legend(title = "Smoking status")
  )
```

Smoking status is associated with FC at recruitment for CD subjects. 

```{R}
#| label: tbl-smoke-cd
#| tbl-cap: "Chi-squared test between between smoking status and FC groups for CD subjects."
pander(chisq.test(demo.cd$Smoke, demo.cd$cat))
```

### E-cigarette use

The vast majority of participants do not report using some form of e-cigarettes.
It should be noted that as recruitment ended March 2020, these day may not
reflect more modern trends. 

```{R}
#| label: fig-esmoke-cd
#| fig-cap: "E-cigarette usage for CD subjects in the FC cohort."
demo.cd %>%
  drop_na(cat) %>%
  ggplot(aes(x = ECigs, fill = ECigs, color = ECigs)) +
  geom_bar() +
  xlab("E-cigarette status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#4E0250", "#517664", "#1C448E"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#3D003F", "#385245", "#033070"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "E-cigarette status"),
    color = guide_legend(title = "E-cigarette status")
  )
```

```{R}
#| label: tbl-esmoke-cd
#| tbl-cap: "Chi-squared test between between E-cigarettte usage and FC groups for CD subjects."
pander(chisq.test(demo.cd$ECigs, demo.cd$cat))
```

### Table of Crohn's disease variables

```{R}
demo.cd %>%
  drop_na(cat) %>%
  table1(
    x = ~ Location +
      L4 +
      HBI +
      PRO2 +
      Behaviour +
      Perianal +
      Surgery +
      Smoke +
      ECigs |
      cat,
    render.continuous = my.render.cont
  )
```

### Table of Crohn's disease variables by cohort

```{R}
comp <- demo.cd
comp$cohort <- "All"

temp <- demo.cd %>%
  drop_na(cat)
temp$cohort <- "FC"

comp <- rbind(comp, temp)

temp <- subset(demo.cd, ParticipantNo %in% FFQ$participantno)
temp$cohort <- "FFQ"

comp <- rbind(comp, temp)

comp$cohort <- factor(comp$cohort,
  levels = c("All", "FC", "FFQ"),
  labels = c("Full cohort", "FC cohort", "FFQ cohort")
)

table1(
  ~ Location +
    L4 +
    HBI +
    PRO2 +
    Behaviour +
    Perianal +
    Surgery +
    Smoke +
    ECigs |
    cohort,
  data = comp,
  render.continuous = my.render.cont,
  overall = FALSE
)
```

#### Associations between Crohn's Disease-only variables and cohort membership

None of the CD-only variables were found to significantly differ across cohorts. 

##### Montreal location

```{R}
pander(fisher.test(comp$Location, comp$cohort, workspace = 200000000))
```

##### Upper gastrointestinal inflammation

```{R}
pander(chisq.test(comp$L4, comp$cohort))
```

##### Harvey-Bradshaw index

```{R}
pander(summary(aov(HBI ~ cohort, data = comp)))
```

##### PRO2

```{R}
pander(summary(aov(PRO2 ~ cohort, data = comp)))
```

##### Montreal behaviour

```{R}
pander(chisq.test(comp$Behaviour, comp$cohort))
```

##### Perianal disease

```{R}
pander(chisq.test(comp$Perianal, comp$cohort))
```

##### Surgery

```{R}
pander(chisq.test(comp$Surgery, comp$cohort))
```

##### Smoking status

```{R}
pander(chisq.test(comp$Smoke, comp$cohort))
```

##### E-cigarette use

```{R}
pander(chisq.test(comp$ECigs, comp$cohort))
```


## Variables only relevant to ulcerative colitis/IBDU subjects

This section looks at variables only relevant to UC/IBDU subjects: Montreal
extent, Mayo score, Smoking status and E-cigarette use. 

As PREdiCCt required subjects to be able to flare,
this effectively excluded UC subjects who had undergone a proctocolectomy. As
such, previous surgery is not considered. Montreal severity was not collected
by PREdiCCt.

### Montreal extent

```{R}
mapping <- data.frame(
  code = seq(1, 6),
  definition = c(
    "Rectum",
    "Recto-sigmoid",
    "< Splenic",
    "< Hepatic",
    "Total",
    "Unknown"
  ),
  mont = c(1, 2, 2, 3, 3, NA)
)

demo.uc <- subset(demo, diagnosis2 == "UC/IBDU")
redcap.uc <- subset(redcap, participantno %in% demo.uc$ParticipantNo)
names(redcap.uc)[names(redcap.uc) == "participantno"] <- "ParticipantNo"
redcap.uc <- redcap.uc[, c("ParticipantNo", "max_extent")]
redcap.uc$Extent <- mapvalues(redcap.uc$max_extent,
  from = mapping$code,
  to = mapping$mont
)

demo.uc <- merge(demo.uc,
  redcap.uc[, c("ParticipantNo", "Extent")],
  by = "ParticipantNo",
  all.x = TRUE,
  all.y = FALSE
)
demo.uc$Extent <- factor(demo.uc$Extent,
  levels = seq(1, 3),
  labels = c("E1", "E2", "E3")
)
```

Montreal extent has been obtained from REDCap. Similar to Montreal location,
the extent of inflammation has been reported in more granular detail than is
required for the Montreal classification. The below table shows how these
definitions have been mapped to Montreal extent. 

```{R}
kable(mapping,
  col.names = c("Coding", "Definition", "Montreal extent"),
  align = c("l", "c", "c")
)
```

As can be seen in @fig-extent E2 is the most common Montreal extent
classification.

```{R}
#| label: fig-extent
#| fig-cap: "Montreal extent for UC/IBDU subjects in the FC cohort."

demo.uc %>%
  drop_na(cat) %>%
  ggplot(aes(x = Extent, fill = Extent, color = Extent)) +
  geom_bar() +
  xlab("Montreal extent") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#7AE7C7", "#440381", "#D64045"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#07A282", "#340165", "#942E31"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "Montreal extent"),
    color = guide_legend(title = "Montreal extent")
  )
```

Montreal extent is not associated with FC

```{R}
#| label: tbl-extent
#| tbl-cap: "Chi-squared test between Montreal extent and FC groups."
pander(chisq.test(demo.uc$Extent, demo.uc$cat))
```

### Mayo score

Mayo score was collected via REDCap and is more complete than HBI. 

```{R}
#| label: fig-mayo
#| fig-caption: "Mayo score for UC/IBDU subjects in the FC cohort."
mayo.df <- redcap[, c("participantid", "current_mayo")]
colnames(mayo.df) <- c("ParticipantId", "Mayo")
mayo.df <- subset(mayo.df, ParticipantId %in% demo.uc$ParticipantId)

demo.uc <- merge(demo.uc, mayo.df, by = "ParticipantId", all.x = TRUE)
demo.uc %>%
  drop_na(cat) %>%
  ggplot(aes(x = as.factor(Mayo))) +
  geom_bar(fill = "#284B63", color = "#153243") +
  theme_minimal() +
  ylab("Frequency") +
  xlab("Mayo score at time of recruitment")
```

Mayo score is highly significantly associated with FC. 

```{R}
#| label: tbl-mayo
#| tbl-cap: "ANOVA between between Mayo score and FC groups."
summary(aov(Mayo ~ cat, data = demo.uc))
```

### PRO-2 in ulcerative colitis

Sum of stool frequency and rectal bleeding categories. 

```{R}
PRO2 <- redcap[, c("participantno", "stool_freq", "rectal_bleed")]

PRO2$PRO2 <- with(PRO2, stool_freq + rectal_bleed)

PRO2$ParticipantNo <- PRO2$participantno
demo.uc <- merge(demo.uc,
              PRO2[, c("ParticipantNo", "PRO2")],
              by = "ParticipantNo",
              all.x = TRUE,
              all.y = FALSE)
```

```{R}
demo.uc %>%
  ggplot(aes(x = as.factor(PRO2), fill = diagnosis2, color = diagnosis2)) +
  geom_bar() +
  scale_fill_manual(values = "#FF8552", na.value = "#032B43") +
  scale_color_manual(values = "#D2632A", na.value = "#032B43") +
  theme_minimal() +
  theme(legend.position = "none")
```

### Smoking

As with CD subjects, smoking status for UC/IBDU subjects is self-reported. 

```{R}
#| label: fig-smoke-uc
#| fig-cap: "Smoking status for UC/IBDU subjects in the FC cohort."
demo.uc %>%
  drop_na(cat) %>%
  ggplot(aes(x = Smoke, fill = Smoke, color = Smoke)) +
  geom_bar() +
  xlab("Smoking status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#4E0250", "#517664", "#1C448E"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#3D003F", "#385245", "#033070"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "Smoking status"),
    color = guide_legend(title = "Smoking status")
  )
```

As with CD, smoking status is significantly associated with FC. 

```{R}
#| label: tbl-smoke-uc
#| tbl-cap: "Chi-squared test between between smoking status and FC groups for UC subjects."
pander(chisq.test(demo.uc$Smoke, demo.uc$cat))
```

### E-cigarette use

Similar to CD, very few subjects reported using E-cigarettes. 

```{R}
#| label: fig-esmoke-uc
#| fig-cap: "E-cigarette usage for UC subjects in the FC cohort."
demo.uc %>%
  drop_na(cat) %>%
  ggplot(aes(x = ECigs, fill = ECigs, color = ECigs)) +
  geom_bar() +
  xlab("E-cigarette status") +
  ylab("Frequency") +
  theme_minimal() +
  scale_fill_manual(
    values = c("#4E0250", "#517664", "#1C448E"),
    na.value = "#032B43"
  ) +
  scale_color_manual(
    values = c("#3D003F", "#385245", "#033070"),
    na.value = "#032B43"
  ) +
  guides(
    fill = guide_legend(title = "E-cigarette status"),
    color = guide_legend(title = "E-cigarette status")
  )
```

E-cigarette use was found to significantly differ between FC groups in UC.
However, the low number of subjects reported to use E-cigarettes
(@fig-esmoke-uc) should be beared in mind when interpretting this finding. 

```{R}
#| label: tbl-esmoke-uc
#| tbl-cap: "Chi-squared test between between E-cigarettte usage and FC groups for UC subjects."
pander(fisher.test(demo.uc$ECigs, demo.uc$cat))
```

### Table of ulcerative colitis/IBDU variables

```{R}
demo.uc %>%
  drop_na(cat) %>%
  table1(
    x = ~ Extent + Mayo + PRO2 + Smoke + ECigs | cat,
    render.continuous = my.render.cont
  )
```

### Table of Ulcerative colitis/IBDU variables by cohort

```{R}
comp <- demo.uc
comp$cohort <- "All"

temp <- demo.uc %>%
  drop_na(cat)
temp$cohort <- "FC"

comp <- rbind(comp, temp)

temp <- subset(demo.uc, ParticipantNo %in% FFQ$participantno)
temp$cohort <- "FFQ"

comp <- rbind(comp, temp)

comp$cohort <- factor(comp$cohort,
  levels = c("All", "FC", "FFQ"),
  labels = c("Full cohort", "FC cohort", "FFQ cohort")
)


table1(~ Extent + Mayo + PRO2 + Smoke + ECigs | cohort,
  data = comp,
  render.continuous = my.render.cont,
  overall = FALSE
)
```

#### Associations between Crohn's Disease-only variables and cohort membership

None of the UC/IBDU-only variables were found to significantly differ across
cohorts. 

##### Montreal extent

```{R}
pander(chisq.test(comp$Extent, comp$cohort))
```

##### Mayo score

```{R}
pander(summary(aov(Mayo ~ cohort, data = comp)))
```

##### PRO2

```{R}
pander(summary(aov(PRO2 ~ cohort, data = comp)))
```

##### Smoking status

```{R}
pander(chisq.test(comp$Smoke, comp$cohort))
```

##### E-cigarette use

```{R}
pander(chisq.test(comp$ECigs, comp$cohort))
```


## Colonic vs. ileal disease

```{R}
ileal.colonic <- data.frame(
  ParticipantNo = subset(demo.cd, Location == "L1")$ParticipantNo,
  type = "Ileal"
)
ileal.colonic <- rbind(
  ileal.colonic,
  data.frame(
    ParticipantNo = subset(
      demo.cd,
      Location != "L1"
    )$ParticipantNo,
    type = "Colonic"
  )
)
ileal.colonic <- rbind(
  ileal.colonic,
  data.frame(
    ParticipantNo = demo.uc$ParticipantNo,
    type = "Colonic"
  )
)
ileal.colonic <- rbind(
  ileal.colonic,
  data.frame(
    ParticipantNo = subset(
      demo.cd,
      is.na(Location)
    )$ParticipantNo,
    type = NA
  )
)

saveRDS(ileal.colonic, paste0(outdir, "ileal-colonic-flags.RDS"))
```

As differences are often reported between ileal and colonic IBD [@Atreya_2021],
a dataset will be created to identify which subjects have colonic IBD and which
subjects have ileal disease. Ileal diesease is defined as only CD subjects with
L1 Montreal location. Subjects with L2 and L3 are both defined as having colonic
disease (although ileal disease is also present in L3). If the Montreal location
of a CD subject is unknown then these subjects are coded as `NA`. All patients
with UC/IBDU have colonic disease.

@fig-bar-ileal-colonic gives the distribution of colonic and ileal disease in
the cohort. 

```{R}
#| label: fig-bar-ileal-colonic
#| fig-cap: "Ileal vs colonic disease in the study cohort."

ileal.colonic <- merge(ileal.colonic,
  demo[, c("ParticipantNo", "cat")],
  by = "ParticipantNo"
)

ileal.colonic %>%
  drop_na(cat) %>%
  ggplot(aes(x = type, fill = type)) +
  geom_bar() +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_manual(
    values = c("#03CEA4", "#FB4D3D"),
    na.value = "#032B43"
  ) +
  ylab("Frequency") +
  xlab("Disease type")
```

## Data save

```{R}
demo %>%
  drop_na(cat) %>%
  saveRDS(paste0(outdir, "demo.RDS"))

demo %>%
  saveRDS(paste0(outdir, "demo-full.RDS"))

subset(demo, ParticipantNo %in% FFQ$participantno) %>%
  saveRDS(paste0(outdir, "demo-FFQ.RDS"))


demo.cd %>%
  drop_na(cat) %>%
  saveRDS(paste0(outdir, "demo-cd.RDS"))

demo.uc %>%
  drop_na(cat) %>%
  saveRDS(paste0(outdir, "demo-uc.RDS"))
```

The processed baseline data have been saved for downstream analyses. 

<details class = "appendix">
  <summary> Session info </summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>


## Reuse {.appendix}

Licensed by 
<a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a>
 unless otherwise stated.
 
## {.appendix}

<div>
  <img class = "center" style="padding-left:200px" src="../images/PREdiCCtlogo.png" alt="The PREdiCCt study logo" height = 200px> <br>
  <img style="padding-right:25px;padding-left:115px" src="../images/cgem-logo.png" alt="Centre for Genomic & Experimental Medicine logo" height = 50px>
  <img class = "center" src="../images/MRC_HGU_Edinburgh RGB.png" alt="MRC Human Genetics Unit logo" height = 50px>
</div>

<br> <em> Kindly supported by </em>

<div>
<a href = "https://www.ukri.org/"><img class = "center" style="padding-left: 25px" src="../images/UKRI.png" alt="UK Research and Innovation" height = 65px> </a>
<a href = "https://www.cso.scot.nhs.uk/"><img class = "center" src="../images/CSO-Accord.jpg" alt="The Chief Scientist Office" height = 65px> </a>
<a href = "https://crohnsandcolitis.org.uk/"><img class = "center" src="../images/CCUK.png" alt="Crohn's and Colitis UK" height = 65px> </a>
<a href = "https://curecrohnscolitis.org/"><img class = "center" src="../images/C3.png" alt=" Cure Crohn's colitis" height = 65px></a>
</div>

---

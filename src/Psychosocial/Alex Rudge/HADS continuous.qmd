---
title: "Hospital Anxiety and Depression Scale (HADS)"
author:
  - name: "Chiara Cotronei"
    url: https://www.research.ed.ac.uk/en/persons/chiara-cotronei
    affiliations:
      - ref: Lothian
  - name: "Alex Rudge"
    affiliations:
      - ref: CGEM
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      - ref: CGEM
      - ref: HGU
format: 
  html:
    code-fold: true
    code-tools: true
editor: visual
toc: true
toc-expand: true
---

# Hospital Anxiety and Depression Scale

## Setting up in R

R packages

```{r}
knitr::opts_chunk$set(echo = TRUE, error = FALSE, warning = TRUE)
options(dplyr.summarise.inform = FALSE)

library(plyr) # Used for mapping values
suppressPackageStartupMessages(library(tidyverse)) # ggplot2, dplyr, and magrittr
library(readxl) # Read in Excel files
library(datefixR) # Standardise dates  
library(openxlsx)
library(tidyr)
library(ggdist)
suppressPackageStartupMessages(library(rstatix))
suppressPackageStartupMessages(library(table1))
library(knitr)
library(pander)
suppressPackageStartupMessages(library(kableExtra))
# Generate flowchart of cohort derivation
library(DiagrammeR)
library(DiagrammeRsvg)

#cox-regression
library(survival)
suppressPackageStartupMessages(library(survminer))
library(finalfit)
```

Helper functions

```{r}
# Chi squared tests
summon_chisq_test <- function(data, dependent, independent) {
  
  # Chi square tests/Fisher's exact test for the dependent variable vs each independent variable
  
  purrr::map2_df(
    .x = dependent,
    .y = independent,
    .f = function(.x, .y) {
      x <- data %>%
        dplyr::pull(.x)
      
      y <- data %>%
        dplyr::pull(.y)
      
      # Check whether we need a Fisher test
      fisher_flag <- data %>%
        # Count combinations of x and y
        dplyr::count(!!rlang::sym(.x), !!rlang::sym(.y)) %>%
        # Pull the count
        dplyr::pull(n) %>%
        # Check if any counts are < 5
        min() < 5
        
      if (fisher_flag){
        # If one of the counts is < 5 use Fisher exact test
        fisher_test(table(x, y), simulate.p.value = TRUE, B = 1e5) %>%
          dplyr::mutate(
            dependent = .x, 
            independent = .y,
            method = 'Fisher\'s exact test')
        
      } else {    
        # Otherwise use chi square
        chisq_test(x = x, y = y) %>%
          dplyr::mutate(dependent = .x, independent = .y)
      }
    }
  ) %>%
    dplyr::mutate(p.adjust = p.adjust(p = p, method = 'holm')) %>%
    dplyr::mutate(p.adjust = signif(p.adjust, 3)) %>%
    dplyr::select(-p.signif) %>%
    dplyr::mutate(
      p.signif = dplyr::case_when(
        p.adjust < 0.0001 ~ "****",
        p.adjust < 0.001 ~ "***",
        p.adjust < 0.01  ~ "**",
        p.adjust < 0.05  ~ "*",
        .default = 'ns'
      )
    )
}


print_chisq <- function(data) {
  data %>%
    knitr::kable(digits = c(0, 2, 4, 0, NA, NA, NA, 4, NA),
                 col.names = c("n",
                               "Statistic",
                               "p",
                               "df",
                               "Method",
                               "Dependent",
                               "Independent",
                               "Adjusted p-value",
                               "Adjusted significance")
               )
}

print_survival <- function(data) {
  data %>%
    broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>%
    knitr::kable(digits = 3,
                 col.names = c("Covariate",
                               "Estimate",
                               "Std. Error",
                               "Statistic",
                               "p value",
                               "Lower CI",
                               "Upper CI")
                 )
}


# Creating proportions for plotting baseline data
calc_proportion <- function(data, dependent, independent){
  
  data %>%
    dplyr::group_by(!!rlang::sym(independent), !!rlang::sym(dependent)) %>%
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::group_by(!!rlang::sym(independent)) %>%
    dplyr::mutate(p = n/sum(n)) 
  
}

summon_baseline_plots <- function(data, dependent, independent) {
  
  # Chi squared tests
  chisq_results <- summon_chisq_test(
    data = data,
    dependent = dependent,
    independent = independent
  ) %>%
    dplyr::transmute(independent, p.adjust) %>%
    {setNames(as.list(.$p.adjust), .$independent)}

  
  # Creating plots for baseline variables with the dependent variable
  
  plot_list <- list()
  
  for (y in independent) {
    
    # Create a plot for each independent variable
    
    plot <- data %>%
      calc_proportion(., dependent = dependent, independent = y) %>%
      ggplot(aes(x = .data[[dependent]], y = p, fill = .data[[y]])) +
      geom_col(position = 'dodge') +
      annotate(
        "text",
        label = paste0("Adjusted p-value: ", chisq_results[[y]]),
        x = Inf,
        y = Inf,
        vjust = 2,
        hjust = 1.3
      ) +
      theme_minimal()
    
    plot_list[[y]] <- plot
    
  }
  # Return the plots
  plot_list
}
```

Load data

```{r}
# paths to PREdiCCt data
if (file.exists("/.dockerenv")) {
  # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed"
} else {
  # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
  chiara <- "/Volumes/igmm/cvallejo-predicct/people/chiara/"
}

#read-in data
#hads is question 42 of the baseline questionnaire
hads <- read.xlsx(paste0(data.path, "Baseline2022/hads.xlsx"))
health <- read.xlsx(paste0(data.path, "Baseline2022/health.xlsx"))
demographics <- read.xlsx(paste0(data.path, "Baseline2022/demographics2022.xlsx"))
lifeevents <- read.xlsx(paste0(data.path, "Baseline2022/lifeevents.xlsx"))
IBD <- read.xlsx(paste0(data.path, "Baseline2022/IBD.xlsx"))
ffq <- read.xlsx(paste0(prefix, "predicct ffq_nutrientfood groupDQI all foods_data (n1092)Nov2022.xlsx"))
demo <- readRDS(paste0(outdir, "demo.RDS"))
flares <- readRDS(paste0(outdir, "flares/cutoff-flares.RDS"))
IBD_C <- readRDS(paste0(chiara, "IBD_C.RDS"))
IBD_FC <- readRDS(paste0(chiara, "IBD_FC.RDS"))
flares_soft <- readRDS(paste0(chiara, "flares_soft.RDS"))
flares_hard <- readRDS(paste0(chiara, "flares_hard.RDS"))
```

## Data Cleaning

```{r}
# Exclude cases with missing ParticipantId
# 60 removed - but they are all completely empty rows.
hads <- hads %>%
  filter(!is.na(ParticipantId))

health <- health %>%
  filter(!is.na(ParticipantId))

demographics <- demographics %>% 
  filter(!is.na(ParticipantId))

IBD <- IBD %>% 
  filter(!is.na(ParticipantId))

# join demographics
hads_with_demographics <- hads %>%
  dplyr::left_join(demographics %>%
                     dplyr::select(ParticipantNo, Sex, age, diagnosis),
                   by = "ParticipantNo")

# Convert diagnosis column to factor with labels
hads_with_demographics %<>%
  dplyr::mutate(
    diagnosis2 = dplyr::case_when(
      diagnosis == 1 ~ 1,
      diagnosis == 2 ~ 2,
      diagnosis == 3 ~ 2,
      diagnosis == 4 ~ 2
    )
  ) %>%
  dplyr::mutate(
    diagnosis2 = factor(
      diagnosis2,
      levels = c("1", "2"), 
      labels = c("CD", "UC/IBDU")
    )
  )

hads_with_demographics %<>%
  dplyr::mutate(Sex = factor(
    Sex,
    levels = c(1, 2),
    labels = c("Male", "Female")
  )
)

#exclude participants <17, 53 participants excluded, tot 1847

n_underage <- hads_with_demographics %>%
  dplyr::filter(age <= 17) %>%
  nrow()

hads_with_demographics %<>%
  dplyr::filter(age > 17)


#delete missing data, 9 participants, total 1838

n_missing_hads <- hads_with_demographics %>%
  dplyr::filter(
    dplyr::if_any(.cols = 7:20, .fns = is.na)
  ) %>%
  nrow()

hads_with_demographics %<>%
  dplyr::filter(
    !dplyr::if_any(.cols = 7:20, .fns = is.na)
  )

# Rescale
hads_with_demographics %<>%
  dplyr::mutate(
    dplyr::across(
      .cols = FeelTense:CanEnjoyBookTV,
      .fns = ~. - 1)
  )
  
#correcting inversely coded HADS
hads_with_demographics %<>%
  dplyr::mutate(
    dplyr::across(
      .cols = c("FeelTense", 
                 "FrightenedFeelingSomethingAwful", 
                 "WorryingThoughts", 
                 "FeelCheerful", 
                 "FeelSlowedDown",
                 "LostInterestAppearance",
                 "FeelRestless",
                 "SuddenFeelingsPanic"),
      .fns = ~ 3 - .
    )
  )

#anxiety HADS composite score
hads_with_demographics %<>% 
  dplyr::mutate(anxiety_hads = FeelTense + 
           FrightenedFeelingSomethingAwful + 
           WorryingThoughts +
           SitAtEase +
           FrightenedFeelingButterflies +
           FeelRestless +
           SuddenFeelingsPanic)

#depression HADS composite score
hads_with_demographics %<>% 
  dplyr::mutate(depression_hads = EnjoyThings +
           CanLaugh +
           FeelCheerful +
           FeelSlowedDown +
           LostInterestAppearance +
           LookForward +
           CanEnjoyBookTV)

#remove breakdown hads columns
hads_with_demographics %<>%
  dplyr::select(-c(FeelTense:CanEnjoyBookTV))


#create age groups
hads_with_demographics %<>%
  dplyr::mutate(AgeGroup = cut(
    age,
    breaks = c(18, 24, 34, 44, 54, 65, Inf),
    labels = c("18-24", "25-34", "35-44", "45-54", "55-64", "65+"),
    include.lowest = TRUE
  ))


#add FC data and exclude missing FC
hads_with_demographics <- hads_with_demographics %>% 
  dplyr::left_join(
    demo %>% dplyr::select(ParticipantNo, FC, cat, IMD, Smoke), 
    by = "ParticipantNo")

# n_missing_fc <- hads_with_demographics %>% 
#   filter(is.na(cat)) %>%
#   nrow()
# 209 removed with no FC

# hads_with_demographics <- hads_with_demographics %>%
#   filter(!is.na(cat))

#Join flare data
hads_with_demographics <- hads_with_demographics %>% 
  dplyr::left_join(
    IBD %>% select(ParticipantNo, FlaresInPastYear), 
    by = "ParticipantNo"
    )

#create flare groups
hads_with_demographics <- hads_with_demographics %>%
  dplyr::mutate(
    flare_group = ifelse(FlaresInPastYear == 0, "No flares", "1 or More Flares")
    )

#make flares into levels
hads_with_demographics %<>%
  dplyr::mutate(flare_group = factor(flare_group, levels = c("No flares", "1 or More Flares")))

# Remove subjects with missing flare group data - 3 subjects
# hads_with_demographics <- hads_with_demographics %>% 
#   filter(!is.na(flare_group))

#create hads_for_analysis which has new variable 'hads_type' for anxiety and depression hads
hads_for_analysis <- hads_with_demographics %>%
  tidyr::pivot_longer(
    cols = c(anxiety_hads, depression_hads),
    names_to = "hads_type", values_to = "hads_score"
  ) 

#score groups
hads_for_analysis <- hads_for_analysis %>% 
  mutate(
    score_group = cut(
      hads_score, 
      breaks = c(0, 7, 10, 21), 
      labels = c("0-7", "8-10", "11-21"), 
      include.lowest = TRUE)
  )

# IBD control scores
hads_for_analysis %<>%
  dplyr::left_join(
    IBD_C %>% dplyr::select(
      ParticipantNo,
      control_score,
      OverallControl,
      control_8,
      control_grouped,
      vas_control
    ),
    by = "ParticipantNo"
  )

#change control_grouped and vas_control from character into factors
hads_for_analysis %<>% 
  dplyr::mutate(control_grouped = factor(control_grouped))

hads_for_analysis %<>% 
  dplyr::mutate(vas_control = factor(vas_control))


# Age in decades
hads_for_analysis %<>%
  dplyr::mutate(
    age_decade = age/10
  )


# FC maximum detectable value is 1250
hads_for_analysis %<>%
  dplyr::mutate(
    FC = dplyr::case_when(
      FC > 1250 ~ 1250,
      .default = FC
    )
  )

# Log transform FC due to extreme positive skew
hads_for_analysis %<>%
  dplyr::mutate(
    FC = log(FC)
  )

```

## Baseline Analysis

### Anxiety

#### Full Cohort

```{r}
# Select anxiety data
data_baseline_anxiety <- hads_for_analysis %>%
  dplyr::filter(hads_type == 'anxiety_hads')

# Independent variables
independent = c('diagnosis2',
                'age',
                'Sex',
                'flare_group',
                'FC',
                'OverallControl')

# Dependent variable is score_group

# Statistical tests for each independent variable with score_group
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_anxiety, 
  dependent = 'score_group', 
  independent = independent)

statistical_tests

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_anxiety,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'diagnosis2'
)

summon_baseline_plot_discrete(
  data = data_baseline_anxiety,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_anxiety,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'flare_group'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'FC'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'OverallControl'
)
```

#### Ulcerative Colitis/IBD Unclassified

```{r}
# Select anxiety data and UC patients
data_baseline_anxiety_uc <- hads_for_analysis %>%
  dplyr::filter(hads_type == 'anxiety_hads') %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# Independent variables
independent = c('age',
                'Sex',
                'flare_group',
                'FC',
                'OverallControl')

# Dependent variable is score_group

# Statistical tests for each independent variable with score_group
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_anxiety_uc, 
  dependent = 'score_group', 
  independent = independent)

statistical_tests

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_anxiety_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_anxiety_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'flare_group'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'FC'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'OverallControl'
)
```

#### Crohn's Disease

```{r}
# Select anxiety data and CD patients
data_baseline_anxiety_cd <- hads_for_analysis %>%
  dplyr::filter(hads_type == 'anxiety_hads') %>%
  dplyr::filter(diagnosis2 == 'CD')

# Dependent variable is score_group

# Statistical tests for each independent variable with score_group
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_anxiety_cd, 
  dependent = 'score_group', 
  independent = independent)

statistical_tests

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_anxiety_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_anxiety_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'flare_group'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'FC'
)

summon_baseline_plot_continuous(
  data = data_baseline_anxiety_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'OverallControl'
)
```

### Depression

#### Full Cohort

```{r}
# Select depression data
data_baseline_depression <- hads_for_analysis %>%
  dplyr::filter(hads_type == 'depression_hads')

# Independent variables
independent = c('diagnosis2',
                'age',
                'Sex',
                'flare_group',
                'FC',
                'OverallControl')

# Dependent variable is score_group

# Statistical tests for each independent variable with score_group
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_depression, 
  dependent = 'score_group', 
  independent = independent)

statistical_tests

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_depression,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_depression,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'flare_group'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'FC'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'OverallControl'
)
```

#### Ulcerative Colitis/IBD Unclassified

```{r}
# Select depression data and UC patients
data_baseline_depression_uc <- hads_for_analysis %>%
  dplyr::filter(hads_type == 'depression_hads') %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# Independent variables
independent = c('age',
                'Sex',
                'flare_group',
                'FC',
                'OverallControl')

# Dependent variable is score_group

# Statistical tests for each independent variable with score_group
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_depression_uc, 
  dependent = 'score_group', 
  independent = independent)

statistical_tests

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_depression_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_depression_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'flare_group'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'FC'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression_uc,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'OverallControl'
)
```

#### Crohn's Disease

```{r}
# Select depression data and CD patients
data_baseline_depression_cd <- hads_for_analysis %>%
  dplyr::filter(hads_type == 'depression_hads') %>%
  dplyr::filter(diagnosis2 == 'CD')

# Dependent variable is score_group

# Statistical tests for each independent variable with score_group
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_depression_cd, 
  dependent = 'score_group', 
  independent = independent)

statistical_tests

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_depression_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_depression_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'flare_group'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'FC'
)

summon_baseline_plot_continuous(
  data = data_baseline_depression_cd,
  stat_tests = statistical_tests,
  dependent = 'score_group',
  independent = 'OverallControl'
)
```

## Survival Analysis

### Data Cleaning

```{r}
# Survival data
# Join HADS with flare data
# Patient reported
data_survival_soft <- hads_for_analysis %>% dplyr::inner_join(
    flares_soft %>% dplyr::select(ParticipantNo, softflare, softflare_time),
    by = 'ParticipantNo'
  ) %>%
  dplyr::mutate(DiseaseFlareYN = softflare, time = softflare_time)

# Anxiety soft
data_survival_anxiety_soft <- data_survival_soft %>%
  dplyr::filter(hads_type == 'anxiety_hads')

# UC
data_survival_anxiety_soft_uc <- data_survival_anxiety_soft %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# CD
data_survival_anxiety_soft_cd <- data_survival_anxiety_soft %>%
  dplyr::filter(diagnosis2 == 'CD')


# Depression soft
data_survival_depression_soft <- data_survival_soft %>%
  dplyr::filter(hads_type == 'depression_hads')

# UC
data_survival_depression_soft_uc <- data_survival_depression_soft %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# CD
data_survival_depression_soft_cd <- data_survival_depression_soft %>%
  dplyr::filter(diagnosis2 == 'CD')


# Hard flares
data_survival_hard <- hads_for_analysis %>% dplyr::inner_join(
    flares_hard %>% dplyr::select(ParticipantNo, hardflare, hardflare_time),
    by = 'ParticipantNo'
  ) %>%
  dplyr::mutate(DiseaseFlareYN = hardflare, time = hardflare_time)

# Anxiety soft
data_survival_anxiety_hard <- data_survival_hard %>%
  dplyr::filter(hads_type == 'anxiety_hads')

# UC
data_survival_anxiety_hard_uc <- data_survival_anxiety_hard %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# CD
data_survival_anxiety_hard_cd <- data_survival_anxiety_hard %>%
  dplyr::filter(diagnosis2 == 'CD')


# Depression soft
data_survival_depression_hard <- data_survival_hard %>%
  dplyr::filter(hads_type == 'depression_hads')

# UC
data_survival_depression_hard_uc <- data_survival_depression_hard %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# CD
data_survival_depression_hard_cd <- data_survival_depression_hard %>%
  dplyr::filter(diagnosis2 == 'CD')

```

### Shapes of continuous variables

#### Full Cohort

##### Patient reported flare

```{r}

# Cox with continuous variables
# Age
cox_age_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_anxiety_soft
)

# Spline for age
summon_lrt(cox_age_soft, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_anxiety_soft
)

# Spline for FC
summon_lrt(cox_fc_soft, remove = 'FC', add = 'ns(FC, df = 2)')
# No

# OverallControl
cox_control_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    OverallControl +
    frailty(SiteNo),
  data = data_survival_anxiety_soft
)

# Spline for control
summon_lrt(cox_control_soft, remove = 'OverallControl', add = 'ns(OverallControl, df = 2)')
# Yes

# OverallControl
cox_control_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(OverallControl, df = 2) +
    frailty(SiteNo),
  data = data_survival_anxiety_soft
)

# Spline for control
summon_lrt(cox_control_soft, remove = 'ns(OverallControl, df = 2)', add = 'ns(OverallControl, df = 3)')
# Yes

# OverallControl
cox_control_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(OverallControl, df = 3) +
    frailty(SiteNo),
  data = data_survival_anxiety_soft
)

# Spline for control
summon_lrt(cox_control_soft, remove = 'ns(OverallControl, df = 3)', add = 'ns(OverallControl, df = 4)')
# No, df = 3 is sufficient

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_anxiety_soft, 
  model = cox_age_soft, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_anxiety_soft, 
  model = cox_fc_soft, 
  variable = 'FC')

# Control
plot_continuous_hr(
  data = data_survival_anxiety_soft, 
  model = cox_control_soft, 
  variable = 'OverallControl',
  splineterm = 'ns(OverallControl, df = 3)')
```


##### Objective flare

```{r}

# Age
cox_age_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_anxiety_hard
)

# Spline for age
summon_lrt(cox_age_hard, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_anxiety_hard
)

# Spline for FC
summon_lrt(cox_fc_hard, remove = 'FC', add = 'ns(FC, df = 2)')
# No

# OverallControl
cox_control_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    OverallControl +
    frailty(SiteNo),
  data = data_survival_anxiety_hard
)

# Spline for control
summon_lrt(cox_control_hard, remove = 'OverallControl', add = 'ns(OverallControl, df = 2)')
# No
```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_anxiety_hard, 
  model = cox_age_hard, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_anxiety_hard, 
  model = cox_fc_hard, 
  variable = 'FC')

# Control
plot_continuous_hr(
  data = data_survival_anxiety_soft, 
  model = cox_control_hard, 
  variable = 'OverallControl')
```

#### Ulcerative Colitis

##### Patient reported flare

```{r}
# Age
cox_age_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_uc
)

# Spline for age
summon_lrt(cox_age_soft_uc, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_uc
)

# Spline for FC
summon_lrt(cox_fc_soft_uc, remove = 'FC', add = 'ns(FC, df = 2)')
# No

# OverallControl
cox_control_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    OverallControl +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_uc
)

# Spline for control
summon_lrt(cox_control_soft_uc, remove = 'OverallControl', add = 'ns(OverallControl, df = 2)')
# Yes

# OverallControl
cox_control_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(OverallControl, df = 2) +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_uc
)

summon_lrt(cox_control_soft_uc, remove = 'ns(OverallControl, df = 2)', add = 'ns(OverallControl, df = 3)')
# No, df = 2 is sufficient

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_anxiety_soft_uc, 
  model = cox_age_soft_uc, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_anxiety_soft_uc, 
  model = cox_fc_soft_uc, 
  variable = 'FC')

# Control
plot_continuous_hr(
  data = data_survival_anxiety_soft_uc, 
  model = cox_control_soft_uc, 
  variable = 'OverallControl',
  splineterm = 'ns(OverallControl, df = 2)')
```


##### Objective flare

```{r}

# Age
cox_age_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Spline for age
summon_lrt(cox_age_hard_uc, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# Yes

# Refit
cox_age_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(age_decade, df = 2) +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Test for df = 3
summon_lrt(cox_age_hard_uc, remove = 'ns(age_decade, df = 2)', add = 'ns(age_decade, df = 3)')
# Yes - very close to 0.05

# Refit
cox_age_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(age_decade, df = 3) +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Test for df = 4
summon_lrt(cox_age_hard_uc, remove = 'ns(age_decade, df = 3)', add = 'ns(age_decade, df = 4)')
# Yes - again very close to 0.05

# Refit
cox_age_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(age_decade, df = 4) +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Test for df = 5
summon_lrt(cox_age_hard_uc, remove = 'ns(age_decade, df = 4)', add = 'ns(age_decade, df = 5)')
# 5 df not needed, stay with 4

# FC
cox_fc_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Spline for FC
summon_lrt(cox_fc_hard_uc, remove = 'FC', add = 'ns(FC, df = 2)')
# Yes, very close to 0.05

# Refit
cox_fc_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(FC, df = 2) +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Test for df = 3
summon_lrt(cox_fc_hard_uc, remove = 'ns(FC, df = 2)', add = 'ns(FC, df = 3)')
# No, stay with df = 2


# OverallControl
cox_control_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    OverallControl +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

# Spline for control
summon_lrt(cox_control_hard_uc, remove = 'OverallControl', add = 'ns(OverallControl, df = 2)')
# No

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_anxiety_hard_uc, 
  model = cox_age_hard_uc, 
  variable = 'age_decade',
  splineterm = 'ns(age_decade, df = 4)')

# FC
plot_continuous_hr(
  data = data_survival_anxiety_hard_uc, 
  model = cox_fc_hard_uc, 
  variable = 'FC',
  splineterm = 'ns(FC, df = 2)')

# Control
plot_continuous_hr(
  data = data_survival_anxiety_hard_uc, 
  model = cox_control_hard_uc, 
  variable = 'OverallControl')
```

#### Crohn's Disease

##### Patient reported flare

```{r}

# Age
cox_age_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_cd
)

# Spline for age
summon_lrt(cox_age_soft_cd, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_cd
)

# Spline for FC
summon_lrt(cox_fc_soft_cd, remove = 'FC', add = 'ns(FC, df = 2)')
# No

# OverallControl
cox_control_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    OverallControl +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_cd
)

# Spline for control
summon_lrt(cox_control_soft_cd, remove = 'OverallControl', add = 'ns(OverallControl, df = 2)')
# Yes

# OverallControl
cox_control_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(OverallControl, df = 2) +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_cd
)

summon_lrt(cox_control_soft_cd, remove = 'ns(OverallControl, df = 2)', add = 'ns(OverallControl, df = 3)')
# No, df = 2 is sufficient

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_anxiety_soft_cd, 
  model = cox_age_soft_cd, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_anxiety_soft_cd, 
  model = cox_fc_soft_cd, 
  variable = 'FC')

# Control
plot_continuous_hr(
  data = data_survival_anxiety_soft_cd, 
  model = cox_control_soft_cd, 
  variable = 'OverallControl',
  splineterm = 'ns(OverallControl, df = 2)')
```

##### Objective flare

```{r}

# Age
cox_age_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_cd
)

# Spline for age
summon_lrt(cox_age_hard_cd, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_cd
)

# Spline for FC
summon_lrt(cox_fc_hard_cd, remove = 'FC', add = 'ns(FC, df = 2)')
# No

# OverallControl
cox_control_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    OverallControl +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_cd
)

# Spline for control
summon_lrt(cox_control_hard_cd, remove = 'OverallControl', add = 'ns(OverallControl, df = 2)')
# No
```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_anxiety_hard_cd, 
  model = cox_age_hard_cd, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_anxiety_hard_cd, 
  model = cox_fc_hard_cd, 
  variable = 'FC')

# Control
plot_continuous_hr(
  data = data_survival_anxiety_hard_cd, 
  model = cox_control_hard_cd, 
  variable = 'OverallControl')
```


Summary:

Full cohort, soft, control df = 3, hard, no.

UC, soft, control df = 2. Hard, age df = 4, FC df = 2.

CD, soft, control df = 2. Hard, no splines.

### Anxiety

#### Full Cohort

##### Patient reported flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_anxiety_soft %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_anxiety_soft, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Anxiety Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_anxiety_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 3) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_soft
)

cox_anxiety_soft %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_anxiety_soft_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_soft,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_anxiety_soft <- with(
  cox_anxiety_soft_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      ns(OverallControl, df = 3) +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_anxiety_soft %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_anxiety_hard %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_anxiety_hard, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Anxiety Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_anxiety_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_hard
)

cox_anxiety_hard %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
cox_anxiety_hard_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_hard,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_anxiety_hard <- with(
  cox_anxiety_hard_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      OverallControl +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_anxiety_hard %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

#### Ulcerative Colitis

##### Patient reported flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_anxiety_soft_uc %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_anxiety_soft_uc, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Anxiety Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_anxiety_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 2) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_uc
)

cox_anxiety_soft_uc %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_anxiety_soft_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_uc,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_anxiety_soft_uc <- with(cox_anxiety_soft_uc_mice,
     coxph(
       Surv(time, DiseaseFlareYN) ~
         score_group +
         IMD +
         Sex +
         age_decade +
         FC +
         flare_group +
         ns(OverallControl, df = 2) +
         Smoke +
         frailty(SiteNo)
     )) %>%
  mice::pool()

cox_anxiety_soft_uc %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_anxiety_hard_uc %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_anxiety_hard_uc, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Anxiety Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_anxiety_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    ns(age_decade, df = 4) +
    ns(FC, df = 2) +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc
)

cox_anxiety_hard_uc %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
# Note: mice does not support splines so I cannot impute using a spline.
cox_anxiety_hard_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_uc,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_anxiety_hard_uc <- with(cox_anxiety_hard_uc_mice,
     coxph(
       Surv(time, DiseaseFlareYN) ~
         score_group +
         IMD +
         Sex +
         ns(age_decade, df = 4) +
         ns(FC, df = 2) +
         flare_group +
         OverallControl +
         Smoke +
         frailty(SiteNo)
     )) %>%
  mice::pool()

cox_anxiety_hard_uc %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

#### Crohn's Disease

##### Patient reported flare.

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_anxiety_soft_cd %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_anxiety_soft_cd, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Anxiety Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_anxiety_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 2) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_cd
)

cox_anxiety_soft_cd %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_anxiety_soft_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_soft_cd,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_anxiety_soft_cd <- with(cox_anxiety_soft_cd_mice,
     coxph(
       Surv(time, DiseaseFlareYN) ~
         score_group +
         IMD +
         Sex +
         age_decade +
         FC +
         flare_group +
         ns(OverallControl, df = 2) +
         Smoke +
         frailty(SiteNo)
     )) %>%
  mice::pool()

cox_anxiety_soft_cd %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_anxiety_hard_cd %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_anxiety_hard_cd, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Anxiety Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_anxiety_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_cd
)

cox_anxiety_hard_cd %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
cox_anxiety_hard_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_anxiety_hard_cd,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_anxiety_hard_cd <- with(
  cox_anxiety_hard_cd_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      OverallControl +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_anxiety_hard_cd %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

### Depression

#### Full Cohort

##### Patient reported flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_soft %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_soft, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 3) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft
)

cox_depression_soft %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_soft_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_soft <- with(
  cox_depression_soft_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      ns(OverallControl, df = 3) +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_depression_soft %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_hard %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_hard, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard
)

cox_depression_hard %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_hard_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_hard <- with(
  cox_depression_hard_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      OverallControl +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_depression_hard %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

#### Ulcerative Colitis

##### Patient reported flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_soft_uc %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_soft_uc, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 2) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_uc
)

cox_depression_soft_uc %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_soft_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_uc,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_soft_uc <- with(cox_depression_soft_uc_mice,
                            coxph(
                              Surv(time, DiseaseFlareYN) ~
                                score_group +
                                IMD +
                                Sex +
                                age_decade +
                                FC +
                                flare_group +
                                ns(OverallControl, df = 2) +
                                Smoke +
                                frailty(SiteNo)
                            )) %>%
  mice::pool()

cox_depression_soft_uc %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_hard_uc %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_hard_uc, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    ns(age_decade, df = 4) +
    ns(FC, df = 2) +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_uc
)

cox_depression_hard_uc %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
# Note: mice does not support splines so I cannot impute using a spline.
cox_depression_hard_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_uc,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_hard_uc <- with(cox_depression_hard_uc_mice,
                            coxph(
                              Surv(time, DiseaseFlareYN) ~
                                score_group +
                                IMD +
                                Sex +
                                ns(age_decade, df = 4) +
                                ns(FC, df = 2) +
                                flare_group +
                                OverallControl +
                                Smoke +
                                frailty(SiteNo)
                            )) %>%
  mice::pool()

cox_depression_hard_uc %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

#### Crohn's Disease

##### Patient reported flare.

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_soft_cd %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_soft_cd, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 2) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_cd
)

cox_depression_soft_cd %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_soft_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_cd,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_soft_cd <- with(cox_depression_soft_cd_mice,
                            coxph(
                              Surv(time, DiseaseFlareYN) ~
                                score_group +
                                IMD +
                                Sex +
                                age_decade +
                                FC +
                                flare_group +
                                ns(OverallControl, df = 2) +
                                Smoke +
                                frailty(SiteNo)
                            )) %>%
  mice::pool()

cox_depression_soft_cd %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_hard_cd %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_hard_cd, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS Depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_cd
)

cox_depression_hard_cd %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_hard_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_cd,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_hard_cd <- with(
  cox_depression_hard_cd_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      OverallControl +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_depression_hard_cd %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```


## Additional Analysis

### Depression Grouped

Repeating survival analysis with moderate (8-10) and severe (11-21) depression scores grouped into a single category (8-21).

```{r}
# Combine categoires

data_survival_depression_soft_uc %<>%
  mutate(score_group = case_when(
    score_group %in% c("8-10", "11-21") ~ "8-21",
    TRUE ~ score_group
  ))

data_survival_depression_hard_uc %<>%
  mutate(score_group = case_when(
    score_group %in% c("8-10", "11-21") ~ "8-21",
    TRUE ~ score_group
  ))

data_survival_depression_soft_cd %<>%
  mutate(score_group = case_when(
    score_group %in% c("8-10", "11-21") ~ "8-21",
    TRUE ~ score_group
  ))

data_survival_depression_hard_cd %<>%
  mutate(score_group = case_when(
    score_group %in% c("8-10", "11-21") ~ "8-21",
    TRUE ~ score_group
  ))

```

#### Full Cohort

##### Patient reported flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_soft %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_soft, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 3) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft
)

cox_depression_soft %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_soft_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_soft <- with(
  cox_depression_soft_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      ns(OverallControl, df = 3) +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_depression_soft %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_hard %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_hard, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard
)

cox_depression_hard %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_hard_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_hard <- with(
  cox_depression_hard_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      OverallControl +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_depression_hard %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

#### Ulcerative Colitis

##### Patient reported flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_soft_uc %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_soft_uc, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 2) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_uc
)

cox_depression_soft_uc %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_soft_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_uc,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_soft_uc <- with(cox_depression_soft_uc_mice,
                            coxph(
                              Surv(time, DiseaseFlareYN) ~
                                score_group +
                                IMD +
                                Sex +
                                age_decade +
                                FC +
                                flare_group +
                                ns(OverallControl, df = 2) +
                                Smoke +
                                frailty(SiteNo)
                            )) %>%
  mice::pool()

cox_depression_soft_uc %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_hard_uc %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_hard_uc, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    ns(age_decade, df = 4) +
    ns(FC, df = 2) +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_uc
)

cox_depression_hard_uc %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
# Note: mice does not support splines so I cannot impute using a spline.
cox_depression_hard_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_uc,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_hard_uc <- with(cox_depression_hard_uc_mice,
                            coxph(
                              Surv(time, DiseaseFlareYN) ~
                                score_group +
                                IMD +
                                Sex +
                                ns(age_decade, df = 4) +
                                ns(FC, df = 2) +
                                flare_group +
                                OverallControl +
                                Smoke +
                                frailty(SiteNo)
                            )) %>%
  mice::pool()

cox_depression_hard_uc %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```

#### Crohn's Disease

##### Patient reported flare.

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_soft_cd %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_soft_cd, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    ns(OverallControl, df = 2) +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_cd
)

cox_depression_soft_cd %>%
  print_survival()

```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_soft_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_soft_cd,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_soft_cd <- with(cox_depression_soft_cd_mice,
                            coxph(
                              Surv(time, DiseaseFlareYN) ~
                                score_group +
                                IMD +
                                Sex +
                                age_decade +
                                FC +
                                flare_group +
                                ns(OverallControl, df = 2) +
                                Smoke +
                                frailty(SiteNo)
                            )) %>%
  mice::pool()

cox_depression_soft_cd %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)

```

##### Objective flare

```{r}
# Patient reported flare
# Kaplan Meier
data_survival_depression_hard_cd %>%
  survfit(Surv(time, DiseaseFlareYN) ~ score_group, data = .) %>%
  ggsurvplot(
    ., 
    data = data_survival_depression_hard_cd, 
    conf.int = TRUE, 
    risk.table = TRUE,
    pval = TRUE,
    pval.method = TRUE,
    legend.title = 'HADS depression Score',
    xlab = "Time from study recruitment (days)",
    ggtheme = theme_minimal())

# Cox model
cox_depression_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_cd
)

cox_depression_hard_cd %>%
  print_survival()
```

```{r}
# Cox model with MICE
# Run the mice
cox_depression_hard_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    score_group +
    IMD +
    Sex +
    age_decade +
    FC +
    flare_group +
    OverallControl +
    Smoke +
    frailty(SiteNo),
  data = data_survival_depression_hard_cd,
  m = 10,
  printFlag = FALSE
)

# Fit the Cox
cox_depression_hard_cd <- with(
  cox_depression_hard_cd_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      score_group +
      IMD +
      Sex +
      age_decade +
      FC +
      flare_group +
      OverallControl +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_depression_hard_cd %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE)
```



## Reproduction and reproducibility {.appendix}

<details class="appendix">

<summary>Session info</summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by <a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a> unless otherwise stated.

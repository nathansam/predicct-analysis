---
title: "Pittsburgh Sleep Quality Index"
author:
  - name: "Chiara Cotronei"
    affiliations:
      #- ref: Lothian
  - name: "Alexander Rudge"
    affiliations:
      #- ref: CGEM
  - name: "Nathan Constantine-Cooke"
    corresponding: true
    url: https://scholar.google.com/citations?user=2emHWR0AAAAJ&hl=en&oi=ao
    affiliations:
      #- ref: CGEM
      #- ref: HGU
format: 
  html:
    code-fold: true
    code-tools: true
editor: visual
toc: true
toc-depth: 4
toc-expand: true
---

# Pittsburgh Sleep Quality Index

Participants completed the Pittsburgh Sleep Quality Index (PSQI) at baseline. Scores were calculated in accordance with the questionnaire’s scoring guidelines, with values \>5 indicating evidence of sleep disturbance. In this analysis, our aim was to determine the extent to which sleep disturbance is associated with subsequent patient-reported and objective flares.

## Setting up in R

R Packages

```{r}
#| label: load-libraries
#| echo: false
#| message: false
#| warning: false
set.seed(123)
library(plyr) # Used for mapping values
suppressPackageStartupMessages(library(tidyverse))
library(readxl) # Read in Excel files
library(datefixR) # Standardise dates
library(openxlsx)
library(tidyr)
library(ggdist)
library(rstatix)

suppressPackageStartupMessages(library(table1))
library(knitr)
library(pander)
library(kableExtra)

# Generate flowchart of cohort derivation
library(DiagrammeR)
library(DiagrammeRsvg)

# cox-regression
library(survival)
library(survminer)
library(finalfit)

library(mice)
library(splines)
library(naniar)
library(ggmice)
```

## Helper functions

```{r}

summon_statistical_test <- function(data, dependent, independent) {
  
  # Chi square tests/Fisher's exact test/Wilcox/Kruskal-Wallis
  # for the dependent variable vs each independent variable
  # Dependent variables must be discrete
  
  purrr::map2_df(
    .x = independent,
    .y = dependent,
    .f = function(.x, .y) {
      # Remove NA
      data %<>%
        dplyr::filter(!is.na(!!sym(.x)), !is.na(!!sym(.y)))
      
      x <- data %>%
        dplyr::pull(.x)
      
      y <- data %>%
        dplyr::pull(.y)
      
      # Check if x is continuous (numeric) or not
      continuous_flag <- is.numeric(x)
      
      # If continuous, use a Wilcox/Mann Whitney if y has 2 levels
      # or Kruskal Wallis if >2
      n_levels_y <- levels(y) %>% length()
      
      if (continuous_flag & (n_levels_y <= 2)) {
        # Wilcoxon
        
        # Formula as score ~ group
        test_formula <- as.formula(paste0(.x, " ~ ", .y))
        
        wilcox_test(data, formula = test_formula) %>%
          # Calculate n for consistency with kruskal_test
          dplyr::mutate(n = n1 + n2) %>%
          # Don't need the adjusted p values as we adjust ourselves in a second
          dplyr::select(-tidyselect::any_of(c('.y.', 'group1', 'group2', 'n1', 'n2', 'p.adj', 'p.adj.signif'))) %>%
          dplyr::mutate(x = .x,
                        y = .y,
                        method = 'Wilcox test')
        
      } else if (continuous_flag & (n_levels_y > 2)) {
        
        # Formula as score ~ group
        test_formula <- as.formula(paste0(.x, " ~ ", .y))
        
        kruskal_test(data, formula = test_formula) %>%
          dplyr::select(-.y.) %>%
          dplyr::mutate(x = .x, y = .y)
        
      } else {
        # Otherwise use categorical tests
        # Chi square
        test_result <- chisq.test(x = x, y = y)
        
        # If any expected counts are < 5 then we should use a Fisher
        fisher_flag <- any(test_result$expected < 5)

        if (fisher_flag) {
          # If one of the counts is < 5 use Fisher exact test
          fisher_test(table(x, y), simulate.p.value = TRUE, B = 1e5) %>%
            dplyr::mutate(x = .x,
                          y = .y,
                          method = 'Fisher\'s exact test')
        } else {
          chisq_test(x = x, y = y) %>%
            dplyr::mutate(x = .x, y = .y)
        }
      }
    }
  ) %>%
    dplyr::mutate(p.adjust = p.adjust(p = p, method = 'fdr')) %>%
    dplyr::mutate(p.adjust = signif(p.adjust, 3)) %>%
    dplyr::select(-tidyselect::any_of(c('p.signif'))) %>%
    dplyr::mutate(
      p.adjust.signif = dplyr::case_when(
        p.adjust < 0.0001 ~ "****",
        p.adjust < 0.001 ~ "***",
        p.adjust < 0.01  ~ "**",
        p.adjust < 0.05  ~ "*",
        .default = 'ns'
      )
    ) %>%
    # Reorder columns
    dplyr::select(
      y, x, n, statistic, df, p, p.adjust, p.adjust.signif, method
    )
  
}

# Function to create plots for baseline associations

summon_baseline_plot_discrete <- function(data, stat_tests, dependent, independent) {
  # Creating plot for baseline variables with the dependent variable
  # Discrete variables
  
  # Stat_tests is a dataframe from summon_statistical_test to get p-value info
  
  label <- stat_tests %>%
    dplyr::filter(x == independent) %>%
    {df <- .
    method <- df %>% dplyr::pull(method)
    p <- df %>% dplyr::pull(p.adjust)
    
    paste0(stringr::str_pad(method, 25, 'right'), "\n", "Adjusted p-value: ", p)
    
    }

  
  data %>%
    dplyr::filter(!is.na(!!sym(dependent)), !is.na(!!sym(independent))) %>%
    dplyr::group_by(!!rlang::sym(independent), !!rlang::sym(dependent)) %>%
    dplyr::count() %>%
    dplyr::ungroup() %>%
    dplyr::group_by(!!rlang::sym(independent)) %>%
    dplyr::mutate(p = n/sum(n)) %>%
    dplyr::ungroup() %>%
    ggplot(aes(x = !!sym(dependent), y = p, fill = !!sym(independent))) +
    geom_col(position = 'dodge') +
    annotate(
      "text",
      label = label,
      x = Inf,
      y = Inf,
      vjust = 2,
      hjust = 1.3
    ) +
    theme_minimal()
  
}


summon_baseline_plot_continuous <- function(data, stat_tests, dependent, independent) {
  # Creating plot for baseline variables with the dependent variable
  # Continuous independent variable
  
  # Stat_tests is a dataframe from summon_statistical_test to get p-value info
  label <- stat_tests %>%
    dplyr::filter(x == independent) %>%
    {df <- .
    method <- df %>% dplyr::pull(method)
    p <- df %>% dplyr::pull(p.adjust)
    
    paste0(stringr::str_pad(method, 25, 'right'), "\n", "Adjusted p-value: ", p)
    
    }
  
  # Plot
  data %>%
    dplyr::filter(
      !is.na(!!sym(dependent)),
      !is.na(!!sym(independent))
    ) %>%
    ggplot(aes(x = !!sym(independent), colour = !!sym(dependent))) +
    geom_density() +
    annotate(
      "text",
      label = label,
      x = Inf,
      y = Inf,
      vjust = 1.1,
      hjust = 1.3
    ) +
    ylab("") +
    theme_minimal()
  
}

# Creating KM curves
summon_km_curves <- function(data,
                             dependent = 1,
                             title = NULL,
                             legend.title = NULL,
                             legend.labs = NULL,
                             palette = NULL,
                             ggtheme = theme_minimal(),
                             ...) {
  
  # ggsurvplot
  plot_surv <- data %>%
    survfit(as.formula(paste0("Surv(time, DiseaseFlareYN) ~ ", dependent)), 
            data = .) %>%
    ggsurvplot(
      .,
      data = data,
      conf.int = TRUE,
      risk.table = TRUE,
      #pval = TRUE,
      #pval.method = TRUE,
      title = title,
      legend.title = legend.title,
      legend.labs = legend.labs,
      ggtheme = ggtheme,
      xlab = "Time from study recruitment (months)",
      palette = palette,
      break.time.by = 365/2,  
      xscale = 730/24,
      xlim = c(0, 750),
      ...
    )
  
  # Customise the plot and table separately
  
  plot_surv$plot <- plot_surv$plot +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_blank()
    )
  
  plot_surv$table <- plot_surv$table + ylab("")
  
  plot_surv
  
}

# Function to perform coxph with mice for missing data
coxph_mice <- function(formula, data, ...){
  
  # Variables
  variables <- all.vars(formula)
  
  # Extract time and status variable names
  timevar <- variables[1]
  statusvar <- variables[2]
  
  # Select variables in the data
  data %<>%
    dplyr::select(tidyselect::all_of(variables)) %>%
    # Calculate the cumulative hazard
    dplyr::mutate(cumhaz = mice::nelsonaalen(
      data = .,
      timevar = !!sym(timevar),
      statusvar = !!sym(statusvar)
    ))
  
  # Predictor matrix - need to exclude time from the model
  pred_matrix <- mice::make.predictorMatrix(data)
  
  pred_matrix[, timevar] <- 0
  
  data_imp <- mice::mice(
    data = data,
    predictorMatrix = pred_matrix, ...)
  
  # Return the imputation
  return(data_imp)
  
}

print_chisq <- function(data) {
  data %>%
    knitr::kable(digits = c(0, 2, 4, 0, NA, NA, NA, 4, NA),
                 col.names = c("n",
                               "Statistic",
                               "p",
                               "df",
                               "Method",
                               "Dependent",
                               "Independent",
                               "Adjusted p-value",
                               "Adjusted significance")
               )
}

print_survival <- function(data) {
  data %>%
    broom::tidy(exponentiate = TRUE, conf.int = TRUE) %>%
    # Relocate columns
    dplyr::select(term, estimate, std.error, statistic, conf.low, conf.high, p.value) %>%
    # 3 significant figures
    dplyr::mutate(dplyr::across(.cols = where(is.numeric), .fns = ~ signif(.x, 3))) %>%
    dplyr::mutate(p.value = as.character(p.value)) %>%
    knitr::kable(col.names = c("Covariate",
                               "Hazard Ratio",
                               "Std. Error",
                               "Statistic",
                               "Lower 95% CI",
                               "Upper 95% CI",
                               "P-value"),
                 format.args = list(drop0trailing = TRUE)
                 )
}

print_survival_mice <- function(data) {
  data %>%
    dplyr::select(term, estimate, std.error, statistic, conf.low, conf.high, p.value) %>%
    # 3 significant figures
    dplyr::mutate(dplyr::across(.cols = where(is.numeric), .fns = ~ signif(.x, 3))) %>%
    dplyr::mutate(p.value = as.character(p.value)) %>%
    knitr::kable(col.names = c("Covariate",
                               "Hazard Ratio",
                               "Std. Error",
                               "Statistic",
                               "Lower 95% CI",
                               "Upper 95% CI",
                               "P-value"),
                 format.args = list(drop0trailing = TRUE)
                 )
}

plot_continuous_hr <- function(data, model, variable, splineterm = NULL){
  
  # Plotting continuous Hazard Ratio curves
  # Data is the same data used to fit the Cox model
  # model is a Cox model
  # variable is the variable we are plotting
  # splineterm is the spline used in the model, if there is one
  
  
  # Range of the variable to plot
  variable_range <- data %>%
    dplyr::pull(variable) %>%
    quantile(., probs = seq(0, 0.9, 0.01), na.rm = TRUE) %>%
    unname() %>%
    unique()
  
  # If there is a spline
  if (!is.null(splineterm)){
    
    # Recreate the spline
    spline <- with(data, eval(parse(text = splineterm)))
    
    # Get the spline terms for the variable values we are plotting
    spline_values <- predict(spline, newx = variable_range)
    
    # Get the reference values of the variables that were used to fit the Cox model
    X_ref <- model$means
    
    # New values to calculate the HR at 
    # Take the ref values and vary our variable of interest
    
    # Number of values
    n_values <- variable_range %>% length()
    
    X_ref <- matrix(rep(X_ref, n_values), nrow = n_values, byrow = TRUE)
    # Fix the column names
    colnames(X_ref) <- names(model$means)
    
    # Now add our new variable values
    X_new <- X_ref
    # Identify the correct columns
    column_pos <- stringr::str_detect(colnames(X_new), variable)
    # Add the values - ordering of columns and model term names should be preserved
    X_new[,column_pos] <- spline_values
    
    # Calculate the linear predictor and se
    # Method directly from predict.coxph from the survival package
    lp <- (X_new - X_ref)%*%coef(model) 
    
    lp_se <- rowSums((X_new - X_ref)%*%vcov(model)*(X_new - X_ref)) %>%
      as.numeric() %>%
      sqrt()
    
  } else {
    # If there is no spline then it is easier
    
    # Get the reference values of the variables that were used to fit the Cox model
    X_ref <- model$means
    
    # New values to calculate the HR at 
    # Take the ref values and vary our variable of interest
    
    # Number of values
    n_values <- variable_range %>% length()
    
    X_ref <- matrix(rep(X_ref, n_values), nrow = n_values, byrow = TRUE)
    # Fix the column names
    colnames(X_ref) <- names(model$means)
    
    # Now add our new variable values
    X_new <- X_ref
    
    # Add the values
    X_new[,variable] <- variable_range
    
    # Calculate the linear predictor and se
    # Method directly from predict.coxph from the survival package
    lp <- (X_new - X_ref)%*%coef(model) %>% as.numeric() 
    
    lp_se <- rowSums((X_new - X_ref)%*%vcov(model)*(X_new - X_ref)) %>% 
      as.numeric() %>%
      sqrt()
    
  }
  
  # Store results in a tibble
  data_pred <- tibble(
    !!sym(variable) := variable_range,
    p = lp,
    se = lp_se
  )
  
  # Plot
  data_pred %>%
    ggplot(aes(
      x = !!rlang::sym(variable),
      y = exp(p),
      ymin = exp(p - 1.96 * se),
      ymax = exp(p + 1.96 * se)
    )) +
    geom_point() +
    geom_line() +
    geom_ribbon(alpha = 0.2) +
    ylab("HR") + 
    theme_minimal()
  
}

# Function to perform an LRT
summon_lrt <- function(model, remove = NULL, add = NULL) {
  # Function that removes a term and performs a
  # Likelihood ratio test to determine its significance
  
  new_formula <- "~ ."
  
  if (!is.null(remove)) {
    new_formula <- paste0(new_formula, " - ", remove)
  } else {
    remove <- NA
  }
  
  if (!is.null(add)) {
    new_formula <- paste0(new_formula, " + ", add)
  } else {
    add <- NA
  }
  
  update(model, new_formula) %>%
    anova(model, ., test = "LRT") %>%
    broom::tidy() %>%
    dplyr::filter(!is.na(p.value)) %>%
    dplyr::select(-term) %>%
    dplyr::mutate(
      removed = remove,
      added = add
    ) %>%
    dplyr::mutate(test = "LRT") %>%
    dplyr::select(test, removed, added, tidyselect::everything())
}

```

## Load data

```{r}
# paths to PREdiCCt data
if (file.exists("/.dockerenv")) {
  # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed"
  flare.dir <- "data/final/20240308/Followup/"
  chiara <- "data/people/chiara/"
} else {
  # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
  flare.dir <- paste0("/Volumes/igmm/cvallejo-predicct/predicct/",
                      "final/20240308/Followup/")
  chiara <- "/Volumes/igmm/cvallejo-predicct/people/chiara/"
}

health <- read.xlsx(paste0(data.path, "Baseline2022/health.xlsx"))
demographics <- read.xlsx(paste0(data.path, "Baseline2022/demographics2022.xlsx"))
IBD <- read.xlsx(paste0(data.path, "Baseline2022/IBD.xlsx"))
psqi <- read.xlsx(paste0(data.path, "Baseline2022/psqi.xlsx"))
demo <- readRDS(paste0(outdir, "demo.RDS"))
flares <- readRDS(paste0(outdir, "flares/cutoff-flares.RDS"))
smoking <- readRDS(paste0(chiara, "smoking.rds"))
IMD <- readRDS(paste0(chiara, "IMD.rds"))
flares_combined <- readRDS(paste0(outdir, "flares/flares-combined-cut.RDS"))
flares_hard <- readRDS(paste0(chiara, "flares_hard.RDS"))
flares_soft <- readRDS(paste0(chiara, "flares_soft.RDS"))
IBD_C <- readRDS(paste0(chiara, "IBD_C.RDS"))
```

## Data Cleaning

Data cleaning involved the following steps:

-   Remove completely empty rows.

-   Combine data from different sources: exercise, demographics, faecal calprotectin (FC) measurements, index of multiple deprivation (IMD), flare history, and IBD control scores.

-   Remove participants under 18 years of age.

-   Remove participants who did not answer all PSQI questions.

-   Rescale the categorical responses, as the raw data responses were recorded as 1-4 instead of 0-3.

-   Correct some responses where possible. E.g., convert to 24h clock.

-   Calculate PSQI score as per scoring guidelines.

-   Categorise participants with scores \>5 as experiencing sleep disturbance.

```{r}
#PSQI data

psqi <- psqi %>% 
  dplyr::filter(!is.na(ParticipantNo))

#add age and sex data from demographics
psqi <- psqi %>% 
  left_join(
    demographics %>% select(ParticipantNo, Sex, age, diagnosis), 
    by  = "ParticipantNo")

# Recode diagnosis
psqi %<>%
  dplyr::mutate(
    diagnosis2 = dplyr::case_when(
      diagnosis == 1 ~ 1,
      diagnosis == 2 ~ 2,
      diagnosis == 3 ~ 2,
      diagnosis == 4 ~ 2
    )
  ) %>%
  dplyr::mutate(diagnosis2 = factor(
    diagnosis2,
    levels = c("1", "2"),
    labels = c("CD", "UC/IBDU")
  ))

#exclude <18 yo = 53 participants (1907 -> 1854)
psqi %<>% dplyr::filter(age >= 18)

#make sex into level
psqi %<>% dplyr::mutate(Sex = factor(
  Sex,
  levels = c(1, 2),
  labels = c("Male", "Female"))
)

#make age brackets
psqi %<>%
  dplyr::mutate(AgeGroup = cut(age, 
                         breaks = c(18, 24, 34, 44, 54, 65, Inf), 
                         labels = c("18-24",
                                    "25-34",
                                    "35-44",
                                    "45-54",
                                    "55-64",
                                    "65+"),
                         include.lowest = TRUE))

# Flares
psqi <- psqi %>% 
  left_join(IBD %>% select(ParticipantNo, FlaresInPastYear),
            by = "ParticipantNo")

#create flare groups
psqi <- psqi %>%
  mutate(flare_group = ifelse(FlaresInPastYear == 0,
                              "No Flares",
                              "1 or More Flares"))

#make flares into levels
psqi %<>% 
  dplyr::mutate(
    flare_group = factor(flare_group,
                         levels = c( "No Flares", "1 or More Flares"))
  )

# FC data
psqi <- psqi %>% 
  dplyr::left_join(
    demo %>% dplyr::select(ParticipantNo, FC, cat), 
    by = "ParticipantNo")

# Add smoking
psqi %<>% 
  dplyr::left_join(
    smoking %>% dplyr::select(ParticipantNo, Smoke), 
    by = "ParticipantNo")

# Smoke as a factor
psqi %<>%
  dplyr::mutate(Smoke = forcats::as_factor(Smoke)) %>%
  dplyr::mutate(Smoke = forcats::fct_relevel(Smoke, 'Never', 'Previous', 'Current'))

# Add IMD
psqi %<>% 
  dplyr::left_join(
    IMD, 
    by = "ParticipantNo") 

# IMD as a factor
psqi %<>%
  dplyr::mutate(
    IMD = as.factor(IMD)
  )

# IBD control scores
psqi %<>%
  dplyr::left_join(
    IBD_C %>% dplyr::select(
      ParticipantNo,
      control_score,
      OverallControl,
      control_8,
      control_grouped,
      vas_control
    ),
    by = "ParticipantNo"
  )

#change control_grouped and vas_control from character into factors
psqi %<>% 
  dplyr::mutate(control_grouped = factor(control_grouped))

psqi %<>% 
  dplyr::mutate(vas_control = factor(vas_control))


# Sleep questionnaire data

psqi %<>%
  dplyr::filter(
    !dplyr::if_any(.cols = c(7, 10, 12, 14:23, 25:28), .fns = is.na)
  )

psqi %<>%
  dplyr::mutate(
    dplyr::across(
      .cols = c("CantGetToSleep",
                   "WakeUpMiddleNight",
                   "UseBathroom",
                   "CannotBreath",
                   "CoughOrSnore",
                   "FeelTooCold",
                   "FeelTooWarm",
                   "BadDreams",
                   "HavePain",
                   "OtherTroubleSleeping",
                   "SleepQuality",
                   "SleepMedicines",
                   "StayingAwake",
                   "EnoughEnthusiasm"),
      .fns = ~. - 1)
  )

#comp1 (mutate SleepQuality to comp1)
psqi <- psqi %>% 
  dplyr::rename(comp1 = SleepQuality)

#comp2
psqi <- psqi %>%
  dplyr::mutate(FallAsleepMns = case_when(
    FallAsleepMns <= 14 ~ 0,
    FallAsleepMns <= 30 ~ 1,
    FallAsleepMns <= 60 ~ 2,
    TRUE ~ 3
  ))

psqi <- psqi %>%
  dplyr::mutate(comp2 = case_when(
    (FallAsleepMns + CantGetToSleep) %in% c(0) ~ 0,
    (FallAsleepMns + CantGetToSleep) %in% c(1, 2) ~ 1,
    (FallAsleepMns + CantGetToSleep) %in% c(3, 4) ~ 2,
    (FallAsleepMns + CantGetToSleep) %in% c(5, 6) ~ 3
  ))

psqi %<>%
  tidyr::replace_na(
    list(SleepEachNightMns = 0)
  )

psqi <- psqi %>%
  dplyr::mutate(TotalSleepMinutes = SleepEachNightHrs * 60 + SleepEachNightMns,
         comp3 = case_when(
           TotalSleepMinutes < 300 ~ 3,
           TotalSleepMinutes >= 300 & TotalSleepMinutes <= 359 ~ 2,
           TotalSleepMinutes >= 360 & TotalSleepMinutes <= 419 ~ 1,
           TotalSleepMinutes >= 420 ~ 0)
         ) 

# Correcting non 24h clock entries.
psqi<- psqi %>%
  dplyr::mutate(
    BedTimeHrs = dplyr::case_when(
      ParticipantNo %in% c(110415, 110463) ~ BedTimeHrs,
      BedTimeHrs == 7 ~ 19,
      BedTimeHrs == 8 ~ 20,
      BedTimeHrs == 9 ~ 21,
      BedTimeHrs == 10 ~ 22,
      BedTimeHrs == 11 ~ 23,
      BedTimeHrs == 12 ~ 00,
      BedTimeHrs == 13 ~ 1,
      BedTimeHrs == 0 ~ 00,
      BedTimeHrs == 1 ~ 01,
      BedTimeHrs == 2 ~ 02,
      BedTimeHrs == 3 ~ 03,
      BedTimeHrs == 4 ~ 04,
      TRUE ~ BedTimeHrs
    )
  )

#if mins bed time/wake up time is na assume 0
psqi %<>%
  tidyr::replace_na(
    list(BedTimeMns = 0, 
         WokenUpMns = 0)
  )

#Three obvious typos found, 2 corrected above + 1 excluded (found when looking at TotalSleepMins - calculated later)
#Participant 170004 Bed time 22.30 wake up 20.00 reported 5 hours total sleep - exclude
psqi <- psqi %>%
  dplyr::filter(ParticipantNo != 170004)

#Participant No 110351 woken up hours 16, should be 6 - corrected above

#Participant 120042 woken up hours 19 but with other data provided would be logical for this to be 9 - correct this
psqi <- psqi %>%
  mutate(WokenUpHrs = dplyr::case_when(
    ParticipantNo == 110351 ~ 6, 
    ParticipantNo == 120042 ~ 9,
    .default = WokenUpHrs))

# Calculate time spent in bed as difference between bed time and wake up time
# Create date times using lubridate and calculate interval
psqi <- psqi %>%
  dplyr::mutate(
    # Bed Time - automatically sets to 1970-01-01
    BedTimeDT = lubridate::make_datetime(hour = BedTimeHrs, min = BedTimeMns),
    # Wake up next morning 1970-01-02
    WokenUpDT = lubridate::make_datetime(day = 2, hour = WokenUpHrs, min = WokenUpMns))

# If asleep after midnight, correct the day
psqi %<>%
  dplyr::mutate(
    BedTimeDT = dplyr::case_when(
      BedTimeHrs >= 0 & BedTimeHrs <= 8 ~ BedTimeDT + lubridate::days(1),
      TRUE ~ BedTimeDT
    )
  )

# Calculate total minutes in bed
psqi %<>%
  dplyr::mutate(
    TotalBedMinutes = lubridate::interval(BedTimeDT, WokenUpDT)/lubridate::minutes()
  )

#calculate comp 4
# Sleep efficiency
psqi <- psqi %>% 
  mutate(SleepEff = TotalSleepMinutes/TotalBedMinutes * 100)

# Convert to a 0-3 scale score.
psqi <- psqi %>%
  mutate(comp4 = case_when(
    SleepEff < 65 ~ 3, 
    SleepEff < 75 ~ 2,
    SleepEff < 85 ~ 1,
    SleepEff >= 85 ~ 0, 
  ))


#comp 5 
psqi <- psqi %>%
  mutate(TotalTrouble = rowSums(
    select(., WakeUpMiddleNight:OtherTroubleSleeping)))

# Categorise
psqi %<>%
  dplyr::mutate(
    comp5 = dplyr::case_when(
      TotalTrouble == 0 ~ 0, 
      TotalTrouble <= 9 ~ 1,
      TotalTrouble <= 18 ~ 2,
      TotalTrouble <= 27 ~ 3
    )
  )

psqi <- psqi %>% 
  dplyr::select(-TotalTrouble)

#comp6
psqi <- psqi %>% 
  dplyr::rename(comp6 = SleepMedicines)

#comp7
psqi <- psqi %>% 
  dplyr::mutate(
    comp7 = dplyr::case_when(
      (StayingAwake + EnoughEnthusiasm) %in% c(0) ~ 0,
      (StayingAwake + EnoughEnthusiasm) %in% c(1, 2) ~ 1,
      (StayingAwake + EnoughEnthusiasm) %in% c(3, 4) ~ 2,
      (StayingAwake + EnoughEnthusiasm) %in% c(5, 6) ~ 3
    )
  )

#TotalComp
psqi <- psqi %>% 
  dplyr::mutate(TotalScore = comp1 + comp2 + comp3 + comp4 + comp5 + comp6 + comp7)

#score > 5 is "poor sleep"
psqi <- psqi %>%
  dplyr::mutate(SleepDisturbance = if_else(TotalScore <= 5, "No", "Yes"))

#tidy psqi}
psqi <- psqi %>% dplyr::select(-(7:35))

# SleepDisturbance as a factor

psqi %<>%
  dplyr::mutate(
    SleepDisturbance = factor(SleepDisturbance, levels = c("No", "Yes"))
  )

# Age in decades
psqi %<>%
  dplyr::mutate(
    age_decade = age/10
  )


# FC maximum detectable value is 1250
psqi %<>%
  dplyr::mutate(
    FC = dplyr::case_when(
      FC > 1250 ~ 1250,
      .default = FC
    )
  )

# Log transform FC due to extreme positive skew
psqi %<>%
  dplyr::mutate(
    FC = log(FC)
  )

```

## Missingness

```{r}
# Visualise missingness

data_vis_missingness <- psqi %>%
  # Select relevant variables
  dplyr::select(
    diagnosis,
    age,
    Sex,
    IMD,
    FC,
    flare_group,
    OverallControl,
    Smoke,
    SiteNo,
    SleepDisturbance
  )

# Number of missing values per variable
data_vis_missingness %>%
  gg_miss_var()

# Pairwise missingness
data_vis_missingness %>%
  ggmice::plot_pattern(rotate = TRUE)

```

## Baseline Analysis

We identify associations between sleep disturbance and patient's baseline characteristics. The statistical significance of the baseline associations was assessed using Chi-squared tests for categorical variables, or Fisher’s exact tests if any expected counts were less than 5. For continuous variables, Wilcoxon tests were used when the psychosocial variable was binary, and Kruskal-Wallis tests when the psychosocial variable had more than 2 categories. P-values were adjusted for multiple testing by controlling the false discovery rate using the Benjamini-Hochberg method. Missingness is addressed using pairwise deletion, whereby observations with missing values in any variable involved in a given test are excluded.

We first conduct the analysis in the full cohort, and then separately within the ulcerative colitis (including IBD unclassified) and Crohn’s disease subgroups.

#### Full Cohort

```{r}

data_baseline <- psqi

# Independent variables
independent = c('diagnosis2',
                'age',
                'Sex',
                'FC',
                'Smoke')

# Dependent variable is SleepDisturbance

# Statistical tests for each independent variable with SleepDisturbance
# With p-values adjusted for multiple testing.
statistical_tests <- summon_statistical_test(
  data = data_baseline, 
  dependent = 'SleepDisturbance', 
  independent = independent)

# Plots
summon_baseline_plot_discrete(
  data = data_baseline,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'diagnosis2'
)

summon_baseline_plot_discrete(
  data = data_baseline,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'Smoke'
)

summon_baseline_plot_continuous(
  data = data_baseline,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'FC'
)

```

#### Ulcerative Colitis/IBD Unclassified

```{r}
# Select anxiety data and UC patients
data_baseline_uc <- psqi %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# Independent variables
independent = c('age',
                'Sex',
                'FC',
                'Smoke')

# Dependent variable is SleepDisturbance

# Statistical tests for each independent variable with SleepDisturbance
# With p-values adjusted for multiple testing

statistical_tests <- summon_statistical_test(
  data = data_baseline_uc, 
  dependent = 'SleepDisturbance', 
  independent = independent)

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_uc,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_uc,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'Smoke'
)

summon_baseline_plot_continuous(
  data = data_baseline_uc,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_uc,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'FC'
)

```

#### Crohn's Disease

```{r}
# Select anxiety data and CD patients
data_baseline_cd <- psqi %>%
  dplyr::filter(diagnosis2 == 'CD')

# Dependent variable is SleepDisturbance

# Statistical tests for each independent variable with SleepDisturbance
# With p-values adjusted for multiple testing using holm correction.
statistical_tests <- summon_statistical_test(
  data = data_baseline_cd, 
  dependent = 'SleepDisturbance', 
  independent = independent)

# Plots
summon_baseline_plot_discrete(
  data = data_baseline_cd,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'Sex'
)

summon_baseline_plot_discrete(
  data = data_baseline_cd,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'Smoke'
)

summon_baseline_plot_continuous(
  data = data_baseline_cd,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'age'
)

summon_baseline_plot_continuous(
  data = data_baseline_cd,
  stat_tests = statistical_tests,
  dependent = 'SleepDisturbance',
  independent = 'FC'
)

```

## Survival Analysis

Associations between sleep disturbance and the rates of patient-reported and objective flares are assessed using multivariable Cox proportional hazard models. Each model adjusted for biological sex, age, smoking status, IMD, and FC (natural log transformed), and included hospital site as a frailty term. Continuous variables (age and FC) were modelled using natural cubic splines, with degrees of freedom determined using likelihood ratio tests at a 95% significance level. Participants with missing flare status or time are excluded.

### Data Cleaning

```{r}
# Survival data
# Join psqi with flare data
# Patient reported
data_survival_soft <- psqi %>% dplyr::inner_join(
  flares_soft %>% dplyr::select(ParticipantNo, softflare, softflare_time),
  by = 'ParticipantNo'
) %>%
  dplyr::mutate(DiseaseFlareYN = softflare, time = softflare_time)

# UC
data_survival_soft_uc <- data_survival_soft %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# CD
data_survival_soft_cd <- data_survival_soft %>%
  dplyr::filter(diagnosis2 == 'CD')


# Hard flares
data_survival_hard <- psqi %>% dplyr::inner_join(
  flares_hard %>% dplyr::select(ParticipantNo, hardflare, hardflare_time),
  by = 'ParticipantNo'
) %>%
  dplyr::mutate(DiseaseFlareYN = hardflare, time = hardflare_time)

# UC
data_survival_hard_uc <- data_survival_hard %>%
  dplyr::filter(diagnosis2 == 'UC/IBDU')

# CD
data_survival_hard_cd <- data_survival_hard %>%
  dplyr::filter(diagnosis2 == 'CD')

```

### Shapes of continuous variables

#### Full Cohort

##### Patient reported flare

```{r}
#| eval: true
#| echo: true
#| results: hide
#| warning: false
#| message: false


# Cox with continuous variables
# Age
cox_age_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_soft
)

# Spline for age
summon_lrt(cox_age_soft, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_soft
)

# Spline for FC
summon_lrt(cox_fc_soft, remove = 'FC', add = 'ns(FC, df = 2)')
# No

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_soft, 
  model = cox_age_soft, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_soft, 
  model = cox_fc_soft, 
  variable = 'FC')

```

##### Objective flare

```{r}
#| eval: true
#| echo: true
#| results: hide
#| warning: false
#| message: false


# Age
cox_age_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_hard
)

# Spline for age
summon_lrt(cox_age_hard, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_hard
)

# Spline for FC
summon_lrt(cox_fc_hard, remove = 'FC', add = 'ns(FC, df = 2)')
# No

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_hard, 
  model = cox_age_hard, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_hard, 
  model = cox_fc_hard, 
  variable = 'FC')

```

#### Ulcerative Colitis

##### Patient reported flare

```{r}
#| eval: true
#| echo: true
#| results: hide
#| warning: false
#| message: false


# Age
cox_age_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_soft_uc
)

# Spline for age
summon_lrt(cox_age_soft_uc, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_soft_uc
)

# Spline for FC
summon_lrt(cox_fc_soft_uc, remove = 'FC', add = 'ns(FC, df = 2)')
# No

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_soft_uc, 
  model = cox_age_soft_uc, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_soft_uc, 
  model = cox_fc_soft_uc, 
  variable = 'FC')

```

##### Objective flare

```{r}
#| eval: true
#| echo: true
#| results: hide
#| warning: false
#| message: false


# Age
cox_age_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_hard_uc
)

# Spline for age
summon_lrt(cox_age_hard_uc, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# Yes

# Refit
cox_age_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    ns(age_decade, df = 2) +
    frailty(SiteNo),
  data = data_survival_hard_uc
)

# Test for df = 3
summon_lrt(cox_age_hard_uc, remove = 'ns(age_decade, df = 2)', add = 'ns(age_decade, df = 3)')
# No - df = 2 is sufficient



# FC
cox_fc_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_hard_uc
)

# Spline for FC
summon_lrt(cox_fc_hard_uc, remove = 'FC', add = 'ns(FC, df = 2)')
# No

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_hard_uc, 
  model = cox_age_hard_uc, 
  variable = 'age_decade',
  splineterm = 'ns(age_decade, df = 2)')

# FC
plot_continuous_hr(
  data = data_survival_hard_uc, 
  model = cox_fc_hard_uc, 
  variable = 'FC')

```

#### Crohn's Disease

##### Patient reported flare

```{r}
#| eval: true
#| echo: true
#| results: hide
#| warning: false
#| message: false


# Age
cox_age_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_soft_cd
)

# Spline for age
summon_lrt(cox_age_soft_cd, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_soft_cd
)

# Spline for FC
summon_lrt(cox_fc_soft_cd, remove = 'FC', add = 'ns(FC, df = 2)')
# No

```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_soft_cd, 
  model = cox_age_soft_cd, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_soft_cd, 
  model = cox_fc_soft_cd, 
  variable = 'FC')

```

##### Objective flare

```{r}
#| eval: true
#| echo: true
#| results: hide
#| warning: false
#| message: false


# Age
cox_age_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    age_decade +
    frailty(SiteNo),
  data = data_survival_hard_cd
)

# Spline for age
summon_lrt(cox_age_hard_cd, remove = 'age_decade', add = 'ns(age_decade, df = 2)')
# No

# FC
cox_fc_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    FC +
    frailty(SiteNo),
  data = data_survival_hard_cd
)

# Spline for FC
summon_lrt(cox_fc_hard_cd, remove = 'FC', add = 'ns(FC, df = 2)')
# No
```

```{r}
# Plot shapes
# Age
plot_continuous_hr(
  data = data_survival_hard_cd, 
  model = cox_age_hard_cd, 
  variable = 'age_decade')

# FC
plot_continuous_hr(
  data = data_survival_hard_cd, 
  model = cox_fc_hard_cd, 
  variable = 'FC')

```

### Results

#### Full Cohort

##### Patient reported flare

###### Kaplan-Meier

```{r}
# Plotting Kaplan-Meier curves
okabe_ito <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

legend.title = 'Sleep Disturbance'
legend.labs = c('No', 'Yes')
palette = okabe_ito
dependent = 'SleepDisturbance'

custom_theme = theme_minimal() + 
  theme(
    title = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 12),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  )

summon_km_curves(
  data = data_survival_soft,
  dependent = dependent,
  title = "Time to patient-reported flare in IBD",
  legend.title = legend.title,
  legend.labs = legend.labs,
  palette = palette,
  ggtheme = custom_theme
)
```

###### Cox proportional hazards model (complete case)

```{r}
# Cox model
cox_soft <- coxph(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_soft
)

cox_soft %>%
  print_survival()

```

###### Cox proportional hazards model (MICE)

```{r}
# Cox model with MICE
# Run the mice
cox_soft_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_soft,
  m = 20,
  printFlag = FALSE
)

# Fit the Cox
cox_soft_pool <- with(
  cox_soft_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      SleepDisturbance +
      IMD +
      Sex +
      age_decade +
      FC +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_soft_pool %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE) %>%
  print_survival_mice()

```

##### Objective flare

###### Kaplan-Meier

```{r}
# Kaplan Meier
summon_km_curves(
  data = data_survival_hard,
  dependent = dependent,
  title = "Time to objective flare in IBD",
  legend.title = legend.title,
  legend.labs = legend.labs,
  palette = palette,
  ggtheme = custom_theme
)
```

###### Cox proportional hazards model (complete case)

```{r}
# Cox model
cox_hard <- coxph(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_hard
)

cox_hard %>%
  print_survival()
```

###### Cox proportional hazards model (MICE)

```{r}
# Cox model with MICE
# Run the mice
cox_hard_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_hard,
  m = 20,
  printFlag = FALSE
)

# Fit the Cox
cox_hard_pool <- with(
  cox_hard_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      SleepDisturbance +
      IMD +
      Sex +
      age_decade +
      FC +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_hard_pool %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE) %>%
  print_survival_mice()
```

#### Ulcerative Colitis

##### Patient reported flare

###### Kaplan-Meier

```{r}
# Kaplan Meier
summon_km_curves(
  data = data_survival_soft_uc,
  dependent = dependent,
  title = "Time to patient-reported flare in ulcerative colitis",
  legend.title = legend.title,
  legend.labs = legend.labs,
  palette = palette,
  ggtheme = custom_theme
)
```

###### Cox proportional hazards model (complete case)

```{r}
# Cox model
cox_soft_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_soft_uc
)

cox_soft_uc %>%
  print_survival()

```

###### Cox proportional hazards model (MICE)

```{r}
# Cox model with MICE
# Run the mice
cox_soft_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_soft_uc,
  m = 20,
  printFlag = FALSE
)

# Fit the Cox
cox_soft_uc_pool <- with(
  cox_soft_uc_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      SleepDisturbance +
      IMD +
      Sex +
      age_decade +
      FC +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_soft_uc_pool %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE) %>%
  print_survival_mice()

```

##### Objective flare

###### Kaplan-Meier

```{r}
# Kaplan Meier
summon_km_curves(
  data = data_survival_hard_uc,
  dependent = dependent,
  title = "Time to objective flare in ulcerative colitis",
  legend.title = legend.title,
  legend.labs = legend.labs,
  palette = palette,
  ggtheme = custom_theme
)
```

###### Cox proportional hazards model (complete case)

```{r}
# Cox model
cox_hard_uc <- coxph(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    ns(age_decade, df = 2) +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_hard_uc
)

cox_hard_uc %>%
  print_survival()
```

###### Cox proportional hazards model (MICE)

```{r}
# Cox model with MICE
# Run the mice
# Note: mice does not support splines so I cannot impute using a spline.
cox_hard_uc_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_hard_uc,
  m = 20,
  printFlag = FALSE
)

# Fit the Cox
cox_hard_uc_pool <- with(
  cox_hard_uc_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      SleepDisturbance +
      IMD +
      Sex +
      ns(age_decade, df = 2) +
      FC +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_hard_uc_pool %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE) %>%
  print_survival_mice()
```

#### Crohn's Disease

##### Patient reported flare

###### Kaplan-Meier

```{r}
# Kaplan Meier
summon_km_curves(
  data = data_survival_soft_cd,
  dependent = dependent,
  title = "Time to patient-reported flare in Crohn's disease",
  legend.title = legend.title,
  legend.labs = legend.labs,
  palette = palette,
  ggtheme = custom_theme
)
```

###### Cox proportional hazards model (complete case)

```{r}
# Cox model
cox_soft_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_soft_cd
)

cox_soft_cd %>%
  print_survival()

```

###### Cox proportional hazards model (MICE)

```{r}
# Cox model with MICE
# Run the mice
cox_soft_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_soft_cd,
  m = 20,
  printFlag = FALSE
)

# Fit the Cox
cox_soft_cd_pool <- with(
  cox_soft_cd_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      SleepDisturbance +
      IMD +
      Sex +
      age_decade +
      FC +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_soft_cd_pool %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE) %>%
  print_survival_mice()

```

##### Objective flare

###### Kaplan-Meier

```{r}
# Kaplan Meier
summon_km_curves(
  data = data_survival_hard_cd,
  dependent = dependent,
  title = "Time to objective flare in Crohn's disease",
  legend.title = legend.title,
  legend.labs = legend.labs,
  palette = palette,
  ggtheme = custom_theme
)
```

###### Cox proportional hazards model (complete case)

```{r}
# Cox model
cox_hard_cd <- coxph(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_hard_cd
)

cox_hard_cd %>%
  print_survival()
```

###### Cox proportional hazards model (MICE)

```{r}
# Cox model with MICE
# Run the mice
cox_hard_cd_mice <- coxph_mice(
  Surv(time, DiseaseFlareYN) ~
    SleepDisturbance +
    IMD +
    Sex +
    age_decade +
    FC +
    Smoke +
    frailty(SiteNo),
  data = data_survival_hard_cd,
  m = 20,
  printFlag = FALSE
)

# Fit the Cox
cox_hard_cd_pool <- with(
  cox_hard_cd_mice,
  coxph(
    Surv(time, DiseaseFlareYN) ~
      SleepDisturbance +
      IMD +
      Sex +
      age_decade +
      FC +
      Smoke +
      frailty(SiteNo)
  )
) %>%
  mice::pool()

cox_hard_cd_pool %>% 
  summary(conf.int = TRUE,
          conf.level = 0.95,
          exponentiate = TRUE) %>%
  print_survival_mice()
```

## Reproduction and reproducibility {.appendix}

<details class="appendix">

<summary>Session info</summary>

```{R Session info}
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by <a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a> unless otherwise stated.

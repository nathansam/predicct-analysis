---
title: "PREdiCCt Paper 2"
author:
  - name: "Chiara Cotronei"
    url: https://www.research.ed.ac.uk/en/persons/chiara-cotronei
    affiliations:
      - ref: Lothian
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, error = FALSE, warning = TRUE)
```

```{r load libraries, warn.conflicts = FALSE}
set.seed(123)
library(plyr) # Used for mapping values
suppressPackageStartupMessages(library(tidyverse)) # ggplot2, dplyr, and magrittr
library(readxl) # Read in Excel files
library(datefixR) # Standardise dates  
library(openxlsx)
library(tidyr)
library(ggdist)
library(rstatix)

suppressPackageStartupMessages(library(table1))
library(knitr)
library(pander)
library(kableExtra)

# Generate flowchart of cohort derivation
library(DiagrammeR)
library(DiagrammeRsvg)

#cox-regression
library(survival)
library(survminer)
library(finalfit)

```

```{r access to data}
# paths to PREdiCCt data
if (file.exists("/.dockerenv")) {
  # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed"
  save_path <- "people/chiara/"
} else {
  # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
  save_path <- "/Volumes/igmm/cvallejo-predicct/people/chiara/"
}
```

```{r load data}
#read-in data
#hads is question 42 of the baseline questionnaire
flarecause <- read.xlsx(paste0(data.path, "Baseline2022/flarecause.xlsx"))
health <- read.xlsx(paste0(data.path, "Baseline2022/health.xlsx"))
demographics <- read.xlsx(paste0(data.path, "Baseline2022/demographics2022.xlsx"))
IBD <- read.xlsx(paste0(data.path, "Baseline2022/IBD.xlsx"))
psqi <- read.xlsx(paste0(data.path, "Baseline2022/psqi.xlsx"))
demo <- readRDS("/Volumes/igmm/cvallejo-predicct/predicct/processed/demo.RDS")
flares <- readRDS("/Volumes/igmm/cvallejo-predicct/predicct/processed/flares/cutoff-flares.RDS")
smoking <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/smoking.rds")
flares_combined <- readRDS("/Volumes/igmm/cvallejo-predicct/predicct/processed/flares/flares-combined-cut.RDS")
flares_hard <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/flares_hard.RDS")
flares_soft <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/flares_soft.RDS")
exercise <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/exercise.RDS")
psqi_IBD <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/psqi_IBD.RDS")
phq_clean <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/phq_clean.RDS")
hads_fc <-  readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/hads_fc.RDS")
ETOH <- readRDS("/Volumes/igmm/cvallejo-predicct/people/chiara/ETOH.RDS")
```



### Introduction 

The links between gut health and central nervous system (CNS) symptoms are of emerging importance for a wide array of diseases. 
There is evidence to suggest that lower perceived stress is linked to a reduced risk of developing IBD as well as influencing the severity of disease (1, 2), and psychological comorbidities have been linked to increase symptom reporting (3).


The PREdiCCt baseline questionnaire asked participants: 
What do you think causes flare in your symptoms? (tick all that apply)[Q35.1]

As seen in the graph below, the two most common patient reported causes of flare are stress and dietary changes. 

The focus of my work will be investigating the relationship between mental health, stress and flares of IBD.
Diet is being investigated in central analyses.


```{r patient reported flare}
# Select the columns of interest
flarecause <- flarecause %>%
  filter(!is.na(ParticipantId))

variables_of_interest <- flarecause[, c(
  "MedsStoppedWorking", "StoppedAttendClinic", "StoppedMeds",
  "DietaryChanges", "Gastroenteritis", "OtherInfection",
  "Travel", "Stress", "Smoking", "Alcohol",
  "Antibiotics", "FCPregnancy", "Breastfeeding",
  "Menstruation", "Exercise", "SleepDisturbance",
  "Pollution", "NSAIDS", "OtherFlareCause"
)]

# Reshape the data into long format
variables_long <- gather(variables_of_interest, key = "Variable", value = "Cause")

# Plot the counts using geom_bar
patient_flare_baseline <- ggplot(variables_long, aes(x = Cause, fill = Variable)) +
  geom_bar(position = "dodge", color = "black") +
  ggtitle("Patient reported flare cause via baseline questionnaire") +
  xlab("Cause") +
  ylab("Count") +
  theme_minimal() +
  theme(axis.ticks.x = element_blank())

print(patient_flare_baseline)

```

```{r, join datasets}

#inclusive full dataset 1639
all_psychosocial <- psqi_IBD %>% 
  full_join(exercise %>% select(ParticipantNo, MinimumExercise, diagnosis2, AgeGroup, cat, IMD, SiteNo, Sex))

all_psychosocial <- all_psychosocial %>% 
  full_join(hads_with_demographics %>% select(ParticipantNo, anxiety_hads, depression_hads, diagnosis2, cat, AgeGroup, IMD, SiteNo, Sex))

all_psychosocial <- all_psychosocial %>% 
  full_join(phq_clean %>% select(ParticipantNo, TotalPHQ, somatisation, diagnosis2, AgeGroup, cat, IMD, SiteNo, Sex))

all_psychosocial <- all_psychosocial %>% 
  full_join(ETOH %>% select(ParticipantNo, Alcoholg, Alcohol_units_wk, weekly_units, diagnosis2, AgeGroup, cat, IMD, SiteNo, Sex))


all_soft <- all_psychosocial %>% 
  inner_join(flares_soft %>% select(ParticipantNo, softflare, softflare_time)) %>% 
  rename(DiseaseFlareYN = softflare, time = softflare_time)

all_hard <- all_psychosocial %>% 
  inner_join(flares_hard %>% select(ParticipantNo, hardflare, hardflare_time)) %>% 
  rename(DiseaseFlareYN = hardflare, time = hardflare_time)


missing_psychosocial <- all_psychosocial %>% 
  filter(is.na(Sex))
#no missingL DiseaseFlareYN, time in hard or soft
#no missing cat, SiteNo (fixed) in psychosocial all/soft/hard
#17 missing IMD (all in exercise)

#calculate total soft flare in whole cohort
cox_model <- coxph(Surv(time, DiseaseFlareYN) ~  diagnosis2, data = all_soft)
summary(cox_model)
fit <- survfit(Surv(time, DiseaseFlareYN) ~ diagnosis2, data = all_soft)
test_result <- survdiff(Surv(time, DiseaseFlareYN) ~ diagnosis2, data = all_soft)
print(test_result)

#caclulate total hard flares in whole cohort
cox_model <- coxph(Surv(time, DiseaseFlareYN) ~  diagnosis2, data = all_hard)
summary(cox_model)
fit <- survfit(Surv(time, DiseaseFlareYN) ~ diagnosis2, data = all_hard)
test_result <- survdiff(Surv(time, DiseaseFlareYN) ~ diagnosis2, data = all_hard)
print(test_result)


#tot 1641 - no duplicates
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}


# this isnt working with the missing values - made everying disappear when I made na = "missing"
table1::table1( ~ Sex | diagnosis2,
  data = all_hard,
  render.continuous = my.render.cont,
  title = "Psychosocial factors in cohort"
)

table1::table1( ~ depression| diagnosis2,
  data = all_psychosocial,
  render.continuous = my.render.cont,
  title = "Psychosocial factors in cohort"
)

table1::table1( ~ SleepDisturbance + somatisation + MinimumExercise + weekly_units| diagnosis2,
  data = all_psychosocial,
  render.continuous = my.render.cont,
  title = "Psychosocial factors in cohort"
)


#this needs recoded to reflect whole cohort
# Create a line chart to show FC at baseline with reporting flares -> maybe do this with the whole cohort (will remain significant but just to be clear)
ggplot(percentages, aes(x = cat, y = percentage, color = flare_group, group = flare_group)) +
  geom_line() +
  labs(title = "Percentage of Respondents with a Certain FC ",
       x = "FC",
       y = "Percentage") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Format y-axis as percentage
  theme_minimal()

```


From hads baseline:

### Baseline data on faecal calprotectin and flare in the previous year

* Do flare in previous year in ALL SETS

Here we present data collected in baseline questionnaires relating to flares in the previous year as reported by patients and faecal calprotectin.

Data relating to flares was found to be missing for 3 participants; these participants were excluded.

[Participants answer the question: "How many flares (an increase in your symptoms necessitating a change in your IBD medicines) have you had in the past year?" (Q14 of the baseline questionnaire)

Participants reported number of flares and these are presented in the graph below. Participants were divided into "flare" or "no flare" groups referring to whether they reported no or any flares in the previous year..

Analysis with t-test showed there was a significant difference in flare rates between sexes (p-value = 0.018), (mean for males 0.66; mean for female 0.85).
Analysis with chi-square showed that females were have reported one or more flares than males (p-value: < 2.2e-16).

This was also true for UC/IBDU patients separately (p-value = 0.00047), but not true for Crohn's Disease (CD) patients (p-value = 0.03767).

```{r, update this merge data for IBD and FC, tidy, new group}

# redo this with ALL SETS - looking at flare rates/flare groups and associations across all patients
t_test_result_flare_sex <- t.test(flares_last_year ~ Sex, data = hads_old_flare)
print(t_test_result_flare_sex)


ggplot(hads_old_flare, aes(x = flares_last_year, fill = Sex)) +
  geom_bar(position = "dodge", color = "black", stat = "count") +
  labs(title = "Distribution of Flares by Sex",
       subtitle = paste("There is no statistically significant difference in flare rates by sex (p =", format(t_test_result_flare_sex$p.value, digits = 2), ")"),
       x = "Flares in last year",
       y = "Frequency") +
  theme_minimal()




#chisq sex and flare
chisq_result <- chisq.test(hads_fc$Sex, hads_fc$flare_group)
chisq_result

filtered_uc <- hads_fc[hads_fc$diagnosis2 == "UC/IBDU",]
chisq_result <- chisq.test(filtered_uc$Sex, filtered_uc$flare_group)
chisq_result

filtered_cd <- hads_fc[hads_fc$diagnosis2 == "CD",]
chisq_result <- chisq.test(filtered_cd$Sex, filtered_cd$flare_group)
chisq_result
```


## Faecal calprotecting and flares in the last year - RECODE with ALL HADS

We investigated the relationship in calprotectin levels between flare groups.
Faecal calprotectin was higher in patients who reported having 1 or more flares in the last year (p-value = 4.105e-08, Fisher's).

This was true for analysis of UC/IBDU and CD separately (respectively p-value = 8.212e-08; p-value = p-value = 0.0131).

```{r, check missing FC and plot FC}

#need to save hads_fc

percentages <- hads_fc %>%
  group_by(cat, flare_group) %>%
  summarise(count = n()) %>%
  group_by(flare_group) %>%
  mutate(percentage = count / sum(count) * 100)

# Create a line chart to show FC at baseline with reporting flares -> maybe do this with the whole cohort (will remain signific)
ggplot(percentages, aes(x = cat, y = percentage, color = flare_group, group = flare_group)) +
  geom_line() +
  labs(title = "Percentage of Respondents with a Certain FC ",
       x = "FC",
       y = "Percentage") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Format y-axis as percentage
  theme_minimal()

contingency_table <- table(hads_fc$cat, hads_fc$flare_group)
contingency_table

options(expressions = 10000)
fisher_result <- fisher.test(contingency_table, workspace = 2e7, hybrid = TRUE, control = list(worksize = 1e7))
fisher_result

# FC and flares in UC/IBDU
filtered_uc <- hads_fc[hads_fc$diagnosis2 == "UC/IBDU",]
contingency_table_uc <- table(filtered_uc$cat, filtered_uc$flare_group)

options(expressions = 10000)
fisher_result_uc <- fisher.test(contingency_table_uc, workspace = 2e7, hybrid = TRUE, control = list(worksize = 1e7))
fisher_result_uc

#FC and flares in CD
filtered_cd <- hads_fc[hads_fc$diagnosis2 == "CD",]
contingency_table_cd <- table(filtered_cd$cat, filtered_cd$flare_group)

options(expressions = 10000)
fisher_result_cd <- fisher.test(contingency_table_cd, workspace = 2e7, hybrid = TRUE, control = list(worksize = 1e7))
fisher_result_cd
```



Cleaning and saving longitudinal flare data
```{r, cleaning flare data }
all_flares <- all_flares %>%
  mutate(ParticipantNo = as.character(ParticipantNo))

flares_hard <- all_flares %>% 
  select(ParticipantNo, ParticipantId, hardflare, hardflare_time)

#2626 patients in all_flares data set
#175 missing hardflare, 75 missing hardflare_time
missing_hard <- flares_hard %>% 
  filter(is.na(hardflare))
missing_hardtime <- flares_hard %>% 
  filter(is.na(hardflare_time))
#exclude all that have missing, this includes all the missing time
flares_hard <- flares_hard %>% 
  filter(!is.na(hardflare))
#tot 2452

#make cut off 2 years, censor at 730 days. 1 row being lost at this step - unclear why.
flares_hard <- flares_hard %>%
  mutate(
    hardflare = ifelse(hardflare_time > 730, 0, hardflare),
    hardflare_time = ifelse(hardflare_time > 730, 730, hardflare_time)
  )


flares_soft <- all_flares %>% 
  select(ParticipantNo, ParticipantId, softflare, softflare_time)
#108 missing both softflare and softflaretime, exclude 
missing_soft <- flares_soft %>% 
  filter(is.na(softflare))
flares_soft <- flares_soft %>% 
  filter(!is.na(softflare))
#tot 2518

#save these
saveRDS(flares_hard, paste0(save_path, "flares_hard.RDS"))
saveRDS(flares_soft, paste0(save_path, "flares_soft.RDS"))

```



Code I removed from exercise to keep more in line with WHO guidelines 
```{r, removed from exercise methods}
12 patients report over 12 in one area
screen_exercise <- exercise %>% 
  filter(
    VigorousWorkHours >= 12 | 
    ModerateWorkHours >= 12 | 
    WalkBicycleHours >= 12 | 
    VigorousSportHours >= 12 | 
    ModerateSportHours >= 12 
  )

#keep those which have been manually checked as true results, exclude those which are misreported/impossible (8). New total is not 1830.
ids_to_keep <- c(117, 4843, 7174, 9404, 13226)
exercise <- exercise %>%
  filter(
    if_else(ParticipantId %in% ids_to_keep, TRUE, 
            (is.na(VigorousWorkHours) | VigorousWorkHours < 12) &
            (is.na(ModerateWorkHours) | ModerateWorkHours < 12) &
            (is.na(WalkBicycleHours) | WalkBicycleHours < 12) &
            (is.na(VigorousSportHours) | VigorousSportHours < 12) &
            (is.na(ModerateSportHours) | ModerateSportHours < 12))
  )


#Find/exclude obvious errors in Vigorous Work - where days are not reported
VW_wrong <- exercise %>%
  filter(VigorousWork == 1 & (VigorousWorkDays == 0 | is.na(VigorousWorkDays)))
#1 ParticipantID 7140 excluded as not including days in response
exercise <- exercise %>% 
  filter(!(ParticipantId %in% c(7140)))
#participantID 1468, 7143, 9587 and 12102 recoded 1 -> 2 as none recording any activity but valid responses in other domains
exercise <- exercise %>%
  mutate(VigorousWork = ifelse(ParticipantId %in% c(1468, 7143, 9587, 12102), 2, VigorousWork))
```
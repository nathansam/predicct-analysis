---
title: "Physical Activity and Alcohol Consumption in IBD Patients: Association with Disease Flares"
author:
  - name: "Chiara Cotronei"
    url: https://www.research.ed.ac.uk/en/persons/chiara-cotronei
    affiliations:
      - ref: Lothian
date: today
execute:
  warning: false
---

## Abstract

This report analyzes the association between physical activity, alcohol consumption, and disease flares in an inflammatory bowel disease (IBD) cohort. We examine baseline characteristics, demographic associations, and survival outcomes for both soft and hard flares stratified by WHO-recommended physical activity levels and alcohol consumption categories. The analysis includes 1,839 IBD patients for physical activity data and 975 patients for alcohol consumption data, with survival analyses examining time to flare events across different exposure groups.

## Introduction

Physical activity and alcohol consumption represent modifiable lifestyle factors that may influence disease outcomes in inflammatory bowel disease (IBD). The World Health Organization (WHO) recommends minimum levels of physical activity for health benefits, while alcohol consumption guidelines provide frameworks for assessing potentially harmful intake levels.

This analysis examines:

1.  **Physical Activity**: Association with disease flares based on WHO minimum exercise requirements (≥150 minutes moderate activity or ≥75 minutes vigorous activity per week)
2.  **Alcohol Consumption**: Association with disease flares stratified by weekly alcohol intake (0-0.1, 0.1-14, and \>14 units per week)
3.  **Survival Outcomes**: Time to soft and hard flares across the whole cohort and by IBD diagnosis subgroups

## Methods Overview

### Data Sources and Population

-   Physical activity data from baseline questionnaires (n=1,839 after exclusions)
-   Alcohol consumption data from food frequency questionnaires (n=975 after exclusions)
-   Demographic and clinical data linked from multiple PREdiCCt study databases
-   Flare outcomes defined as soft (clinical symptoms) and hard (requiring treatment escalation)

### Statistical Approach

-   Baseline associations examined using chi-square tests
-   Survival analysis using Cox proportional hazards models
-   Kaplan-Meier survival curves for visualization
-   Site-specific frailty terms to account for multi-center recruitment

```{r}
#| label: setup
#| echo: false
#| message: false
knitr::opts_chunk$set(echo = TRUE, error = FALSE, warning = TRUE)
```

```{r}
#| label: load-libraries
#| echo: false
#| message: false
#| warning: false
set.seed(123)
library(plyr) # Used for mapping values
suppressPackageStartupMessages(library(tidyverse))
library(readxl) # Read in Excel files
library(datefixR) # Standardise dates
library(openxlsx)
library(tidyr)
library(ggdist)
library(rstatix)

suppressPackageStartupMessages(library(table1))
library(knitr)
library(pander)
library(kableExtra)

# Generate flowchart of cohort derivation
library(DiagrammeR)
library(DiagrammeRsvg)

# cox-regression
library(survival)
library(survminer)
library(finalfit)
```

```{r}
#| label: setup-data-paths
#| echo: false
# paths to PREdiCCt data
if (file.exists("/.dockerenv")) {
  # If running in docker
  data.path <- "data/final/20221004/"
  redcap.path <- "data/final/20231030/"
  prefix <- "data/end-of-follow-up/"
  outdir <- "data/processed"
  flare.dir <- "data/final/20240308/Followup/"
  chiara <- "data/people/chiara/"
} else {
  # Run on OS directly
  data.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20221004/"
  redcap.path <- "/Volumes/igmm/cvallejo-predicct/predicct/final/20231030/"
  prefix <- "/Volumes/igmm/cvallejo-predicct/predicct/end-of-follow-up/"
  outdir <- "/Volumes/igmm/cvallejo-predicct/predicct/processed/"
  flare.dir <- paste0("/Volumes/igmm/cvallejo-predicct/predicct/",
                      "final/20240308/Followup/")
  chiara <- "/Volumes/igmm/cvallejo-predicct/people/chiara/"
}
```

# Physical Activity Analysis

## Data Loading and Processing

```{r}
#| label: load-raw-data
#| echo: false
#| message: false
# read-in data from multiple sources
physicalactivity <- read.xlsx(paste0(
  data.path,
  "Baseline2022/physicalactivity.xlsx"
))
demographics <- read.xlsx(paste0(
  data.path,
  "Baseline2022/demographics2022.xlsx"
))
IBD <- read.xlsx(paste0(data.path, "Baseline2022/IBD.xlsx"))
ffq <- read.xlsx(
  paste0(
    prefix,
    "predicct ffq_nutrientfood groupDQI all foods_data (n1092)Nov2022.",
    "xlsx"
  )
)
all_flares <- read.xlsx(paste0(flare.dir, "all-flares.xlsx"))
demo <- readRDS(paste0(outdir, "demo.RDS"))
flares <- readRDS(paste0(outdir, "flares/cutoff-flares.RDS"))
smoking <- readRDS(paste0(chiara, "smoking.rds"))
demo_uc <- readRDS(paste0(outdir, "demo-uc.RDS"))
demo_cd <- readRDS(paste0(outdir, "demo-cd.RDS"))
flares_soft <- readRDS(paste0(chiara, "flares_soft.RDS"))
flares_hard <- readRDS(paste0(chiara, "flares_hard.RDS"))
```

## Data Cleaning and Quality Control

Physical activity data underwent extensive quality control to ensure reliable measurement of exercise behaviors. Key exclusion criteria included:

-   **WHO compliance**: All patients reporting \>16 hours within any single activity category were excluded per WHO guidelines
-   **Data completeness**: Patients reporting exercise duration without frequency (number of days) were excluded
-   **Extreme values**: Patients reporting \>6720 minutes/week (\>16h/day for 7 days, n=10) were excluded as likely data entry errors
-   **Conservative approach**: Given the potential for misreporting (e.g., entering weekly instead of daily values), we used categorical classifications rather than continuous measures

**WHO Exercise Definition**: Minimum exercise defined as ≥150 minutes moderate activity OR ≥75 minutes vigorous activity per week, OR ≥600 METs per week.

Participants reporting ≥1050 minutes/week (n=452) would meet minimum requirements even if they incorrectly reported weekly instead of daily values, providing additional confidence in the "meeting minimum exercise" classification.

```{r}
#| label: clean-exercise-data
#| echo: false
#| message: false
# 50 missing ParticipantId (blank rows - exclude these, from 1960 to 1910)
# PE.missing <- physicalactivity %>%
#   filter(is.na(ParticipantId)) %>%
#   nrow()

exercise <- physicalactivity %>%
  filter(!is.na(ParticipantId))

# add age and sex data from demographics
exercise <- exercise %>%
  inner_join(
    demographics %>% select(ParticipantNo, Sex, age, diagnosis),
    by = "ParticipantNo"
  )

# Recode diagnosis
exercise %<>%
  dplyr::mutate(
    diagnosis2 = dplyr::case_when(
      diagnosis == 1 ~ 1,
      diagnosis == 2 ~ 2,
      diagnosis == 3 ~ 2,
      diagnosis == 4 ~ 2
    )
  ) %>%
  dplyr::mutate(diagnosis2 = factor(
    diagnosis2,
    levels = c("1", "2"),
    labels = c("CD", "UC/IBDU")
  ))

# exclude <18 yo = 53 participants (1910 -> 1857)
exercise %<>% dplyr::filter(age > 17)

# make sex into factor
exercise %<>% dplyr::mutate(Sex = factor(
  Sex,
  levels = c(1, 2),
  labels = c("Male", "Female"))
)

exercise %<>% dplyr::mutate(AgeGroup = cut(
  age,
  breaks = c(18, 24, 34, 44, 54, 65, Inf),
  labels = c("18-24", "25-34", "35-44", "45-54", "55-64", "65+"),
  include.lowest = TRUE))

exercise <- exercise %>%
  left_join(
    IBD %>% select(ParticipantNo, FlaresInPastYear)
    )

# 7 patients removed with missing data on flares
exercise <- exercise %>%
  filter(!is.na(FlaresInPastYear))

# create flare groups
exercise <- exercise %>%
  mutate(flare_group = ifelse(FlaresInPastYear == 0,
    "No Flares",
    "1 or More Flares"
  ))

# Make flares into levels
exercise %<>% 
  dplyr::mutate(flare_group = factor(
    flare_group,
    levels = c(
      "No Flares",
      "1 or More Flares"
  )
))

# Add FC data 
exercise <- exercise %>%
  left_join(
    demo %>% select(ParticipantNo, FC, cat, Biologic, IMD),
    by = 'ParticipantNo'
    ) 

# Remove subjects with missing FC (cat), 211.
# exercise %>%
#   filter(is.na(cat)) %>% 
#   nrow()

exercise %<>%
  dplyr::filter(
    !is.na(cat)
  )

#missing_ex_IMD <- exercise %>% filter(is.na(IMD))

# Tidy - find and exclude if NA in VigorousWork,ModerateWork,WalkBicycle,VigrorousSport, and ModerateSport - Nobody removed
exercise %<>%
  filter(!dplyr::if_all(
    .cols = c(
      VigorousWork,
      ModerateWork,
      WalkBicycle,
      VigorousSport,
      ModerateSport
    ),
    .fns = is.na
  ))

# look at rows where there are NA values in key questions, exclude those with
# inconsistent answers (no valid response) - manually done, 6 values excluded
# exercise %>%
#   filter(
#     dplyr::if_any(
#       .cols = 
#     c(
#       VigorousWork,
#       ModerateWork,
#       WalkBicycle,
#       VigorousSport,
#       ModerateSport
#     ),
#     .fns = is.na))

exercise <- exercise %>%
  filter(!(ParticipantId %in% c(1395, 4685, 4803, 1452, 4827, 9609)))

# For yes/no questions, remaining NA values can be replaced with 2
exercise %<>%
  tidyr::replace_na(
    list(
      VigorousWork = 2,
      ModerateWork = 2,
      WalkBicycle = 2,
      VigorousSport = 2,
      ModerateSport = 2
    )
  )

# Exclude 10 participants who report 16 or more hours in any one activity, as per WHO guidelines
exercise <- exercise %>%
  filter(
    is.na(VigorousWorkHours) | VigorousWorkHours < 16,
    is.na(ModerateWorkHours) | ModerateWorkHours < 16,
    is.na(WalkBicycleHours) | WalkBicycleHours < 16,
    is.na(VigorousSportHours) | VigorousSportHours < 16,
    is.na(ModerateSportHours) | ModerateSportHours < 16
  )


# check that there are no cases of reporting 'no' to the question whilst
# providing answers in the time boxes
# There isn't any
# exercise %>%
#   filter(VigorousWork == 2 &
#            (VigorousWorkHours > 0 | VigorousWorkMinutes > 0)) %>%
#   nrow()
# 
# exercise %>%
#   filter(ModerateWork == 2 &
#            (ModerateWorkHours > 0 | ModerateWorkMinutes > 0)) %>%
#   nrow()
# 
# exercise %>%
#   filter(WalkBicycle == 2 &
#            (WalkBicycleHours > 0 | WalkBicycleMinutes > 0)) %>%
#   nrow()
# 
# exercise %>%
#   filter(VigorousSport == 2 &
#            (VigorousSportHours > 0 | VigorousSportMinutes > 0)) %>%
#   nrow()
# 
# exercise %>%
#   filter(ModerateSport == 2 &
#            (ModerateSportHours > 0 | ModerateSportMinutes > 0)) %>%
#   nrow()

```

```{r}
#| label: clean-moderate-work-data
#| echo: false
#| message: false
# Find/exclude obvious errors in ModerateWork
MW_wrong <- exercise %>%
  filter(ModerateWork == 1 & (ModerateWorkDays == 0 | is.na(ModerateWorkDays)))
# 2 can be corrected recoding 1->2 ParticipantId 4700, 14446
exercise <- exercise %>%
  mutate(ModerateWork = ifelse(ParticipantId %in% c(4700, 14446),
    2,
    ModerateWork
  ))
# 8 excluded as report 0 days but have answers in other domains
exercise <- exercise %>%
  filter(!(ModerateWork == 1 &
    (ModerateWorkDays == 0 | is.na(ModerateWorkDays))
  ))

# no cases below
MW_wrong <- exercise %>%
  filter(ModerateWork == 2 &
    (!is.na(ModerateWorkHours) | ModerateWorkHours != 0))
MW_wrong <- exercise %>%
  filter(ModerateWork == 2 &
    (!is.na(ModerateWorkMinutes) | ModerateWorkMinutes != 0))

# Find/exclude obvious errors in WalkBicycle
WB_wrong <- exercise %>%
  filter(WalkBicycle == 1 & (WalkBicycleDays == 0 | is.na(WalkBicycleDays)))
# 2 participants excluded as missing n of days and have values in other columns
exercise <- exercise %>%
  filter(!(WalkBicycle == 1 & (WalkBicycleDays == 0 | is.na(WalkBicycleDays))))

# none
WB_wrong <- exercise %>%
  filter(WalkBicycle == 2 &
    (!is.na(WalkBicycleHours) | WalkBicycleHours != 0))
WB_wrong <- exercise %>%
  filter(WalkBicycle == 2 &
    (!is.na(WalkBicycleMinutes) | WalkBicycleMinutes != 0))

# total exercise 1819


# Find/exclude obvious errors in VigorousSport
VS_wrong <- exercise %>%
  filter(VigorousSport == 1 &
    (VigorousSportDays == 0 |
      is.na(VigorousSportDays)))

# Correct 3 participants as all have 0 in all others
exercise <- exercise %>%
  mutate(VigorousSport = ifelse(ParticipantId %in% c(7012, 9555, 9559),
    2,
    VigorousSport
  ))

# exclude 2 participants who did not include number of days
exercise <- exercise %>%
  filter(!(VigorousSport == 1 &
    (VigorousSportDays == 0 |
      is.na(VigorousSportDays))))

# none
VS_wrong <- exercise %>%
  filter(VigorousSport == 2 &
    (!is.na(VigorousSportHours) | VigorousSportHours != 0))
VS_wrong <- exercise %>%
  filter(VigorousSport == 2 &
    (!is.na(VigorousSportMinutes) | VigorousSportMinutes != 0))

# find/exclude obvious errors in ModearateSport
MS_wrong <- exercise %>%
  filter(ModerateSport == 1 & (ModerateSportDays == 0 | is.na(ModerateSportDays)))
exercise <- exercise %>%
  mutate(ModerateSport = ifelse(ParticipantId %in%
    c(
      61,
      186,
      3550,
      7024,
      7048,
      9735,
      12079
    ),
  2,
  ModerateSport
  ))
# exclude 6 participants who did not include number of days
exercise <- exercise %>%
  filter(!(ModerateSport == 1 & (ModerateSportDays == 0 | is.na(ModerateSportDays))))
# none
MS_wrong <- exercise %>%
  filter(ModerateSport == 2 &
    (!is.na(ModerateSportHours) | ModerateSportHours != 0))
MS_wrong <- exercise %>%
  filter(ModerateSport == 2 &
    (!is.na(ModerateSportMinutes) | ModerateSportMinutes != 0))
```

```{R}
# check if anyone recorded days >7 in any days column -> no cases
# check if any minutes >60 and none are
vigorous_work_days_table <- table(exercise$VigorousWorkHours, useNA = "always")
knitr::kable(vigorous_work_hours_table)
```

At this point can confirm that all participants have a valid response to at least one section, have removed invalid answers (e.g respond yes to activity and fill out hours without specifying days) checked if anyone said no but then proceeded to report days/hours or minutes, no one did across any section

```{r}
#| label: calculate-exercise-metrics
#| echo: false
#| message: false
# change NA to 0 to allow for caluculations without total becoming NA
exercise <- exercise %>%
  mutate_at(
    vars(
      VigorousWorkDays,
      VigorousWorkHours,
      VigorousWorkMinutes,
      ModerateWorkDays,
      ModerateWorkHours,
      ModerateWorkMinutes,
      WalkBicycleDays,
      WalkBicycleHours,
      WalkBicycleMinutes,
      VigorousSportDays,
      VigorousSportHours,
      VigorousSportMinutes,
      ModerateSportDays,
      ModerateSportHours,
      ModerateSportMinutes
    ),
    ~ replace_na(., 0)
  )

# create new columns for total mins of vigorous and moderate exercise/week
exercise <- exercise %>%
  mutate(
    VigorousWeek = (VigorousWorkHours * 60 * VigorousWorkDays) +
      (VigorousWorkMinutes * VigorousWorkDays) +
      (VigorousSportDays * VigorousSportHours * 60) +
      (VigorousSportDays * VigorousSportMinutes),
    ModerateWeek = (ModerateWorkHours * 60 * ModerateWorkDays) +
      (ModerateWorkDays * ModerateWorkHours) +
      (ModerateSportDays * ModerateSportHours * 60) +
      (ModerateSportDays * ModerateSportMinutes) +
      (WalkBicycleDays * WalkBicycleHours * 60) +
      (WalkBicycleDays * WalkBicycleMinutes)
  )

# total mins + METs
exercise <- exercise %>%
  mutate(
    ExerciseMins = VigorousWeek + ModerateWeek,
    METs = (VigorousWeek * 8) + (ModerateWeek * 4)
  )

# Targets for exercise (WHO) are 75 minutes vigorous activity or 150 minutes
# moderate activity or 600 METs per week
exercise <- exercise %>%
  mutate(
    MinimumExercise = ifelse(VigorousWeek >= 75 |
      ModerateWeek >= 150 |
      METs >= 600,
    "Yes",
    "No"
    ),
    LackExercise = ifelse(VigorousWeek < 75 &
      ModerateWeek < 150 &
      METs < 600,
    "Yes",
    "No"
    )
  )

# exclude if minute exercise/week >6720
exercise <- exercise[exercise$ExerciseMins < 6720, ]
```

## Exercise Data Summary

After comprehensive data cleaning and quality control procedures, the final physical activity dataset comprises **`r nrow(exercise)` participants**. Key findings from the data processing:

-   **Missing participants**: 50 participants excluded due to missing participant IDs
-   **Age restrictions**: 53 participants \<18 years excluded
-   **Data quality exclusions**: 21 participants removed for inconsistent or invalid exercise reporting
-   **WHO guideline compliance**: 11 participants excluded for reporting \>16 hours in any single activity category
-   **Extreme values**: 10 participants excluded for reporting \>6720 minutes/week

**Exercise Achievement Rates**: - Approximately **`r round(100 * sum(exercise$MinimumExercise == "Yes") / nrow(exercise), 1)`%** of participants meet WHO minimum exercise recommendations - **`r round(100 * sum(exercise$LackExercise == "Yes") / nrow(exercise), 1)`%** do not meet minimum requirements

```{R}
#| label: fig-exercise-dist
#| fig-cap: "Distribution of total weekly exercise minutes in IBD patients. The distribution shows most patients engage in low to moderate levels of physical activity, with a long right tail representing high-activity individuals."
ggplot(exercise, aes(x = ExerciseMins)) +
  geom_density(fill = "skyblue", color = "black", alpha = 0.7) +
  geom_vline(xintercept = median(exercise$ExerciseMins), 
             linetype = "dashed", color = "red", size = 1) +
  labs(
    x = "Total Exercise Minutes per Week",
    y = "Density",
    subtitle = paste("Median:", median(exercise$ExerciseMins), "minutes/week")
  ) +
  theme_minimal()
```

```{r}
#| label: split-exercise-by-diagnosis
#| echo: false
#| message: false
ex_UC <- exercise[exercise$diagnosis2 == "UC/IBDU", ]
ex_CD <- exercise[exercise$diagnosis2 == "CD", ]

saveRDS(exercise, paste0(chiara, "exercise.RDS"))
```

```{r}
#| label: tbl-exercise-whole-cohort
#| tbl-cap: "Baseline characteristics stratified by minimum exercise achievement in the whole cohort"
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}

table1::table1(~ Sex + AgeGroup + diagnosis2 + flare_group + cat | MinimumExercise,
  data = exercise,
  render.continuous = my.render.cont,
  title = "Exercise - whole cohort"
)
```

```{r}
#| label: tbl-lack-exercise-whole-cohort
#| tbl-cap: "Baseline characteristics stratified by lack of exercise in the whole cohort"
table1::table1(~ Sex + AgeGroup + diagnosis2 + flare_group + cat | LackExercise,
  data = exercise,
  render.continuous = my.render.cont,
  title = "Exercise - whole cohort"
)

# approximately 30% do not meet the minimum requirements of exercise advised by the WHO
```

### Baseline Associations - Whole cohort

Is achieving minimum exercise levels in our IBD population significantly related to:

-   There is no significant association between achieving minimum exercise and diagnosis type (p-value = 0.1187)
-   There is a significant association between sex and achieving minimum exercise (p-value = 0.0442)
-   There is no significant association between achieving minimum exercise and reporting flares in the previous year (p-value = 0.179)
-   There is no significant association between age and achieving minimum exercise (p-value = 0.426).
-   There is no significant association between FC category and achieving minimum exercise (p-value = 0.46)

```{r}
#| label: chi-square-sex-exercise
#| echo: false
contingency_table <- table(exercise$Sex, exercise$MinimumExercise)
print(contingency_table)
```

```{r}
#| label: chi-square-sex-exercise-test
#| echo: false
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
# Check if the result is significant at a certain alpha level (e.g., 0.05)
```

```{r}
#| label: chi-square-diagnosis-exercise
#| echo: false
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between sex and achieving",
    " minimum exercise"
  )
} else {
  message(
    "There is no significant association between sex and achieving",
    "minimum exercise"
  )
}

contingency_table <- table(exercise$diagnosis2, exercise$MinimumExercise)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
```

```{r}
#| label: chi-square-flare-age-exercise
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and diagnosis type"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and diagnosis type"
  )
}


contingency_table <- table(exercise$flare_group, exercise$MinimumExercise)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and reporting flares in the previous year"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and reporting flares in the previous year"
  )
}


contingency_table <- table(exercise$AgeGroup, exercise$MinimumExercise)
contingency_table
```

```{r}
#| label: chi-square-age-fc-exercise
#| echo: false
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and age"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and age"
  )
}

contingency_table <- table(exercise$cat, exercise$MinimumExercise)
contingency_table
```

```{r}
#| label: chi-square-fc-exercise-test
#| echo: false
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
```

```{r}
#| label: chi-square-fc-exercise-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and FC"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and FC"
  )
}
```

### Baseline associations - CD

```{r}
#| label: tbl-exercise-cd-only
#| tbl-cap: "Baseline characteristics stratified by minimum exercise achievement in Crohn's disease patients"
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}

table1::table1(~ Sex + AgeGroup + flare_group + cat | MinimumExercise,
  data = ex_CD,
  render.continuous = my.render.cont,
  title = "Exercise - CD only"
)
```

-   There is no significant association between sex and achieving minimum exercise in CD patients (p-value = 0.06)
-   There is no significant association between achieving minimum exercise and reporting flares in the previous year in CD patients (p-value = 0.43)
-   There is no significant association between achieving minimum exercise and age groups in CD (p-value = 0.19)
-   There is no significant association between achieving minimum exercise and FC in CD (p-value = 0.10)

```{r}
#| label: chi-square-cd-sex-exercise
#| echo: false
contingency_table <- table(ex_CD$Sex, ex_CD$MinimumExercise)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between sex and achieving",
    " minimum exercise in CD patients"
  )
} else {
  message(
    "There is no significant association between sex and achieving",
    " minimum exercise in CD patients"
  )
}

contingency_table <- table(ex_CD$flare_group, ex_CD$MinimumExercise)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
```

```{r}
#| label: chi-square-cd-flare-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and reporting flares in the previous year in CD patients"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and reporting flares in the previous year in CD patients"
  )
}
```

```{r}
#| label: tbl-cd-age-exercise
#| tbl-cap: "Contingency table of age groups and minimum exercise achievement in CD patients"
# age
contingency_table <- table(ex_CD$AgeGroup, ex_CD$MinimumExercise)
contingency_table %>%
  knitr::kable()
```

```{r}
#| label: chi-square-cd-age-test
#| echo: false
chi_squared_result <- chisq.test(contingency_table)
pander::pander(chi_squared_result)
```

```{r}
#| label: chi-square-cd-age-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and age in CD patients"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and age in CD patients"
  )
}
```

```{r}
#| label: tbl-cd-fc-exercise
#| tbl-cap: "Contingency table of fecal calprotectin categories and minimum exercise achievement in CD patients"
# fc
contingency_table <- table(ex_CD$cat, ex_CD$MinimumExercise)
contingency_table %>%
  knitr::kable()
```

```{r}
#| label: chi-square-cd-fc-test
#| echo: false
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{r}
#| label: chi-square-cd-fc-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and FC in CD patients"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and FC in CD patients"
  )
}
```

### Baseline associations - UC/IBDU

-   There is no significant association between sex and achieving minimum exercise in UC patients (p-value = 0.45)
-   There is no significant association between achieving minimum exercise and reporting flares in the previous year in UC patients (p-value = 0.18)
-   There is no significant association between achieving minimum exercise and age groups in UC (p-value = 0.90)
-   There is no significant association between achieving minimum exercise and FC (p-value = 0.33)

```{r}
#| label: tbl-exercise-uc-only
#| tbl-cap: "Baseline characteristics stratified by minimum exercise achievement in UC/IBDU patients"
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}

table1::table1(~ Sex + AgeGroup + flare_group + cat | MinimumExercise,
  data = ex_UC,
  render.continuous = my.render.cont,
  title = "Exercise - UC/IBDU only"
)
```

```{r}
#| label: chi-square-uc-sex-exercise
#| echo: false
contingency_table <- table(ex_UC$Sex, ex_UC$MinimumExercise)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{r}
#| label: chi-square-uc-sex-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between sex and achieving",
    " minimum exercise in UC patients"
  )
} else {
  message(
    "There is no significant association between sex and achieving",
    " minimum exercise in UC patients"
  )
}
```

```{r}
#| label: chi-square-uc-flare-test
#| echo: false
contingency_table <- table(ex_UC$flare_group, ex_UC$MinimumExercise)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{r}
#| label: chi-square-uc-flare-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and reporting flares in the previous year in UC patients"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and reporting flares in the previous yearin UC patients"
  )
}
```

```{r}
#| label: tbl-uc-age-exercise
#| tbl-cap: "Contingency table of age groups and minimum exercise achievement in UC/IBDU patients"
# age
contingency_table <- table(ex_UC$AgeGroup, ex_UC$MinimumExercise)
knitr::kable(contingency_table)
```

```{r}
#| label: chi-square-uc-age-test
#| echo: false
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{r}
#| label: chi-square-uc-age-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and age in UC patients"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and age in UC patients"
  )
}
```

```{r}
#| label: tbl-uc-fc-exercise
#| tbl-cap: "Contingency table of fecal calprotectin categories and minimum exercise achievement in UC/IBDU patients"
# fc
contingency_table <- table(ex_UC$cat, ex_UC$MinimumExercise)
knitr::kable(contingency_table)
chi_squared_result <- chisq.test(contingency_table)
print(chi_squared_result)
```

```{r}
#| label: chi-square-uc-fc-result
#| echo: false
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between achieving minimum",
    " exercise and FC in UC patients"
  )
} else {
  message(
    "There is no significant association between achieving minimum",
    " exercise and FC in UC patients"
  )
}
```

### Survival analysis

Is achieving recommended WHO exercise associated with lower risk of flare?

```{r}
#| label: setup-survival-analysis
#| echo: false
#| message: false
cox.summary <- function(fit) {
  cat("Cox model summary:")
  fit %>%
    finalfit::fit2df(condense = FALSE) %>%
    knitr::kable(
      col.names = c(
        "Variable",
        "HR",
        "Lower 95%",
        "Upper 95%",
        "P-value"
      ),
      digits = 4
    ) %>%
    print()
  cat("Proportional hazards assumption test:")
  cox.zph(fit)$table %>%
    knitr::kable(
      col.names = c(
        "",
        "Chi-squared statistic",
        "DF",
        "P-value"
      ),
      digits = 4
    ) %>%
    print()
  return()
}


exercise_soft <- exercise %>%
  inner_join(flares_soft %>% select(
    ParticipantNo,
    softflare,
    softflare_time
  )) %>%
  rename(
    Cens = softflare,
    time = softflare_time
  )

exercise_hard <- exercise %>%
  inner_join(flares_hard %>% select(
    ParticipantNo,
    hardflare,
    hardflare_time
  )) %>%
  rename(
    Cens = hardflare,
    time = hardflare_time
  )

# create data sets
ex_CD_soft <- ex_CD %>%
  inner_join(flares_soft %>% select(
    ParticipantNo,
    softflare,
    softflare_time
  )) %>%
  rename(
    Cens = softflare,
    time = softflare_time
  )
ex_CD_hard <- ex_CD %>%
  inner_join(flares_hard %>% select(
    ParticipantNo,
    hardflare,
    hardflare_time
  )) %>%
  rename(
    Cens = hardflare,
    time = hardflare_time
  )
ex_UC_soft <- ex_UC %>%
  inner_join(flares_soft %>% select(
    ParticipantNo,
    softflare,
    softflare_time
  )) %>%
  rename(Cens = softflare, time = softflare_time)
ex_UC_hard <- ex_UC %>%
  inner_join(flares_hard %>%
    select(
      ParticipantNo,
      hardflare,
      hardflare_time
    )) %>%
  rename(Cens = hardflare, time = hardflare_time)
```

### Whole cohort - survival analysis

Is achieving minimum exercise levels in the whole IBD cohort associated a change to risk of

Patient-reported flares: n= 1571, number of events= 580

-   no association across any analysis

Hard flare: n= 1546, number of events= 216

-   Decreased risk for group meeting minimum exercise requirements controlling for site only (p-value = 0.02, 95% CI 0.42-0.95)
-   Decreased risk for group meeting minimum exercise requirements controlling for site, sex, smoking and IMD (p-value = 0.032, 95% CI 0.53-0.97)
-   Decreased risk for group meeting minimum exercise requirements controlling for FC additionally (p-value = 0.035, 95% CI 0.54-0.97)

```{r}
#| label: survival-exercise-whole-cohort-soft
#| echo: false
# soft flares
fit <- survfit(Surv(time, Cens) ~ MinimumExercise, data = exercise_soft)

test_result <- survdiff(Surv(time, Cens) ~ MinimumExercise,
  data = exercise_soft
)
pander(test_result)
```

```{r}
#| label: fig-exercise-whole-cohort-soft-km
#| fig-cap: "Kaplan-Meier survival curves for time to patient-reported flare by minimum exercise achievement in the whole IBD cohort"
p1 <- ggsurvplot(fit,
  data = ex_CD_soft,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Meeting recommended exercise level",
  palette = c("#42213D", "#F51AA4"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{r}
#| label: cox-exercise-whole-cohort-soft-frailty
#| echo: false
# frailty only
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    frailty(SiteNo),
  data = exercise_soft
)
summary(cox_model) %>%
  pander()
```

```{r}
#| label: cox-exercise-whole-cohort-soft-adjusted
#| echo: false
# site, sex, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    Sex +
    IMD +
    frailty(SiteNo),
  data = exercise_soft
)
summary(cox_model) %>%
  pander()
```

```{r}
#| label: cox-exercise-whole-cohort-soft-fc
#| echo: false
# control for fc in exercise
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    Sex +
    IMD +
    cat +
    frailty(SiteNo),
  data = exercise_soft
)
summary(cox_model) %>%
  pander()
```

```{r}
#| label: survival-exercise-whole-cohort-hard
#| echo: false
# Hard flares
fit <- survfit(Surv(time, Cens) ~ MinimumExercise, data = exercise_hard)

test_result <- survdiff(
  Surv(time, Cens) ~
    MinimumExercise,
  data = exercise_hard
)
test_result %>%
  pander()
```

```{r}
#| label: fig-exercise-whole-cohort-hard-km
#| fig-cap: "Kaplan-Meier survival curves for time to hard flare by minimum exercise achievement in the whole IBD cohort"
p1 <- ggsurvplot(fit,
  data = exercise_hard,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Exercise levels",
  palette = c("#BB0A21", "#F39237"),
  xlab = "Time from study recrutiment (days)",
  title = "All participants - Time to hard flare - GPAQ"
)
p1
```

```{r}
#| label: cox-exercise-whole-cohort-hard-models
#| echo: false
#| results: "asis"
# exercise and frailty
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    frailty(SiteNo),
  data = exercise_hard
)
cox.summary(cox_model)
```

```{R}
# sex and frailty
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    Sex +
    IMD +
    frailty(SiteNo),
  data = exercise_hard
)
summary(cox_model) %>%
  pander()
```

```{r}
#| label: cox-exercise-whole-cohort-hard-fc
#| echo: false
# control for fc additionally
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    Sex +
    IMD +
    cat +
    frailty(SiteNo),
  data = exercise_hard
)
summary(cox_model) %>%
  pander()
```

### Survival analysis - Crohn's Disease

Is time to flare associated with meeting minimum exercise recommendations?

Patient-reported flares: n= 793, number of events= 272

No association when controlling for

-   minimum exercise and site (frailty) (p-value = 0.56)
-   minimum exercise sex, smoking, site (frailty) and IMD (p-value = 0.33)
-   as above plus FC (p value = 0.43)

Hard flares:\
n= 778, number of events= 97

No association when controlling for

-   minimum exercise and site (frailty) (p-value = 0.46)
-   minimum exercise sex, smoking, site (frailty) and IMD (p=value = 0.71)
-   as above plus FC (p-value = 0.61)

```{r}
#| label: survival-exercise-cd-soft
#| echo: false

# soft flares
fit <- survfit(Surv(time, Cens) ~ MinimumExercise, data = ex_CD_soft)

test_result <- survdiff(Surv(time, Cens) ~ MinimumExercise, data = ex_CD_soft)
test_result %>%
  pander()
```

```{R}
#| label: fig-exercise-cd-soft-km
#| fig-cap: "Crohn's - Time to patient-reported flare - GPAQ"
p1 <- ggsurvplot(fit,
  data = ex_CD_soft,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Metting recommended exercise level",
  palette = c("#42213D", "#F51AA4"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{r}
#| label: cox-exercise-cd-soft-models
#| echo: false
# frailty only
cox_model <- coxph(
  Surv(time, Cens) ~
    MinimumExercise +
    frailty(SiteNo),
  data = ex_CD_soft
)
summary(cox_model) %>%
  pander()
```

```{R}
#| results: "asis"
# lack exercise - site only
cox_model <- coxph(
  Surv(time, Cens) ~
    LackExercise +
    frailty(SiteNo),
  data = ex_CD_soft
)
cox.summary(cox_model)
```

```{R}
# 2
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     frailty(SiteNo),
                   data = ex_CD_soft)
summary(cox_model) %>%
  pander()
```

```{R}
#| results: "asis"
# control for fc
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_CD_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# lack exercise - controlling for fc
cox_model <- coxph(Surv(time, Cens) ~
                     LackExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_CD_soft)
cox.summary(cox_model)
```

```{r}
#| label: survival-exercise-cd-hard
#| echo: false
# Hard flares
fit <- survfit(Surv(time, Cens) ~ MinimumExercise, data = ex_CD_hard)

test_result <- survdiff(Surv(time, Cens) ~ MinimumExercise, data = ex_CD_hard)
pander(test_result)
```

```{R}
#| fig-cap: "CD - Time to hard flare - GPAQ"
p1 <- ggsurvplot(fit,
  data = ex_CD_hard,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Meeting recommended exercise levels",
  palette = c("#BB0A21", "#F39237"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
#| results: "asis"
# exercise and frailty
cox_model <- coxph(Surv(time, Cens) ~ MinimumExercise + frailty(SiteNo),
                   data = ex_CD_hard)
cox.summary(cox_model)
```

```{R}
# lack exercise - site only
cox_model <- coxph(Surv(time, Cens) ~ LackExercise + frailty(SiteNo),
                   data = ex_CD_hard)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# 2
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     frailty(SiteNo),
                   data = ex_CD_hard)
summary(cox_model)
```

```{R}
# control for fc additionally
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_CD_hard)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# lack exercise - control for fc additionally
cox_model <- coxph(Surv(time, Cens) ~
                     LackExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_CD_hard)
cox.summary(cox_model)
```

### Survival Analysis - UC/IBDU

Patient-reported flares: n= 787, number of events= 311

No association when controlling for

-   site (frailty) (p-value = 0.9)
-   sex, smoking, site (frailty) and IMD (p-value = 0.78)
-   as above plus FC (p value = 0.68)

Hard flares: n= 759, number of events= 119

There is a significant association between achieving minimum exercise and risk of flare when controlling for \* site (frailty) (p-value = 0.014, 95% CI 0.40-0.90) \* sex, smoking, site (frailty) and IMD (p=value = 0.02, 95% CI 0.41-0.92) \* as above plus FC (p-value = 0.032, 95% CI 0.42-0.96)

```{r}
#| label: survival-exercise-uc-soft
#| echo: false

# soft flares
fit <- survfit(Surv(time, Cens) ~ MinimumExercise, data = ex_UC_soft)

test_result <- survdiff(Surv(time, Cens) ~ MinimumExercise, data = ex_UC_soft)
pander(test_result)
```

```{R}
#| fig-cap: "UC/IBDU - Time to patient-reported flare - GPAQ"
p1 <- ggsurvplot(fit,
           data = ex_UC_soft,
           conf.int = TRUE,
           ggtheme = theme_minimal(),
           legend.title = "Meeting recommended exercise levels",
           palette = c("#42213D", "#F51AA4"),
           xlab = "Time from study recrutiment (days)",
           title = "UC/IBDU - Time to soft flare - GPAQ"
           )
p1
```

```{R}
#| results: "asis"
#controlling for frailty only 
cox_model <- coxph(Surv(time, Cens) ~ MinimumExercise + frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
#lack exercise - frailty only 
cox_model <- coxph(Surv(time, Cens) ~ LackExercise + frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
#controlling for Sex, frailty
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     frailty(SiteNo),
                   data = ex_UC_soft)
summary(cox_model) %>% pander()
```

```{R}
#| results: "asis"
#control for FC additioally
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# lack exercise - control for FC additioally
cox_model <- coxph(Surv(time, Cens) ~
                     LackExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}
#| fig-cap: "UC/IBDU - Time to soft flare - GPAQ"
p1 <- ggsurvplot(fit,
  data = ex_UC_soft,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Meeting recommended exercise levels",
  palette = c("#42213D", "#F51AA4"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
#| results: "asis"
# controlling for frailty only
cox_model <- coxph(Surv(time, Cens) ~ MinimumExercise + frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# lack exercise - frailty only
cox_model <- coxph(Surv(time, Cens) ~ LackExercise + frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# controlling for Sex, frailty
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     frailty(SiteNo),
                   data = ex_UC_soft)
summary(cox_model) %>% pander()
```

```{R}
#| results: "asis"
# control for FC additioally
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{R}

# lack exercise - control for FC additioally
cox_model <- coxph(Surv(time, Cens) ~
                     LackExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_UC_soft)
cox.summary(cox_model)
```

```{r}
#| label: survival-exercise-uc-hard
#| echo: false
# Hard flares
fit <- survfit(Surv(time, Cens) ~ MinimumExercise, data = ex_UC_hard)

test_result <- survdiff(Surv(time, Cens) ~ MinimumExercise, data = ex_UC_hard)
pander(test_result)
```

```{R}
p.uc.ex.hard <- ggsurvplot(fit,
  data = ex_UC_hard,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Met WHO recommended exercise levels",
  legend.labs = c("No", "Yes"),
  palette = c("#BB0A21", "#F39237"),
  xlab = "Time from study recrutiment (days)",
  title = "UC/IBDU - Time to hard flare - GPAQ"
)
p.uc.ex.hard
```

```{R}
#| results: "asis"
# exercise
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     frailty(SiteNo),
                   data = ex_UC_hard)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# lack exercise - hard flare
cox_model <- coxph(Surv(time, Cens) ~
                     LackExercise +
                     frailty(SiteNo),
                   data = ex_UC_hard)
cox.summary(cox_model)
```

```{R}
# sex frailty IMD
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     frailty(SiteNo),
                   data = ex_UC_hard)
summary(cox_model)
```

```{R}
#| results: "asis"
# control for FC
cox_model <- coxph(Surv(time, Cens) ~
                     MinimumExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_UC_hard)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# lack exercise - controlling fc
cox_model <- coxph(Surv(time, Cens) ~
                     LackExercise +
                     Sex +
                     IMD +
                     cat +
                     frailty(SiteNo),
                   data = ex_UC_hard)
cox.summary(cox_model)
```

# Alcohol Consumption Analysis

## Data Source and Processing

Alcohol consumption data was obtained from food frequency questionnaires (FFQ) completed at baseline. Participants were categorized into three groups based on weekly alcohol consumption:

-   **0-0.1 units/week**: Minimal or no alcohol consumption
-   **0.1-14 units/week**: Within recommended limits
-   **\>14 units/week**: Above recommended guidelines (potentially harmful levels)

These categories align with established public health guidelines for alcohol consumption and enable assessment of both beneficial and potentially harmful drinking patterns.

```{r}
#| label: process-alcohol-data
#| echo: false
#| message: false
# 1091 in ETOH from ffq
ETOH <- ffq %>%
  select(participantno,
         Alcoholg,
         Alcohol_percEng,
         Alcohol_units,
         Alcohol_units_wk,
         alcohol_units_cat)
ETOH <- ETOH %>%
  rename(ParticipantNo = participantno)
ETOH$ParticipantNo <- as.character(ETOH$ParticipantNo)
ETOH <- ETOH %>%
  left_join(demographics %>% select(ParticipantNo, Sex, age, SiteNo, diagnosis),
            by = "ParticipantNo")

# code diagnosis
ETOH$diagnosis2 <- plyr::mapvalues(ETOH$diagnosis,
  from = seq(1, 4),
  to = c(1, 2, 2, 2)
) %>%
  factor(levels = c("1", "2"), labels = c("CD", "UC/IBDU"))

# exclude <18 yo = 6 participants excluded
ETOH <- ETOH[ETOH$age > 17, ]

# make sex into level
ETOH$Sex <- factor(ETOH$Sex, levels = c(1, 2), labels = c("Male", "Female"))

ETOH$AgeGroup <- cut(ETOH$age,
  breaks = c(18, 24, 34, 44, 54, 65, Inf),
  labels = c("18-24", "25-34", "35-44", "45-54", "55-64", "65+"),
  include.lowest = TRUE
)


ETOH <- ETOH %>%
  left_join(IBD %>% select(ParticipantNo, FlaresInPastYear))

# 31 have missing flare from last year data
missing_flare <- ETOH %>%
  filter(is.na(FlaresInPastYear))
ETOH <- ETOH %>%
  filter(!is.na(FlaresInPastYear))

# create flare groups
ETOH <- ETOH %>%
  mutate(flare_group = ifelse(FlaresInPastYear == 0,
                              "No Flares",
                              "1 or More Flares")
         )
# make flares into levels
ETOH$flare_group <- factor(ETOH$flare_group,
                           levels = c("No Flares", "1 or More Flares"))

# add FC
ETOH <- ETOH %>%
  left_join(demo %>% select(ParticipantNo, FC, cat, Biologic, IMD))

# n.b.78 fc cat missing
missing_cat <- ETOH %>%
  filter(is.na(cat))
ETOH <- ETOH %>%
  filter(!is.na(cat))


# create new ETOH groups
ETOH <- ETOH %>%
  mutate(
    weekly_units = case_when(
      Alcohol_units_wk <= 0.1 ~ "0-0.1",
      Alcohol_units_wk > 0.1 & Alcohol_units_wk <= 14 ~ "0.1-14",
      Alcohol_units_wk > 14 ~ " 14+"
    )
  )

ETOH$weekly_units <- factor(ETOH$weekly_units,
  levels = c("0-0.1", "0.1-14", " 14+")
)

# create alcohol intake level where:
# 1 = none/very rarely;
# 2 = within recommended limits;
# 3 = above recommended limits

ETOH <- ETOH %>%
  mutate(
    AlcoholIntake = case_when(
      Alcohol_units_wk <= 0.1 ~ "1",
      Alcohol_units_wk > 0.1 & Alcohol_units_wk <= 14 ~ "2",
      Alcohol_units_wk > 14 ~ "3"
    )
  )

# 1 patient missign ETOH data, excluded
missing_etoh <- ETOH %>%
  filter(is.na(weekly_units))
ETOH <- ETOH %>%
  filter(!is.na(weekly_units))

save_path <- "/Volumes/igmm/cvallejo-predicct/people/chiara/"
saveRDS(ETOH, paste0(save_path, "ETOH.RDS"))

ETOH_CD <- ETOH[ETOH$diagnosis2 == "CD", ]
ETOH_UC <- ETOH[ETOH$diagnosis2 == "UC/IBDU", ]
```

### Baseline associations - whole cohort

Looking at the whole cohort - are there significant associations at baseline between

-   Alcohol consumption and diagnosis type? Yes, p-value = 0.017
-   Alcohol consumption and sex? - Yes, p-value = 0.00008 (Females more likely to drink within recommended units, men more likely to drink above recommended limits)
-   Alcohol consumption and flares in last year? Yes, p-value = 0.029
-   Alcohol consumption and age? Yes, p-value = 0.00003. Younger people are more likely to recommended unit of alcohol, older people are more likely not drink at all. Need to do further analysis on this to comment accurately/significantly.
-   Alcohol consumption and FC? No, p-value = 0.17

```{r}
#| label: tbl-alcohol-whole-cohort
#| tbl-cap: "Baseline characteristics stratified by weekly alcohol consumption in the whole cohort"
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}

table1::table1(~ diagnosis2 + Sex + AgeGroup + flare_group + cat | weekly_units,
  data = ETOH,
  render.continuous = my.render.cont,
  title = "Alcohol consumption- whole cohort"
)
```

```{r}
#| label: chi-square-alcohol-sex
#| echo: false
contingency_table <- table(ETOH$Sex, ETOH$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
chi_squared_result %>%
  pander()
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between sex and weekly alcohol",
    " consumption (units)"
  )
} else {
  message(
    "There is no significant association between sex and weekly alcohol",
    " consumption (units)"
  )
}
```

```{R}
contingency_table <- table(ETOH$diagnosis2, ETOH$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and diagnosis type"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and diagnosis type"
  )
}
```

```{R}
contingency_table <- table(ETOH$flare_group, ETOH$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and reporting flares in the previous year"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and reporting flares in the previous year"
  )
}
```

```{R}
contingency_table <- table(ETOH$AgeGroup, ETOH$weekly_units)
knitr::kable(contingency_table)
```

```{R}
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and age."
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and age."
  )
}
```

```{R}
contingency_table <- table(ETOH$cat, ETOH$weekly_units)
knitr::kable(contingency_table)
```

```{R}
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and FC"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and FC"
  )
}
```

```{r}
#| label: fig-alcohol-sex-distribution
#| fig-cap: "Weekly alcohol intake (units) across sex. There are significant differences in alcohol intake between sexes."
# sex
percentages <- ETOH %>%
  group_by(Sex, weekly_units) %>%
  summarise(count = n()) %>%
  group_by(Sex) %>%
  mutate(percentage = count / sum(count) * 100)

# Create a line chart to show the percentage of respondents with a certain
# PSQI score
ggplot(
  percentages,
  aes(x = weekly_units, y = percentage, color = Sex, group = Sex)
) +
  geom_line() +
  labs(
    x = "Weekly units",
    y = "Percentage of participants"
  ) +
  # Format y-axis as percentage
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme_minimal()
```

```{r}
#| label: fig-alcohol-age-distribution
#| fig-cap: "Weekly alcohol intake (units) by age group"
percentages <- ETOH %>%
  group_by(AgeGroup, weekly_units) %>%
  summarise(count = n()) %>%
  group_by(AgeGroup) %>%
  mutate(percentage = count / sum(count) * 100)

# Create a line chart to show the percentage of respondents with a certain PSQI score
ggplot(percentages, aes(x = weekly_units, y = percentage, color = AgeGroup, group = AgeGroup)) +
  geom_line() +
  labs(
    group = "Age (years)",
    color = "Age (years)",
    x = "Weekly units",
    y = "Percentage of Participants"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) + # Format y-axis as percentage
  theme_minimal()
```

### CD - baseline associations

-   No association between Sex and ETOH in CD subset, p-value = 0.79
-   No association between flares in previous year and ETOH, p-value = 0.12
-   Significant association between age group and ETOH intake, p-value = 0.002
-   No association between smoking and ETOH intake, p-value = 0.549
-   No association between FC and ETOH intake, p-value = 0.56

```{r}
#| label: tbl-alcohol-cd-only
#| tbl-cap: "Baseline characteristics stratified by weekly alcohol consumption in CD patients"
my.render.cont <- function(x) {
  with(
    stats.apply.rounding(stats.default(x),
      digits = 3,
      round.integers = FALSE
    ),
    c("", "Median (IQR)" = sprintf("%s (%s - %s)", MEDIAN, Q1, Q3))
  )
}

table1::table1(~ Sex + AgeGroup + flare_group + cat | weekly_units,
  data = ETOH_CD,
  render.continuous = my.render.cont,
  title = "Alcohol consumption - CD cohort"
)
```

```{r}
#| label: chi-square-cd-alcohol-associations
#| echo: false
contingency_table <- table(ETOH_CD$Sex, ETOH_CD$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between sex and weekly alcohol",
    " consumption (units) in CD patients"
  )
} else {
  message(
    "There is no significant association between sex and weekly alcohol",
    " consumption (units) in CD patients"
  )
}
```

```{R}
contingency_table <- table(ETOH_CD$flare_group, ETOH_CD$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message("There is a significant association between weekly alcohol consumption (units) and reporting flares in the previous year in CD")
} else {
  message("There is no significant association between weekly alcohol consumption (units) and reporting flares in the previous year in CD")
}
```

```{R}
contingency_table <- table(ETOH_CD$AgeGroup, ETOH_CD$weekly_units)
knitr::kable(contingency_table)
```

```{R}
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and reporting age in CD"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and reporting age in CD"
  )
}
```

```{R}
contingency_table <- table(ETOH_CD$cat, ETOH_CD$weekly_units)
knitr::kable(contingency_table)
```

```{R}
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and reporting FC in CD"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and reporting FC in CD"
  )
}
```

## UC analysis only - baseline

-   There is a significant association between sex and ETOH consumption in UC patients, p-value \>0.00001
-   There is a significant association between weekly alcohol consumption (units) and reporting flares in the previous year in UC, p-value 0.007
-   No significant association between alcohol consumption and age groups in UC patients, p-value = 0.153
-   There is no significant association between weekly alcohol consumption (units) and FC in UC, p-value = 0.185

```{R}
#| label: tbl-UC-ETOH
#| tbl-cap: "Table showing the relationship between alcohol consumption and demographics in ulcerative patients"


table1::table1(~ Sex + AgeGroup + flare_group + cat | weekly_units,
  data = ETOH_UC,
  render.continuous = my.render.cont
)
```

```{r}
#| label: chi-square-uc-alcohol-associations
#| echo: false
contingency_table <- table(ETOH_UC$Sex, ETOH_UC$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between sex and weekly alcohol",
    " consumption (units) in UC patients"
  )
} else {
  message(
    "There is no significant association between sex and weekly alcohol",
    " consumption (units) in UC patients"
  )
}
```

```{R}
contingency_table <- table(ETOH_UC$flare_group, ETOH_UC$weekly_units)
# chi.sq
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and reporting flares in the previous year",
    " in UC"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and reporting flares in the previous year",
    " in UC"
  )
}
```

```{R}
contingency_table <- table(ETOH_UC$AgeGroup, ETOH_UC$weekly_units)
knitr::kable(contingency_table)
```

```{R}
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and age in UC"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and age in UC"
  )
}
```

```{R}
contingency_table <- table(ETOH_UC$cat, ETOH_UC$weekly_units)
knitr::kable(contingency_table)
```

```{R}
chi_squared_result <- chisq.test(contingency_table)
pander(chi_squared_result)
```

```{R}
# Check if the result is significant at a certain alpha level (e.g., 0.05)
alpha <- 0.05
if (chi_squared_result$p.value < alpha) {
  message(
    "There is a significant association between weekly alcohol",
    " consumption (units) and FC in UC"
  )
} else {
  message(
    "There is no significant association between weekly alcohol",
    " consumption (units) and FC in UC"
  )
}
```

# Survival analysis, stratifying by alcohol consumption

```{r}
#| label: setup-alcohol-survival-data
#| echo: false
#| message: false

ETOH_soft <- ETOH %>%
  inner_join(flares_soft %>% select(
    ParticipantNo,
    softflare, softflare_time
  )) %>%
  rename(Cens = softflare, time = softflare_time)
ETOH_hard <- ETOH %>%
  inner_join(flares_hard %>% select(
    ParticipantNo,
    hardflare,
    hardflare_time
  )) %>%
  rename(Cens = hardflare, time = hardflare_time)

# create data sets
ETOH_CD_soft <- ETOH_CD %>%
  inner_join(flares_soft %>% select(
    ParticipantNo,
    softflare,
    softflare_time
  )) %>%
  rename(Cens = softflare, time = softflare_time)
ETOH_CD_hard <- ETOH_CD %>%
  inner_join(flares_hard %>% select(
    ParticipantNo,
    hardflare,
    hardflare_time
  )) %>%
  rename(Cens = hardflare, time = hardflare_time)
ETOH_UC_soft <- ETOH_UC %>%
  inner_join(flares_soft %>% select(
    ParticipantNo,
    softflare,
    softflare_time
  )) %>%
  rename(Cens = softflare, time = softflare_time)
ETOH_UC_hard <- ETOH_UC %>%
  inner_join(flares_hard %>% select(
    ParticipantNo,
    hardflare,
    hardflare_time
  )) %>%
  rename(Cens = hardflare, time = hardflare_time)
```

## Survival analysis all patients

Patient-reported flare - no significant associations Hard flare - no significant associations

```{r}
#| label: survival-alcohol-whole-cohort-soft
#| fig-cap: "All participants - Time to patient-reported flare - Alcohol"
# soft flares
fit <- survfit(Surv(time, Cens) ~ weekly_units, data = ETOH_soft)

test_result <- survdiff(Surv(time, Cens) ~ weekly_units, data = ETOH_soft)
print(test_result)

p1 <- ggsurvplot(fit,
  data = ETOH_soft,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Alcohol units/week",
  palette = c("#6B9AC4", "#FF86C8", "#FFDC5E"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
#| results: "asis"
# univariate
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
  data = ETOH_soft
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# controlling for Sex, frailty, age, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_soft
)
summary(cox_model)
```

```{R}
#| results: "asis"
# control for FC additioally
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    IMD +
    cat +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_soft
)
summary(cox_model)
```

```{R}
# Hard flares
fit <- survfit(Surv(time, Cens) ~ weekly_units, data = ETOH_hard)

test_result <- survdiff(Surv(time, Cens) ~ weekly_units, data = ETOH_hard)
pander(test_result)
```

```{R}
#| fig-cap: "All patient - Time to hard flare - Alcohol"
p1 <- ggsurvplot(fit,
  data = ETOH_hard,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Alcohol units/week",
  palette = c("#6B9AC4", "#FF86C8", "#FFDC5E"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
# univariate
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
  data = ETOH_CD_hard
)
summary(cox_model) %>%
  pander()
```

```{R}
# controlling for Sex, frailty, age, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    AgeGroup +
    IMD +
    frailty(SiteNo),
  data = ETOH_CD_hard
)
summary(cox_model) %>%
  pander()
```

```{R}
# control for FC additionally
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_CD_hard
)
summary(cox_model) %>%
  pander()
```

## Survival analysis CD patients

Patient-reported flares (n= 482, number of events= 173):

-   No significant association when controlling for frailty(site) only for 14+ units/week (0.1-14.5 p-value = 0.200; 14.5+ p-value = 0.088)
-   Not significant when controlling for frailty(site), sex, smoking, IMD and age
-   Not significant when controlling for FC additionally

Hard flares (n= 472, number of events= 55):

-   No significant association when controlling for frailty(site) only
-   Not significant when controlling for frailty(site), sex, smoking, IMD and age
-   Not significant when controlling for FC additionally

```{r}
#| label: survival-alcohol-cd-soft
#| echo: false

# soft flares
fit <- survfit(Surv(time, Cens) ~ weekly_units, data = ETOH_CD_soft)

test_result <- survdiff(Surv(time, Cens) ~ weekly_units, data = ETOH_CD_soft)
test_result %>% pander()
```

```{R}
#| fig-cap: "Crohn's - Time to patient-reported flare - Alcohol"
p1 <- ggsurvplot(fit,
           data = ETOH_CD_soft,
           conf.int = TRUE,
           ggtheme = theme_minimal(),
           legend.title = "Alcohol units/week",
           palette = c("#6B9AC4", "#FF86C8","#FFDC5E" ),
           xlab = "Time from study recrutiment (days)",
           title = "Crohn's - Time to soft flare - Alcohol"
           )
p1
```

```{R}
#| results: "asis"
#site only 
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
                   data = ETOH_CD_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
#new levels - site only
cox_model <- coxph(Surv(time, Cens) ~ AlcoholIntake + frailty(SiteNo),
                   data = ETOH_CD_soft)
cox.summary(cox_model)
```

```{R}
#controlling for Sex, frailty, age, IMD
cox_model <- coxph(Surv(time, Cens) ~
                     weekly_units +
                     Sex +
                     IMD +
                     AgeGroup +
                     frailty(SiteNo),
                   data = ETOH_CD_soft)
summary(cox_model) %>% pander()
```

```{R}
#| results: "asis"
#control for FC additioally
cox_model <- coxph(Surv(time, Cens) ~
                     weekly_units +
                     Sex +
                     IMD +
                     cat +
                     AgeGroup +
                     frailty(SiteNo),
                   data = ETOH_CD_soft)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
#new levels - controlling for FC
cox_model <- coxph(Surv(time, Cens) ~
                     AlcoholIntake +
                     Sex +
                     IMD +
                     cat +
                     AgeGroup +
                     frailty(SiteNo),
                   data = ETOH_CD_soft)
cox.summary(cox_model)
```

```{R}
#| fig-cap: "Crohn's - Time to soft flare - Alcohol"
p1 <- ggsurvplot(fit,
  data = ETOH_CD_soft,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Alcohol units/week",
  palette = c("#6B9AC4", "#FF86C8", "#FFDC5E"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
# site only
# #| results: "asis"
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
  data = ETOH_CD_soft
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# new levels - site only
cox_model <- coxph(Surv(time, Cens) ~ AlcoholIntake + frailty(SiteNo),
  data = ETOH_CD_soft
)
cox.summary(cox_model)
```

```{R}
# controlling for Sex, frailty, age, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_CD_soft
)
summary(cox_model) %>% pander()
```

```{R}
#| results: "asis"
# control for FC additioally
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    IMD +
    cat +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_CD_soft
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# new levels - controlling for FC
cox_model <- coxph(
  Surv(time, Cens) ~
    AlcoholIntake +
    Sex +
    IMD +
    cat +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_CD_soft
)
cox.summary(cox_model)
```

```{r}
#| label: survival-alcohol-cd-hard
#| echo: false

# Hard flares
fit <- survfit(Surv(time, Cens) ~ weekly_units, data = ETOH_CD_hard)

test_result <- survdiff(Surv(time, Cens) ~ weekly_units, data = ETOH_CD_hard)
pander(test_result)
```

```{R}
#| fig-cap: "Crohn's - Time to hard flare - Alcohol"
p1 <- ggsurvplot(fit,
  data = ETOH_CD_hard,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Alcohol units/week",
  palette = c("#6B9AC4", "#FF86C8", "#FFDC5E"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
#| results: "asis"
# univariate
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
  data = ETOH_CD_hard
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# univariate - new levels
cox_model <- coxph(Surv(time, Cens) ~ AlcoholIntake + frailty(SiteNo),
  data = ETOH_CD_hard
)
cox.summary(cox_model)
```

```{R}
# controlling for Sex, frailty, age, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    AgeGroup +
    IMD +
    frailty(SiteNo),
  data = ETOH_CD_hard
)
summary(cox_model) %>% pander()
```

```{R}
#| results: "asis"
# control for FC additioally
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_CD_hard
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# controlling for FC - new levels
cox_model <- coxph(
  Surv(time, Cens) ~
    AlcoholIntake +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_CD_hard
)
cox.summary(cox_model)
```

## Survival analysis UC/IBDU patients

Patient-reported flares (n= 495, number of events= 211):

-   No significant association when controlling for frailty(site) only
-   Not significant when controlling for frailty(site), sex, smoking, IMD and age
-   Not significant when controlling for FC additionally

Hard flares (n= 490, number of events= 77):

-   No significant association when controlling for frailty(site) only
-   Not significant when controlling for frailty(site), sex, smoking, IMD and age
-   Not significant when controlling for FC additionally

```{r}
#| label: survival-alcohol-uc-soft
#| echo: false

# soft flares
fit <- survfit(Surv(time, Cens) ~ weekly_units, data = ETOH_UC_soft)

test_result <- survdiff(Surv(time, Cens) ~ weekly_units, data = ETOH_UC_soft)
pander(test_result)
```

```{R}
#| fig-cap: "UC/IBDU - Time to patient-reported flare - Alcohol"
p1 <- ggsurvplot(fit,
  data = ETOH_UC_soft,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Alcohol units/week",
  palette = c("#6B9AC4", "#FF86C8", "#FFDC5E"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
#| results: "asis"
# univariate
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
  data = ETOH_UC_soft
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# univariate - new levels
cox_model <- coxph(
  Surv(time, Cens) ~
    AlcoholIntake +
    frailty(SiteNo),
  data = ETOH_UC_soft
)
cox.summary(cox_model)
```

```{R}
# controlling for Sex, frailty, age, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_UC_soft
)
summary(cox_model) %>% pander()
```

```{R}
# control for FC additioally
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_UC_soft
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# control for FC additioally - new levels
cox_model <- coxph(
  Surv(time, Cens) ~
    AlcoholIntake +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_UC_soft
)
cox.summary(cox_model)
```

```{r}
#| label: survival-alcohol-uc-hard
#| echo: false
# Hard flares
fit <- survfit(Surv(time, Cens) ~ weekly_units, data = ETOH_UC_hard)
test_result <- survdiff(Surv(time, Cens) ~ weekly_units, data = ETOH_UC_hard)
pander(test_result)
```

```{R}
#| fig-cap: "UC/IBDU - Time to hard flare - Alcohol"
p1 <- ggsurvplot(fit,
  data = ETOH_UC_hard,
  conf.int = TRUE,
  ggtheme = theme_minimal(),
  legend.title = "Alcohol units/week",
  palette = c("#6B9AC4", "#FF86C8", "#FFDC5E"),
  xlab = "Time from study recrutiment (days)"
)
p1
```

```{R}
#| results: "asis"
# univariate
cox_model <- coxph(Surv(time, Cens) ~ weekly_units + frailty(SiteNo),
  data = ETOH_UC_hard
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# univariate - new levels
cox_model <- coxph(Surv(time, Cens) ~ AlcoholIntake + frailty(SiteNo),
  data = ETOH_UC_hard
)
cox.summary(cox_model)
```

```{R}
# controlling for Sex, frailty, age, IMD
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_UC_hard
)
summary(cox_model) %>% pander()
```

```{R}
#| results: "asis"
# control for FC additinoally
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_UC_hard
)
cox.summary(cox_model)
```

```{R}
#| results: "asis"
# control for FC additinoally - new levels
cox_model <- coxph(
  Surv(time, Cens) ~
    weekly_units +
    Sex +
    cat +
    IMD +
    AgeGroup +
    frailty(SiteNo),
  data = ETOH_UC_hard
)
cox.summary(cox_model)
```

## Reproduction and reproducibility {.appendix}

<details class="appendix">

<summary>Session info</summary>

```{r}
#| label: session-info
#| echo: false
pander::pander(sessionInfo())
```

</details>

Licensed by <a href="https://creativecommons.org/licenses/by/4.0/">CC BY</a> unless otherwise stated.
